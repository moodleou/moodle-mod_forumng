{"version":3,"file":"main.min.js","sources":["../src/main.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\nimport {get_strings as getStrings} from 'core/str';\r\nimport Notification from 'core/notification';\r\nimport * as filterEvents from 'core_filters/events';\r\nimport {Expander} from 'mod_forumng/expander';\r\nimport {StarDiscussion} from 'mod_forumng/stardiscussion';\r\nimport {SelectDiscussion} from 'mod_forumng/selectdiscussion';\r\nimport * as Common from 'mod_forumng/common';\r\nimport Pending from 'core/pending';\r\nimport Config from 'core/config';\r\nimport * as Rating from 'local_themeextras/rating';\r\n\r\n/**\r\n * JavaScript to handle forumng.\r\n *\r\n * @module mod_forumng/main\r\n * @copyright 2024 The Open University\r\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\nclass Main {\r\n    /** @var {string} cloneParam Clone id in param */\r\n    cloneParam = '';\r\n\r\n    /** @var {Number} cloneID Clone ID or 0 if none */\r\n    cloneID = 0;\r\n\r\n    /** @var {Number} cmID Course-module id of this forum */\r\n    cmID = 0;\r\n\r\n    /** @var {Number} ratingStars The number of stars (1-5) used for ratings */\r\n    ratingStars = 0;\r\n\r\n    /** @var {Number} discussionID Discussion if of this forum */\r\n    discussionID = 0;\r\n\r\n    /** @var {Array} expireLinks List of expire links */\r\n    expireLinks = [];\r\n\r\n    /** @var {Object} select Object containing selected node */\r\n    select = {};\r\n\r\n    /** @var {Number} quotaLeft If set, the number of posts left in post quota */\r\n    quotaLeft = 0;\r\n\r\n    /** @var {string} loaderPix URL of AJAX loader icon */\r\n    loaderPix = '';\r\n\r\n    /** @var {boolean} mouseUser Mouse event status */\r\n    mouseUser = false;\r\n\r\n    /** @var {Number} viewportWidth Viewport width */\r\n    viewportWidth = -1;\r\n\r\n    /** @var {Object} starPix Object containing multiple URLs of the various star icons */\r\n    starPix = {};\r\n\r\n    /** @var {boolean} nowEditing Editing status */\r\n    nowEditing = false;\r\n\r\n    /** @var {*} postQuota The number (seconds) or text description of the max-posts period of the current forum */\r\n    postQuota = false;\r\n\r\n    /** @var {Object} mainStrings Object containing main strings */\r\n    mainStrings = {\r\n        'rate': null,\r\n        'expand': '#',\r\n        'collapse': '#',\r\n        'jserr_load': null,\r\n        'jserr_save': null,\r\n        'jserr_alter': null,\r\n        'jserr_attachments': null,\r\n        'confirmdelete': null,\r\n        'confirmundelete': null,\r\n        'confirmdeletediscuss': null,\r\n        'deleteemailpostbutton': null,\r\n        'deletepostbutton': null,\r\n        'undeletepostbutton': null,\r\n        'js_nratings': null,\r\n        'js_nratings1': null,\r\n        'js_nopublicrating': null,\r\n        'js_publicrating': null,\r\n        'js_nouserrating': null,\r\n        'js_userrating': null,\r\n        'js_outof': null,\r\n        'js_clicktosetrating': null,\r\n        'js_clicktosetrating1': null,\r\n        'js_clicktoclearrating': null,\r\n        'selectlabel': null,\r\n        'selectintro': null,\r\n        'confirmselection': null,\r\n        'selectedposts': null,\r\n        'discussion': null,\r\n        'selectorall': null,\r\n        'selectoralldisc': null,\r\n        'selectorselecteddisc': null,\r\n        'selectordiscall': null,\r\n        'selectdiscintro': null,\r\n        'staron': null,\r\n        'staroff': null,\r\n        'clearstar': null,\r\n        'setstar': null,\r\n        'starpost': null,\r\n    };\r\n\r\n    /** @var {object} stringList List of strings */\r\n    stringList = {};\r\n\r\n\r\n    /**\r\n     * Class constructor\r\n     *\r\n     * @param {object} options Options for ajax request\r\n     */\r\n    constructor(options) {\r\n        this.cmID = options.cmid;\r\n        this.cloneID = options.cloneid;\r\n        this.cloneParam = options.cloneid ? '&clone=' + options.cloneid : '';\r\n        this.ratingStars = options.ratingstars;\r\n        this.quotaLeft = options.quotaleft;\r\n        this.loaderPix = options.loaderpix;\r\n        this.starPix = options.starpix;\r\n        this.postQuota = options.postquota;\r\n    }\r\n\r\n    /**\r\n     * Main init function called from HTML.\r\n     *\r\n     */\r\n    async initializer() {\r\n        await this.prepareStrings();\r\n        this.domInit();\r\n        this.urgentInit();\r\n    }\r\n\r\n    /**\r\n     * Prepare list of strings with key, component and value.\r\n     *\r\n     */\r\n    async prepareStrings() {\r\n        let requests = [];\r\n        if (this.postQuota !== null) {\r\n            this.mainStrings['quotaleft_plural'] = {\r\n                posts: '#',\r\n                period: this.postQuota,\r\n            };\r\n            this.mainStrings['quotaleft_singular'] = {\r\n                posts: '#',\r\n                period: this.postQuota,\r\n            };\r\n        }\r\n\r\n        Object.entries(this.mainStrings).forEach(([string, value]) => {\r\n            requests.push({\r\n                'key': string,\r\n                'component': 'forumng',\r\n                'param': value,\r\n            });\r\n        });\r\n\r\n        ['cancel', 'delete', 'add', 'selectall', 'deselectall'].forEach(string => {\r\n            this.mainStrings[string] = '#';\r\n            requests.push({\r\n                'key': string,\r\n                'component': 'moodle',\r\n            });\r\n        });\r\n\r\n        this.stringList = Object.fromEntries(await getStrings(requests)\r\n            .then(fetchedStrings => new Map(\r\n                Object.entries(this.mainStrings).map(([key], index) => ([key, fetchedStrings[index]]))\r\n            )).catch(Notification.exception));\r\n    }\r\n\r\n    /**\r\n     * Main initialisation done on DOM ready.\r\n     *\r\n     */\r\n    domInit() {\r\n        // Magicalise the hidden 'switch view mode' link.\r\n        if (document.getElementById('forumng-switchlinkid')) {\r\n            let link = document.getElementById('forumng-switchlinkid');\r\n            this.initSwitchLink(link);\r\n        }\r\n\r\n        // Handle pages other than the discussion page.\r\n        if (document.getElementById('page-mod-forumng-subscribers')) {\r\n            this.initSubscribers();\r\n            return;\r\n        }\r\n        if (document.getElementById('page-mod-forumng-view')) {\r\n            this.initView();\r\n            return;\r\n        }\r\n        if (document.getElementById('page-mod-forumng-discuss')) {\r\n            this.initDiscuss();\r\n            return;\r\n        }\r\n        if (document.getElementById('page-mod-forumng-feature-deletedposts-deletedpostslist')) {\r\n            this.initContent(document);\r\n        }\r\n        if (document.getElementById('page-mod-forumng-feature-userposts-user')) {\r\n            this.initContent(document);\r\n        }\r\n        if (document.getElementById('page-mod-forumng-feature-print-print')) {\r\n            this.initContent(document);\r\n            this.printPage();\r\n            return;\r\n        }\r\n        if (document.getElementById('page-mod-forumng-deletepost')) {\r\n            this.initDeletepost();\r\n            return;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Urgent init; this is not done as urgently as it used to be :( because it's only\r\n     * in footer. I probably need to figure out a better way to do it. TODO\r\n     */\r\n    urgentInit() {\r\n        // Create new stylesheet in head.\r\n        let newStyle = document.createElement('style');\r\n        newStyle.setAttribute(\"type\", \"text/css\");\r\n\r\n        let selector = '.forumng-ratings';\r\n        let rules = 'display:none';\r\n\r\n        if (document.styleSheets && document.styleSheets.length > 0) {\r\n            // Check for addRule support (for older IE).\r\n            if (document.styleSheets[0].addRule) {\r\n                let head = document.getElementsByTagName('head')[0];\r\n                head.appendChild(newStyle);\r\n                document.styleSheets[document.styleSheets.length - 1].addRule(selector, rules);\r\n            } else {\r\n                // Other browsers, use text content.\r\n                let styleText = selector + \" { \" + rules + \" }\";\r\n                newStyle.appendChild(document.createTextNode(styleText));\r\n                document.getElementsByTagName('head')[0].appendChild(newStyle);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sets up the 'accessible mode switch' link so that it becomes visible (not accesshide)\r\n     * if you tab to it, including its parent.\r\n     *\r\n     * @param {HTMLElement} link - Link tag.\r\n     */\r\n    initSwitchLink(link) {\r\n        link.addEventListener('focus', () => {\r\n            link.parentNode.style.position = 'static';\r\n        });\r\n        link.addEventListener('blur', () => {\r\n            link.parentNode.style.position = 'absolute';\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Initialises all JavaScript for the discussion page.\r\n     */\r\n    initDiscuss() {\r\n        // Get discussion id.\r\n        this.discussionID = window.location.search.replace(/^.*[?&]d=([0-9]+).*$/, '$1');\r\n\r\n        // Get param post id.\r\n        let postid = this.getValueParameter('p');\r\n        if (postid) {\r\n            let link = document.getElementById(postid);\r\n            if (link) {\r\n                // For bookmarking.\r\n                window.location.hash = link.id;\r\n                link.scrollIntoView({\r\n                    behavior: 'smooth',\r\n                    block: 'start'\r\n                });\r\n            }\r\n        }\r\n\r\n        // Tell CSS that we have JS working.\r\n        let forumngMain = document.getElementById('forumng-main');\r\n        if (forumngMain) {\r\n            forumngMain.classList.remove('forumng-nojs');\r\n        }\r\n\r\n        // To avoid having nested forms (breaks IE), remove the non-JS action form.\r\n        let div = document.querySelector('#forumng-actionform > div');\r\n        if (div) {\r\n            let form = div.parentNode;\r\n            div.remove();\r\n            form.parentNode.insertBefore(div, form);\r\n            form.remove();\r\n        }\r\n\r\n        let div1 = document.querySelector('.forumng_deldiscussion');\r\n        if (div1) {\r\n            this.initDeldiscussion(div1);\r\n        }\r\n\r\n        this.initContent(document.querySelector('#forumng-main'));\r\n\r\n        // Hide 'save ratings' button if present.\r\n        let saveall = document.getElementById('forumng-saveallratings');\r\n        if (saveall) {\r\n            saveall.parentNode.removeChild(saveall);\r\n        }\r\n\r\n        // Init feature buttons.\r\n        this.initFeatureButtons(false);\r\n\r\n        // Apply stop indents.\r\n        this.applyStopIndents();\r\n        let region = Common.getElementScreenPosition(document.querySelector('#forumng-main'));\r\n        this.viewportWidth = region.right - region.left;\r\n        setInterval(() => {\r\n            let region = Common.getElementScreenPosition(document.querySelector('#forumng-main'));\r\n            let width = region.right - region.left;\r\n            if (width !== this.viewportWidth) {\r\n                this.viewportWidth = width;\r\n                this.applyStopIndents();\r\n            }\r\n        }, 250);\r\n    }\r\n\r\n    /**\r\n     * Initialises all JavaScript for the deletepost page.\r\n     */\r\n    initDeletepost() {\r\n        // if JS is enabled then we can copy the html version of the text to\r\n        // the textarea used by tinymce, otherwise plain text is used by default.\r\n        let msg = document.getElementById('delete-form-html');\r\n        if (msg) {\r\n            let messagehtml = msg.textContent;\r\n            document.getElementById('id_forumng_delete_msg').innerHTML = messagehtml;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Initialises all JavaScript for the delete discussion page.\r\n     *\r\n     * @param {HTMLElement} div - Discussion element.\r\n     */\r\n    initDeldiscussion(div) {\r\n        const form = div.parentNode.parentNode;\r\n        form.addEventListener('submit', (e) => {\r\n            e.preventDefault();\r\n            // Build confirmation message with buttons.\r\n            const deleteButtons = [this.stringList.deleteemailpostbutton, this.stringList.deletepostbutton];\r\n            const actionUrl = form.action + '?d=' + this.discussionID;\r\n            const cloneParam = this.cloneID ? '&clone=' + this.cloneID : '';\r\n            this.confirm(this.stringList.confirmdeletediscuss,\r\n                deleteButtons,\r\n                this.stringList.cancel,\r\n                null, [\r\n                    function() {\r\n                        location.href = actionUrl + '&delete=1&email=1' + cloneParam;\r\n                    },\r\n                    function() {\r\n                        location.href = actionUrl + '&delete=1&email=0&notdeleted=1' + cloneParam;\r\n                    },\r\n                ]\r\n            );\r\n        });\r\n    }\r\n\r\n\r\n    /**\r\n     * Initialises 'content' i.e. posts and related. Can be called on the whole page or on\r\n     * a single post.\r\n     *\r\n     * @param {HTMLElement} node to run on (e.g. document node or a post div)\r\n     */\r\n    initContent(node) {\r\n        // When the selector is in use, and this is being run on a single post, then\r\n        // do special init for the post.\r\n        if (this.select.on && node.classList.contains('forumng-post')) {\r\n            this.selectInitPost(node, true);\r\n        }\r\n\r\n        // Get post ID from location hash (initial run only).\r\n        const expandposts = {};\r\n        if (node == document || node.id == 'forumng-main') {\r\n            // Post from location bar.\r\n            if (window.location.hash) {\r\n                let match = window.location.hash.match(/p([0-9]+)$/);\r\n                if (match) {\r\n                    expandposts[parseInt(match[1])] = true;\r\n                }\r\n            }\r\n            // Posts listed as expanded (from Back button).\r\n            let expandedList = document.getElementById('expanded_posts');\r\n            let posts = expandedList ? expandedList.value.split(',') : [];\r\n            for (let i = 0; i < posts.length; i++) {\r\n                expandposts[posts[i]] = true;\r\n            }\r\n        }\r\n\r\n        // Kill reply links if necessary.\r\n        if (this.quotaLeft == 0) {\r\n            this.killReplyLinks();\r\n        }\r\n\r\n        // Process all links within the node.\r\n        node.querySelectorAll('a').forEach((link) => {\r\n            let href = link.href;\r\n\r\n            // Ignore mobile links.\r\n            if (link.classList.contains('forumng-mobilepost-link')) {\r\n                return;\r\n            }\r\n\r\n            // Any link with &expires= will be hidden a bit before that time.\r\n            let match = href.match(/[?&]expires=([0-9]+)(&|$)/);\r\n            if (match) {\r\n                this.initExpiry(link, parseInt(match[1]));\r\n                href = link.getAttribute('href');\r\n            }\r\n\r\n            // Magicalise 'Expand' links.\r\n            match = href.match(/\\/discuss\\.php\\?d=([0-9]+).*&expand=1#p([0-9]+)$/);\r\n            if (match && link.classList.contains('forumng-expandlink')) {\r\n                this.initExpand(link, match[2], expandposts[parseInt(match[2])]);\r\n            }\r\n\r\n            // 'Collapse' links.\r\n            match = href.match(/\\/discuss\\.php\\?d=([0-9]+).*&collapse=1#p([0-9]+)$/);\r\n            if (match && link.classList.contains('forumng-collapselink')) {\r\n                this.initCollapse(link, match[2]);\r\n            }\r\n\r\n            // Magicalise 'Reply' links.\r\n            match = href.match(/\\/editpost\\.php\\?replyto=([0-9]+).*$/);\r\n            if (match) {\r\n                this.initReply(link, parseInt(match[1]));\r\n            }\r\n\r\n            // Magicalise 'Edit' links.\r\n            match = href.match(/\\/editpost\\.php\\?p=([0-9]+).*$/);\r\n            if (match) {\r\n                this.initEdit(link, parseInt(match[1]));\r\n            }\r\n\r\n            // Magicalise 'Delete' / 'Undelete' links.\r\n            match = href.match(\r\n                /\\/deletepost\\.php\\?p=([0-9]+)(?:&clone=[0-9]+)?(?:&delete=([0-9]+))?(?:&currentuser=([0-9]))?(?:&expand=1)?$/\r\n            );\r\n            if (match) {\r\n                this.initDelete(link, parseInt(match[1]), match[2] && match[2] == 0, match[3]);\r\n            }\r\n\r\n            // Magicalise the hidden parent-post links.\r\n            if (link.classList.contains('forumng-parentlink')) {\r\n                this.initParentLink(link);\r\n            }\r\n\r\n            // Magicalise the jump-to links.\r\n            if (link.parentNode.classList.contains('forumng-jumpto')) {\r\n                this.initJumpLink(link);\r\n            }\r\n\r\n            // Magicalise the mark post read link.\r\n            if (link.parentNode.classList.contains('forumng-markread')) {\r\n                this.initPostread(link);\r\n            }\r\n\r\n        });\r\n        // Magicalise rating sections.\r\n        let ratings = node.querySelectorAll('div.forumng-ratings');\r\n        if (ratings.length > 0) {\r\n            let ratingoptions = {\r\n                'cloneParam': this.cloneParam,\r\n                'ratingStars': this.ratingStars,\r\n                'loaderPix': this.loaderPix,\r\n                'starPix': this.starPix,\r\n                'stringList': this.stringList,\r\n            };\r\n            let ratingins = new StarDiscussion(ratingoptions);\r\n            ratings.forEach((rating) => {\r\n                let div = ratingins.initRating(rating);\r\n                if (typeof div === 'object' && div !== null) {\r\n                    this.createRateButton(div);\r\n                }\r\n            });\r\n\r\n        }\r\n\r\n        // Find any inputs with the zero-disable feature.\r\n        let zeroDisableInputs = node.querySelectorAll('input.forumng-zero-disable');\r\n        zeroDisableInputs.forEach((input) => {\r\n            this.zeroDisable(input);\r\n        });\r\n\r\n        // Set up flags.\r\n        this.initFlags(node);\r\n\r\n        // Notify the filters about the modified nodes.\r\n        filterEvents.notifyFilterContentUpdated(node);\r\n    }\r\n\r\n    /**\r\n     * Creates a rate new button element, inserts it into the DOM, and attaches event listeners.\r\n     *\r\n     * @param {Object} div - The container element information.\r\n     */\r\n    createRateButton(div) {\r\n        const newButton = document.createElement('input');\r\n        newButton.setAttribute('type', 'button');\r\n        newButton.setAttribute('value', this.stringList.rate);\r\n        div.selector.parentNode.insertBefore(newButton, div.selector.nextSibling);\r\n\r\n        newButton.addEventListener('click', () => {\r\n            newButton.disabled = true;\r\n\r\n            const url = `${Config.wwwroot}/mod/forumng/rate.php`;\r\n            const data = `p=${div.postId}${this.cloneParam}&rating=${div.selector.value}&ajax=1`;\r\n            const cfg = {\r\n                method: 'POST',\r\n                headers: {\r\n                    'Content-Type': 'application/json',\r\n                }\r\n            };\r\n\r\n            fetch(url + '?' + data, cfg)\r\n                .then(response => response.text())\r\n                .then(text => {\r\n                    this.deleteOk(div, {responseText: text});\r\n                })\r\n                .catch(() => {\r\n                    this.deleteError(div);\r\n                });\r\n\r\n            Common.linksDisable(div.post);\r\n\r\n            div.loader = document.createElement('img');\r\n            div.loader.setAttribute('alt', '');\r\n            div.loader.style.position = 'absolute';\r\n            div.loader.setAttribute('src', this.loaderPix);\r\n            div.parentNode.appendChild(div.loader);\r\n            const byregion = Common.getElementScreenPosition(newButton);\r\n            div.loader.style.left = `${byregion.right + 3}px`;\r\n            div.loader.style.top = `${byregion.top + 2}px`;\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Applies expiry to links. Some links are marked with &expires=(time) to indicate that the\r\n     * JavaScript should disable them around that time. (Edit, delete links.)\r\n     *\r\n     * @param {HTMLElement} link - Link node\r\n     * @param {number} seconds - Number of seconds to expire after\r\n     */\r\n    initExpiry(link, seconds) {\r\n        // Actually expires a bit early\r\n        link.forumngExpiryJavatime = seconds * 1000 - 45000 + Date.now();\r\n        link.href = link.href.replace(/[?&]expires=[0-9]+/, '');\r\n\r\n        this.expireLinks.push(link);\r\n\r\n        if (this.expireLinks.length == 1) {\r\n            const timerid = setInterval(() => {\r\n                const current = Date.now();\r\n                for (let i = this.expireLinks.length - 1; i >= 0; i--) {\r\n                    if (current > this.expireLinks[i].forumngExpiryJavatime) {\r\n                        const deadlink = this.expireLinks[i];\r\n                        if (deadlink.parentNode) {\r\n                            deadlink.parentNode.remove();\r\n                        }\r\n                        this.expireLinks.splice(i, 1);\r\n                    }\r\n                }\r\n                if (this.expireLinks.length == 0) {\r\n                    clearInterval(timerid);\r\n                }\r\n            }, 15000);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Removes reply links within a given tag. This is used if you run out of quota so that\r\n     * you cannot create new replies.\r\n     *\r\n     */\r\n    killReplyLinks() {\r\n        const links = document.querySelectorAll('#forumng-main a[href]');\r\n        links.forEach(link => {\r\n            if (link.href.match(/editpost\\.php\\?replyto=[0-9]+.*$/)) {\r\n                link.remove();\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Removes iframe and marks it closed.\r\n     *\r\n     * @param {HTMLIFrameElement} iframe - The iframe element to remove\r\n     * @param {boolean} scrollToParent - If true (default), scrolls to parent after removing iframe\r\n     */\r\n    removeIframe(iframe, scrollToParent = true) {\r\n        const parent = iframe.parentNode;\r\n        parent.removeChild(iframe);\r\n        parent.removeAttribute('style');\r\n        if (this.isMobile()) {\r\n            // Hide iframe container also.\r\n            parent.style.display = 'none';\r\n            // Remove scroll event trapping.\r\n            window.addEventListener('scroll', (event) => {\r\n                event.preventDefault();\r\n            });\r\n        }\r\n\r\n        this.nowEditing = false;\r\n\r\n        if (scrollToParent) {\r\n            Common.scrollPage(parent.parentNode);\r\n        }\r\n\r\n        Common.linksEnable(document.body);\r\n    }\r\n\r\n    /**\r\n     * Get the device's OS.\r\n     *\r\n     * @return {string} Device's OS.\r\n     */\r\n    detectOS() {\r\n        const ua = navigator.userAgent;\r\n\r\n        if (/android/i.test(ua)) {\r\n            return Common.androidOS;\r\n        } else if (/iPad|iPhone|iPod/.test(ua)) {\r\n            return Common.iOS;\r\n        }\r\n        return Common.otherOS;\r\n    }\r\n\r\n    /**\r\n     * Check is mobile.\r\n     * @return {boolean} Is mobile\r\n     */\r\n    isMobile() {\r\n        return this.detectOS() === Common.iOS || this.detectOS() === Common.androidOS;\r\n    }\r\n\r\n    /**\r\n     * Initialises an iframe and adds it.\r\n     *\r\n     * @param {string} src - iframe URL (&iframe=1 automatically added)\r\n     * @param {HTMLElement} post - Post node to add iframe\r\n     * @returns {HTMLIFrameElement|null} - Iframe element or null if already editing (abort)\r\n     */\r\n    initIframe(src, post) {\r\n        // Check if post is unread.\r\n        const classnamePost = post.className.split(\" \");\r\n        let isUnread = classnamePost.includes('forumng-unread');\r\n\r\n        // Check we're not already editing.\r\n        if (this.nowEditing) {\r\n            return null;\r\n        }\r\n        this.nowEditing = true;\r\n\r\n        let pendingPromise = new Pending('forumng_iframe');\r\n\r\n        // Add special style that marks links disabled.\r\n        Common.linksDisable(document.body);\r\n\r\n        // Create iframe container and iframe elements.\r\n        const iframecon = document.createElement('div');\r\n        iframecon.classList.add('iframecon');\r\n        const iframe = document.createElement('iframe');\r\n        iframe.className = 'forumng-inlineform';\r\n        iframe.name = 'forumng-post-iframe';\r\n        iframe.height = 500;\r\n        src += '&iframe=1';\r\n        iframe.src = src;\r\n\r\n        // Function to handle iframe load.\r\n        window.iframe_has_loaded = (innerwin) => {\r\n            // Add unread class if necessary.\r\n            if (isUnread) {\r\n                innerwin.document.body.className += ' iframe-post-unread';\r\n            }\r\n            pendingPromise.resolve();\r\n            let pendingPromisefil = new Pending('forumng_iframe_load');\r\n\r\n            const doc = innerwin.document;\r\n            let counter = 0;\r\n\r\n            // Roll up edit author fieldset in edit post (do here so height correct).\r\n            const editemailHead = doc.getElementById('id_id_emailauthor');\r\n            if (editemailHead) {\r\n                editemailHead.className += ' collapsed';\r\n            }\r\n\r\n            // Check size and enlarge iframe if required.\r\n            const fixHeight = () => {\r\n                let pendingPromisefir = new Pending('forumng_iframe_resize');\r\n                if (doc.body.scrollHeight > Number(iframe.height)) {\r\n                    iframe.height = doc.body.scrollHeight + 2;\r\n                    iframecon.style.height = `${doc.body.scrollHeight + 2}px`;\r\n                    iframecon.style.overflow = 'unset';\r\n                }\r\n\r\n                // Check if the mobile view is activated, if so, then we align the\r\n                // iframe to the top left position and make it dominate the whole page,\r\n                // which basically make it behave like a pop-up overlay dialog.\r\n                //\r\n                // Create + set this.isMobile in the mobile theme to activate.\r\n                if (this.isMobile()) {\r\n                    iframecon.style.display = 'block';\r\n                    iframecon.style.width = '100%';\r\n                    iframecon.style.height = '100%';\r\n\r\n                    if (this.detectOS() === Common.iOS) {\r\n                        // Make fixed div work in iOS.\r\n                        iframecon.style.position = 'fixed';\r\n                        iframecon.style.top = '0px';\r\n                        iframecon.style.left = '0px';\r\n                        iframecon.style.zIndex = '9999';\r\n                        iframecon.style.overflow = 'scroll';\r\n                        iframecon.style.webkitOverflowScrolling = 'touch';\r\n                        iframe.style.position = 'relative';\r\n                        iframe.style.top = 'initial';\r\n                        iframe.style.left = 'initial';\r\n                    } else {\r\n                        iframe.style.position = 'fixed';\r\n                        iframe.style.top = '0px';\r\n                        iframe.style.left = '0px';\r\n                        iframe.style.zIndex = '9999';\r\n                    }\r\n                    iframe.style.height = '100%';\r\n                    iframe.style.width = '100%';\r\n                    iframe.style.overflowX = 'hidden';\r\n                    iframe.style.overflowY = 'auto';\r\n\r\n                    if (iframe.clientHeight >= innerwin.document.querySelector('#page').clientHeight) {\r\n                        // If iframe size larger than content then hide scroll.\r\n                        iframe.scrolling = 'no';\r\n                    } else {\r\n                        iframe.scrolling = 'auto';\r\n                    }\r\n\r\n                    doc.body.focus();\r\n                    window.scrollTo(0, 0);\r\n                } else {\r\n                    // Handle specific cases for theme OU.\r\n                    if (Config.theme.includes('ou')) {\r\n                        const parentNode = iframe.parentNode.parentNode;\r\n                        if (parentNode) {\r\n                            iframe.width = parentNode.getComputedStyle('width');\r\n                        }\r\n\r\n                        if (this.isMobile()) {\r\n                            const margin = parseInt(parentNode.getComputedStyle('width')) - doc.body.scrollWidth;\r\n                            if (margin < 0) {\r\n                                iframecon.style.marginLeft = `${margin}px`;\r\n                                iframe.style.width = `${doc.body.scrollWidth}px`;\r\n                                iframecon.style.width = `${doc.body.scrollWidth}px`;\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n\r\n                counter++;\r\n                if (counter < 20) {\r\n                    // Keep resizing iframe as filemanager takes a while to initialise.\r\n                    setTimeout(fixHeight, 500);\r\n                }\r\n                pendingPromisefir.resolve();\r\n            };\r\n            fixHeight();\r\n\r\n            // Add cancel handler that just removes the iframe - Except Atto as autosave cancel needed.\r\n            doc.getElementById('id_cancel').addEventListener('click', (e) => {\r\n                // Check if empty text, if so close iframe (Hack to stop 'required' issue).\r\n                let blank = false;\r\n                if (innerwin.document.getElementById('id_message') &&\r\n                    (innerwin.document.getElementById('id_message').innerText === ''\r\n                        || innerwin.document.getElementById('id_message').textContent === '')) {\r\n                    blank = true;\r\n                }\r\n                if (!innerwin.document.querySelector('.editor_atto') || blank) {\r\n                    if (!e) {\r\n                        e = window.event;\r\n                    }\r\n                    if (e) {\r\n                        if (e.stopPropagation) {\r\n                            e.stopPropagation();\r\n                        } else {\r\n                            e.cancelBubble = true;\r\n                        }\r\n                    }\r\n                    this.removeIframe(iframe);\r\n                    return false;\r\n                }\r\n            });\r\n\r\n            const draftbut = doc.getElementById('id_savedraft');\r\n            if (draftbut) {\r\n                draftbut.addEventListener('click', () => {\r\n                    const x = setInterval(() => {\r\n                        const draftexists = innerwin.document.querySelector('.forumng-draftexists');\r\n                        if (draftexists) {\r\n                            Common.scrollPage(document.querySelector('.forumng-inlineform'));\r\n                            clearInterval(x);\r\n                        }\r\n                    }, 500);\r\n                });\r\n            }\r\n\r\n            // Focus the editor.\r\n            const try_focus = () => {\r\n                if (innerwin.tinyMCE) {\r\n                    for (let edId in innerwin.tinyMCE.editors) {\r\n                        if (edId === 'id_message') {\r\n                            innerwin.tinyMCE.execCommand('mceFocus', false, 'id_message');\r\n                            return;\r\n                        }\r\n                    }\r\n                }\r\n                setTimeout(try_focus, 100);\r\n            };\r\n            if (!this.isMobile()) {\r\n                setTimeout(try_focus, 250);\r\n            }\r\n            pendingPromisefil.resolve();\r\n        };\r\n\r\n        // Put iframe in as last thing in post (except the 'end post' marker).\r\n        const ends = post.querySelectorAll('div.forumng-endpost');\r\n        const last = ends[ends.length - 1];\r\n        last.parentNode.insertBefore(iframecon, last.nextSibling);\r\n        iframecon.appendChild(iframe);\r\n\r\n        return iframe;\r\n    }\r\n\r\n    /**\r\n     * Initialises edit links.\r\n     *\r\n     * @param {HTMLElement} link Link node\r\n     * @param {number} postid Post ID to edit\r\n     */\r\n    initEdit(link, postid) {\r\n        link.addEventListener('click', (e) => {\r\n            e.preventDefault();\r\n            if (this.areLinksDisabled(link)) {\r\n                return;\r\n            }\r\n\r\n            // Get post.\r\n            const post = link.closest('.forumng-post');\r\n            const rootpost = !post.closest('.forumng-replies');\r\n\r\n            // Make iframe.\r\n            let src = `editpost.php?p=${postid}`;\r\n            if (this.cloneID) {\r\n                src += `&clone=${this.cloneID}`;\r\n            }\r\n            const iframe = this.initIframe(src, post);\r\n            if (!iframe) {\r\n                return;\r\n            }\r\n\r\n            // Function that gets called when the iframe has completed successfully.\r\n            window.iframe_success = (innerwin) => {\r\n                // Add item just in front of existing post, then delete existing.\r\n                const scriptcommands = [];\r\n                const newpost = this.prepareNewPost(innerwin, scriptcommands);\r\n\r\n                if (newpost.innerHTML !== '') {\r\n                    post.parentNode.insertBefore(newpost, post);\r\n                    post.parentNode.removeChild(post);\r\n\r\n                    setTimeout(() => {\r\n                        // Reload all the images - fixes chrome issue.\r\n                        /* eslint-disable no-self-assign */\r\n                        newpost.querySelectorAll('img').forEach(img => {\r\n                            img.src = img.src;\r\n                        });\r\n                    }, 100);\r\n\r\n                    // Run script commands.\r\n                    /* eslint-disable no-eval */\r\n                    scriptcommands.forEach(cmd => {\r\n                        eval(cmd);\r\n                    });\r\n\r\n                    // For discussion, do special handling.\r\n                    if (rootpost) {\r\n                        // Get subject and remove its node.\r\n                        const subjectinput = newpost.querySelector('input[name=discussion_subject]');\r\n                        const subject = subjectinput.value;\r\n                        subjectinput.remove();\r\n\r\n                        const discussionTitles = document.querySelectorAll('.forumng_discussion_title');\r\n                        discussionTitles.forEach(title => {\r\n                            title.innerHTML = subject;\r\n                        });\r\n\r\n                        const navbar = document.querySelector('#page-header .navbar ul, #page-navbar ul');\r\n                        if (navbar) {\r\n                            // Find subject inside the breadcrumb (last <span> in last <li>).\r\n                            const lastspan = navbar.querySelector('li:last-child > span:last-child');\r\n                            if (lastspan) {\r\n                                while (lastspan.firstChild) {\r\n                                    lastspan.removeChild(lastspan.firstChild);\r\n                                }\r\n                                lastspan.appendChild(document.createTextNode(' ' + subject));\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    // Sort out links.\r\n                    this.initContent(newpost);\r\n                }\r\n\r\n                // Remove the iframe.\r\n                // This needs to be placed here for mobile devices to work.\r\n                this.removeIframe(iframe);\r\n                window.iframe_success = null;\r\n            };\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Extracts a new post from the result of a reply or edit script.\r\n     *\r\n     * @param {Window} innerwin Iframe window\r\n     * @param {Array} scriptcommands Script commands will be added to this array\r\n     * @return {HTMLElement} New post element\r\n     */\r\n    prepareNewPost(innerwin, scriptcommands) {\r\n        const responsetext = innerwin.document.body.firstChild.innerHTML;\r\n        const newdiv = document.createElement('div');\r\n        let extractedHTML = this.extractJs(responsetext, scriptcommands);\r\n        newdiv.innerHTML = extractedHTML;\r\n        const newpost = newdiv.firstElementChild;\r\n        newdiv.removeChild(newpost);\r\n        return newpost;\r\n    }\r\n\r\n    /**\r\n     * Initialises reply links.\r\n     *\r\n     * @param {HTMLElement} link Link node\r\n     * @param {number} replytoid Post ID to reply to\r\n     */\r\n    initReply(link, replytoid) {\r\n        link.addEventListener('click', (e) => {\r\n            e.preventDefault();\r\n            if (this.areLinksDisabled(link)) {\r\n                return;\r\n            }\r\n\r\n            // This function is also used when setting up a reply that includes existing draft text.\r\n            const draft = window.forumng_draft ? window.forumng_draft : false;\r\n            window.forumng_draft = null;\r\n\r\n            // Get post.\r\n            const post = link.closest('.forumng-post');\r\n\r\n            // Make iframe.\r\n            let src = 'editpost.php?';\r\n            if (draft) {\r\n                src += 'draft=' + draft.id;\r\n            } else {\r\n                src += 'replyto=' + replytoid;\r\n            }\r\n            if (this.cloneID) {\r\n                src += '&clone=' + this.cloneID;\r\n            }\r\n            const iframe = this.initIframe(src, post);\r\n            if (!iframe) {\r\n                return;\r\n            }\r\n\r\n            // Function that gets called when the iframe has completed successfully.\r\n            window.iframe_success = (innerwin) => {\r\n                // Get replies div.\r\n                let replies;\r\n                if (post.nextElementSibling && post.nextElementSibling.classList.contains('forumng-replies')) {\r\n                    replies = post.nextElementSibling;\r\n                } else {\r\n                    replies = document.createElement('div');\r\n                    replies.className = 'forumng-replies';\r\n                    // Insert the newly created replies div.\r\n                    post.parentNode.insertBefore(replies, post.nextElementSibling);\r\n                    this.applyStopIndents();\r\n                }\r\n\r\n                // Add item there.\r\n                const scriptcommands = [];\r\n                const newpost = this.prepareNewPost(innerwin, scriptcommands);\r\n                replies.appendChild(newpost);\r\n\r\n                // Run script commands.\r\n                /* eslint-disable no-eval */\r\n                scriptcommands.forEach(cmd => eval(cmd));\r\n\r\n                // Set up JavaScript behaviour in new post.\r\n                this.initContent(newpost);\r\n\r\n                // Update quota left.\r\n                if (this.quotaLeft > 0) {\r\n                    this.quotaLeft--;\r\n\r\n                    // If out of quota, kill all the reply links.\r\n                    if (this.quotaLeft == 0) {\r\n                        this.killReplyLinks();\r\n                    }\r\n                }\r\n\r\n                // Remove the iframe.\r\n                // This needs to be placed here for mobile devices to work.\r\n                this.removeIframe(iframe, false);\r\n                window.iframe_success = null;\r\n\r\n                // Scroll to it (must do this after frame removed or height will be incorrect).\r\n                Common.scrollPage(newpost, null);\r\n            };\r\n\r\n            // Mark that we've got a reply there.\r\n            iframe.replytoid = replytoid;\r\n\r\n            const quotaDiv = document.querySelector('#id_postlimit1');\r\n            if (quotaDiv) {\r\n                const quotaItem = quotaDiv.closest('.fitem');\r\n                if (this.quotaLeft > 2 || this.quotaLeft < 0) {\r\n                    quotaItem.style.display = 'none';\r\n                } else {\r\n                    quotaItem.style.display = 'block';\r\n                    let text = (this.quotaLeft == 1)\r\n                        ? this.stringList.quotaleft_singular\r\n                        : this.stringList.quotaleft_plural;\r\n                    text = text.replace('#', this.quotaLeft);\r\n                    quotaDiv.innerHTML = text;\r\n                }\r\n            }\r\n        });\r\n\r\n        // When we create the reply link that a draft post uses, make it click itself.\r\n        if (window.forumng_draft && window.forumng_draft.parentpostid == replytoid) {\r\n            setTimeout(() => {\r\n                Common.simulateClick(link);\r\n            }, 0);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Initialises all flag icons on the page (discussion or main page) or a post.\r\n     * @param {HTMLElement} node Root element\r\n     */\r\n    initFlags(node) {\r\n        node.querySelectorAll('div.forumng-flagpost').forEach(div => {\r\n            this.initFlagDiv(div);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Initialises a single flag icon based on the div.\r\n     *\r\n     * @param {HTMLElement} div forumng-flag div\r\n     */\r\n    initFlagDiv(div) {\r\n        div.anchor = div.querySelector('a');\r\n        div.span = div.querySelector('span');\r\n        // Get on state from image icon.\r\n        div.icon = div.querySelector('img.icon');\r\n        div.on = div.icon.src.match(/star\\.on/) !== null;\r\n\r\n        const handleClick = (e) => {\r\n            if (div.anchor.classList.contains('forumng-disabled')) {\r\n                return false;\r\n            }\r\n            const cfg = {\r\n                method: 'POST',\r\n                headers: {\r\n                    'Content-Type': 'application/json',\r\n                },\r\n            };\r\n            fetch(div.anchor.href + '&ajax=1', cfg)\r\n                .then(() => {\r\n                    div.on = !div.on;\r\n                    div.icon.src = div.icon.src.replace(/star\\.o(n|ff)/, `star.${div.on ? 'on' : 'off'}`);\r\n                    div.anchor.href = div.anchor.href.replace(/\\&flag=(0|1)/, `&flag=${div.on ? 0 : 1}`);\r\n                    div.anchor.title = div.on ? this.stringList.clearstar : this.stringList.setstar;\r\n                    if (div.on) {\r\n                        div.classList.add('starred-post');\r\n                    } else {\r\n                        div.classList.remove('starred-post');\r\n                    }\r\n                    const text = div.span.innerHTML;\r\n                    if (text) {\r\n                        div.span.innerHTML = div.on ? this.stringList.clearstar : this.stringList.starpost;\r\n                    }\r\n                })\r\n                .catch(() => {\r\n                    alert(this.stringList.jserr_alter);\r\n                });\r\n            e.preventDefault();\r\n        };\r\n\r\n        // Remove all other event listeners just in case this function is called multiple times.\r\n        div.icon.removeEventListener('click', handleClick);\r\n        div.anchor.addEventListener('click', handleClick);\r\n    }\r\n\r\n    /**\r\n     * Initializes the post read functionality.\r\n     *\r\n     * @param {HTMLElement} link - The link element that triggers the read action.\r\n     */\r\n    initPostread(link) {\r\n        link.addEventListener('click', (e) => {\r\n            e.preventDefault();\r\n            if (this.areLinksDisabled(link) || link.classList.contains('disabled')) {\r\n                return;\r\n            }\r\n            let pendingPromise = new Pending('forumng_postread');\r\n            const url = link.href + '&ajax=1';\r\n            const cfg = {\r\n                method: 'GET',\r\n                headers: {\r\n                    'Content-Type': 'application/json',\r\n                },\r\n            };\r\n\r\n            fetch(url, cfg)\r\n                .then(async (response) => {\r\n                    // Read response body text and check if word ok is in text.\r\n                    const text = await response.text();\r\n                    if (!text.includes('ok')) {\r\n                        alert(this.stringList.jserr_alter);\r\n                        pendingPromise.resolve();\r\n                        return;\r\n                    }\r\n                    link.classList.add('disabled');\r\n                    link.setAttribute('disabled', 'disabled');\r\n                    const post = link.closest('div.forumng-unread');\r\n                    if (post) {\r\n                        post.classList.replace('forumng-unread', 'forumng-read');\r\n                    }\r\n                    pendingPromise.resolve();\r\n                })\r\n                .catch(() => {\r\n                    alert(this.stringList.jserr_alter);\r\n                    pendingPromise.resolve();\r\n                });\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Initialises the feature buttons that run along the bottom of a discussion. Some\r\n     * of these may use the 'post selector' feature, which requires JavaScript.\r\n     *\r\n     * Looks for some ou-specific links that are treated as the real buttons\r\n     *\r\n     * @param {boolean} islist True if discussion list\r\n     */\r\n    initFeatureButtons(islist) {\r\n        // Get all forms.\r\n        if (islist) {\r\n            // Feature btns on discussion list.\r\n            document.querySelectorAll('form.forumng-dselectorbutton input[type=submit],' +\r\n                ' #osep-bottombutton-export, #osep-bottombutton-print').forEach(node => {\r\n                // For hacked buttons do extra, inc passing original input node target.\r\n                if (node.tagName === 'A') {\r\n                    const discussions = document.querySelectorAll('.forumng-discussionlist tr');\r\n                    if (discussions.length == 0) {\r\n                        node.style.display = 'none';\r\n                    }\r\n                }\r\n                this.initSelectButton(node, true);\r\n            });\r\n        } else {\r\n            document.querySelectorAll('form.forumng-selectorbutton, #osep-bottombutton-export, #osep-bottombutton-print')\r\n                .forEach(node => {\r\n                    let submit;\r\n                    if (node.tagName === 'A') {\r\n                        submit = node;\r\n                    } else {\r\n                        submit = node.querySelector('input[type=submit]');\r\n                    }\r\n                    this.initSelectButton(submit, false);\r\n                });\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Adds JS to the button which runs the selector feature, causing it to call the\r\n     * 'confirm' prompt to ask whether you want to do the discussion or selected posts.\r\n     *\r\n     * @param {HTMLElement} submit Submit button node\r\n     * @param {boolean} isList True if discussion list\r\n     */\r\n    initSelectButton(submit, isList) {\r\n        if (isList) {\r\n            // Check there are discussions to select.\r\n            const discussions = document.querySelectorAll('.forumng-discussionlist tr');\r\n            if (discussions.length == 0) {\r\n                submit.disabled = true;\r\n                return;\r\n            }\r\n            submit.addEventListener('click', (e) => {\r\n                e.preventDefault();\r\n                if (submit.tagName === 'A') {\r\n                    if (submit.id === 'osep-bottombutton-export') {\r\n                        submit = document.querySelector('.forumngfeature_export form.forumng-dselectorbutton input[type=submit]');\r\n                    } else if (submit.id === 'osep-bottombutton-print') {\r\n                        submit = document.querySelector('.forumngfeature_print form.forumng-dselectorbutton input[type=submit]');\r\n                    }\r\n                }\r\n\r\n                // Pick up any discussion types we specifically include or exclude.\r\n                let include = [];\r\n                let exclude = [];\r\n                const form = submit.form;\r\n                const includeEl = form.querySelector('input[name=include]');\r\n                if (includeEl) {\r\n                    include = includeEl.value.split(',');\r\n                }\r\n                const excludeEl = form.querySelector('input[name=exclude]');\r\n                if (excludeEl) {\r\n                    exclude = excludeEl.value.split(',');\r\n                }\r\n\r\n                // Pick up inputs needed from form.\r\n                let inputs = '';\r\n                let inputNodes = form.querySelectorAll('input[type=hidden]');\r\n                if (inputNodes.length == 0) {\r\n                    inputNodes = form.children[0].querySelectorAll('input[type=hidden]');\r\n                }\r\n                inputNodes.forEach(node => {\r\n                    inputs += `&${node.name}=${node.value}`;\r\n                });\r\n\r\n                this.confirm(`<h4>${submit.value}</h4><p>${this.stringList.selectordiscall}</p>`,\r\n                    [this.stringList.selectoralldisc, this.stringList.selectorselecteddisc],\r\n                    this.stringList.cancel,\r\n                    null, [\r\n                        function() {\r\n                            location.href = `${form.action}?all=1${this.cloneParam}${inputs}`;\r\n                        }.bind(this),\r\n                        function() {\r\n                            let discussionoptions = {\r\n                                'cloneID': this.cloneID,\r\n                                'stringList': this.stringList,\r\n                                'select': this.select,\r\n                            };\r\n                            let selectDiscussion = new SelectDiscussion(discussionoptions);\r\n                            if (!document.querySelector('div.forumng-main > form')) {\r\n                                selectDiscussion.selectDiscussInit(submit, include, exclude);\r\n                            }\r\n                        }.bind(this)\r\n                    ]);\r\n            });\r\n            return;\r\n        }\r\n        submit.addEventListener('click', (e) => {\r\n            e.preventDefault();\r\n            if (submit.tagName === 'A') {\r\n                if (submit.id === 'osep-bottombutton-export') {\r\n                    submit = document.querySelector('.forumngfeature_dis_export form.forumng-selectorbutton input[type=submit]');\r\n                } else if (submit.id === 'osep-bottombutton-print') {\r\n                    submit = document.querySelector('.forumngfeature_dis_print form.forumng-selectorbutton input[type=submit]');\r\n                }\r\n            }\r\n\r\n            this.confirm(`<h4>${submit.value}</h4><p>${this.stringList.selectorall}</p>`,\r\n                [this.stringList.discussion, this.stringList.selectedposts],\r\n                this.stringList.cancel,\r\n                null, [\r\n                    function() {\r\n                        location.href = `${submit.form.action}?d=${this.discussionID}${this.cloneParam}&all=1`;\r\n                    }.bind(this),\r\n                    function() {\r\n                        if (document.querySelector('div.forumng-selectbuttons')) {\r\n                            this.selectInit(null);\r\n                        }\r\n                        this.selectInit(submit);\r\n                    }.bind(this),\r\n                ]);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Stops indent from increasing once it gets past a certain minimum-post-width limit (this\r\n     * varies depending on browser size). Without this, discussions with a lot of nesting levels\r\n     * were getting ridiculous indent so that the actual posts were one word wide.\r\n     *\r\n     */\r\n    applyStopIndents() {\r\n        // Pick max indent level.\r\n        const region = Common.getElementScreenPosition(document.getElementById('forumng-main'));\r\n        const width = region.right - region.left;\r\n        const isMobile = window.matchMedia('(max-width: 767px)').matches;\r\n        // Min size at which the editor still looks ok.\r\n        const minWidth = isMobile ? 256 : 550;\r\n        const maxIndentPixels = width - minWidth;\r\n        // This can't go lower than 1, otherwise the indentation never stops.\r\n        let stopIndent = 1;\r\n\r\n        if (isMobile) {\r\n            // All indents are 6px at this width.\r\n            if (maxIndentPixels > 6) {\r\n                stopIndent = Math.floor(maxIndentPixels / 6);\r\n            }\r\n        } else {\r\n            // There are 5 indents of 40px then 5 of 30px, then all 20px.\r\n            if (maxIndentPixels > 350) {\r\n                stopIndent = 10 + Math.floor((maxIndentPixels - 350) / 20);\r\n            } else if (maxIndentPixels > 200) {\r\n                stopIndent = 5 + Math.floor((maxIndentPixels - 200) / 30);\r\n            } else if (maxIndentPixels >= 40) {\r\n                stopIndent = Math.floor(maxIndentPixels / 40);\r\n            }\r\n        }\r\n\r\n        // Fix indents for all tags.\r\n        document.querySelectorAll('div.forumng-replies').forEach(reply => {\r\n            const indent = this.getReplyIndent(reply);\r\n            if (indent == stopIndent) {\r\n                reply.classList.add('forumng-stop-indent');\r\n            } else {\r\n                reply.classList.remove('forumng-stop-indent');\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Obtains indent level of a reply (i.e. how many levels it is indented by).\r\n     * @param {HTMLElement} reply Reply div\r\n     *\r\n     * @returns {number} Indent level\r\n     */\r\n    getReplyIndent(reply) {\r\n        // Use cached indent count if available.\r\n        if (reply.forumng_indent) {\r\n            return reply.forumng_indent;\r\n        }\r\n\r\n        let indent = 1;\r\n        // Go through each parent to find its nesting.\r\n        let ancestor = reply.parentElement;\r\n\r\n        while (ancestor && ancestor !== document.documentElement) {\r\n            if (ancestor.classList.contains('forumng-replies')) {\r\n                indent += 1;\r\n                ancestor = ancestor.parentElement;\r\n            } else {\r\n                ancestor = ancestor.parentElement;\r\n            }\r\n        }\r\n\r\n        reply.forumng_indent = indent;\r\n        return indent;\r\n    }\r\n\r\n    /**\r\n     * Checks if links are disabled including a particular link.\r\n     *\r\n     * @param {HTMLElement} link Element pointing to link\r\n     * @returns {boolean} True if links are disabled, false otherwise\r\n     */\r\n    areLinksDisabled(link) {\r\n        // True if links are disabled either at body or commands level.\r\n        return document.body.linksdisabled ||\r\n            link.closest('.forumng-commands').linksdisabled;\r\n    }\r\n\r\n    /**\r\n     * Deeply clones an object or array and changes the 'itemid' property to a new value.\r\n     *\r\n     * @param {Object|Array} obj Object or array to clone and modify\r\n     * @param {string} itemid New value for 'itemid' property\r\n     * @returns {Object|Array} Cloned object or array with modified 'itemid' properties\r\n     */\r\n    deepCloneChangeItemid(obj, itemid) {\r\n        if (Array.isArray(obj)) {\r\n            var c = [];\r\n        } else {\r\n            var c = {};\r\n        }\r\n\r\n        for (let key in obj) {\r\n            if (Object.prototype.hasOwnProperty.call(obj, key)) {\r\n                if (key == 'itemid') {\r\n                    c[key] = itemid;\r\n                } else if (typeof obj[key] == 'object' && obj[key] !== null) {\r\n                    c[key] = this.deepCloneChangeItemid(obj[key], itemid);\r\n                } else {\r\n                    c[key] = obj[key];\r\n                }\r\n            }\r\n        }\r\n\r\n        return c;\r\n    }\r\n\r\n    /**\r\n     * Calls a function multiple times using setTimeout to avoid stack overflow.\r\n     *\r\n     * @param {Function} fn The function to call\r\n     * @param {number} count The number of times to call the function\r\n     */\r\n    setTimeoutMulti(fn, count) {\r\n        if (count > 0) {\r\n            setTimeout(() => {\r\n                this.setTimeoutMulti(fn, count - 1);\r\n            }, 0);\r\n        } else {\r\n            fn();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Initializes the 'parent' links so that when tabbed to, the parent div/text displays.\r\n     *\r\n     * @param {HTMLElement} link Link node\r\n     */\r\n    initParentLink(link) {\r\n        link.addEventListener('focus', () => {\r\n            link.parentNode.style.position = 'static';\r\n        });\r\n\r\n        link.addEventListener('blur', () => {\r\n            link.parentNode.style.position = 'absolute';\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Initializes an expand link so that it can use AJAX to retrieve the message.\r\n     *\r\n     * @param {HTMLElement} link Link node\r\n     * @param {number} postid Post ID\r\n     * @param {boolean} expandNow If true, expand this post immediately\r\n     */\r\n    initExpand(link, postid, expandNow) {\r\n        link.post = link.closest('.forumng-post');\r\n        link.post.expandLink = link;\r\n        link.loader = link.nextElementSibling;\r\n        while (link.loader && link.loader.nodeName.toLowerCase() !== 'img') {\r\n            link.loader = link.loader.nextElementSibling;\r\n        }\r\n        if (link.loader) {\r\n            link.loader.originalSrc = link.loader.src;\r\n        }\r\n        link.postid = postid;\r\n        link.delay = true;\r\n\r\n        this.processLinkRetrieveMessage(link);\r\n\r\n        // Automatically expand message listed in URL (if any).\r\n        if (expandNow) {\r\n            link.delay = false;\r\n            Common.simulateClick(link);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Processes link hashtag URL to retrieve the message when you expand the post.\r\n     *\r\n     * @param {object} link Link node\r\n     * @param {boolean} expandNow If true, expand this post immediately\r\n     */\r\n    processLinkRetrieveMessage(link, expandNow = true) {\r\n        // Replace 'expand/collapse all' text with 'expand/collapse'.\r\n        const postNum = link.post.className.replace(/^.*forumng-p([0-9]+).*$/, '$1');\r\n\r\n        const text = expandNow ? link.querySelector('.forumng-expandtext') : link.querySelector('.forumng-collapsetext');\r\n        if (text && expandNow) {\r\n            text.innerHTML = this.stringList.expand.replace('#', postNum);\r\n        }\r\n        if (text && !expandNow) {\r\n            text.innerHTML = this.stringList.collapse.replace('#', postNum);\r\n        }\r\n\r\n        // Add to post number to alt when using an image in expand link (expand_text lang string).\r\n        const linkImg = link.querySelector('img.fng-eai');\r\n        if (linkImg) {\r\n            linkImg.alt = `${linkImg.alt} ${postNum}`;\r\n        }\r\n\r\n        link.addEventListener('click', (e) => {\r\n            e.preventDefault();\r\n            if (link.inProcess) {\r\n                return;\r\n            }\r\n            link.post.focushandler = null;\r\n\r\n            const data = `p=${link.postid}${this.cloneParam}&short=${expandNow ? 'true' : 'false'}`;\r\n            const url = `${Config.wwwroot}/mod/forumng/expandpost.php`;\r\n\r\n            const cfg = {\r\n                method: 'GET',\r\n                headers: {\r\n                    'Content-Type': 'application/json'\r\n                },\r\n            };\r\n\r\n            fetch(url + '?' + data, cfg)\r\n                .then(response => response.text())\r\n                .then(text => {\r\n                    this.expandOk(link, {responseText: text});\r\n                })\r\n                .catch(() => {\r\n                    this.expandError(link);\r\n                });\r\n\r\n            if (link.loader) {\r\n                link.loader.src = this.loaderPix;\r\n            }\r\n            link.inProcess = true;\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Initializes a collapse link so that it can use AJAX to retrieve the message.\r\n     *\r\n     * @param {HTMLElement} link Link node\r\n     * @param {number} postid Post ID\r\n     */\r\n    initCollapse(link, postid) {\r\n        link.post = link.closest('.forumng-post');\r\n        link.loader = link.nextElementSibling;\r\n        while (link.loader && link.loader.nodeName.toLowerCase() !== 'img') {\r\n            link.loader = link.loader.nextElementSibling;\r\n        }\r\n        if (link.loader) {\r\n            link.loader.originalsrc = link.loader.src;\r\n        }\r\n        link.postid = postid;\r\n        link.delay = true;\r\n\r\n        this.processLinkRetrieveMessage(link, false);\r\n    }\r\n\r\n    /**\r\n     * Some browsers cannot execute JavaScript just by inserting script tags.\r\n     * To avoid that problem, remove all script tags from the given content,\r\n     * and run them later.\r\n     *\r\n     * @param {string} text HTML content\r\n     * @param {Array} scriptCommands Array of commands (the commands will be pushed\r\n     *   into this)\r\n     * @return {string} New text with JS removed\r\n     */\r\n    extractJs(text, scriptCommands) {\r\n        const scriptRegexp = /<script[^>]*>([\\s\\S]*?)<\\/script>/g;\r\n\r\n        let result;\r\n        while ((result = scriptRegexp.exec(text)) !== null) {\r\n            scriptCommands.push(result[1]);\r\n        }\r\n\r\n        return text.replace(scriptRegexp, '');\r\n    }\r\n\r\n    /**\r\n     * AJAX response: Expand completes successfully.\r\n     *\r\n     * @param {object} link Link node\r\n     * @param {object} o YUI response object\r\n     */\r\n    expandOk(link, o) {\r\n        const newDiv = document.createElement('div');\r\n        const scriptCommands = [];\r\n        newDiv.innerHTML = this.extractJs(o.responseText, scriptCommands);\r\n        let newpost = newDiv.firstChild;\r\n        newDiv.removeChild(newpost);\r\n        const focushandler = link.post.focushandler;\r\n\r\n        // If in select mode, note previous selection value.\r\n        let previousSelect = false;\r\n        if (this.select.on) {\r\n            previousSelect = document.querySelector(`#checkp${link.postid}`).checked;\r\n        }\r\n\r\n        const expander = new Expander(link.post);\r\n        const linkPostParent = link.post.parentNode;\r\n        if (linkPostParent) {\r\n            linkPostParent.insertBefore(newpost, link.post);\r\n        }\r\n        link.post.remove();\r\n\r\n        // Run script commands.\r\n        /* eslint-disable no-eval */\r\n        scriptCommands.forEach(cmd => eval(cmd));\r\n\r\n        this.initContent(newpost);\r\n        if (previousSelect) {\r\n            const checkbox = document.querySelector(`#checkp${link.postid}`);\r\n            checkbox.checked = true;\r\n        }\r\n        if (document.body.linksdisabled) {\r\n            Common.linksDisable(newpost);\r\n            // It is not individually disabled, only as part of the general disable, so remove\r\n            // the individual marker.\r\n            newpost.linksdisabled = false;\r\n        }\r\n\r\n        const tracker = document.querySelector('#expanded_posts');\r\n        tracker.value = `${tracker.value}${tracker.value == '' ? '' : ','}${link.postid}`;\r\n\r\n        // For core ratings, init js on expand.\r\n        if (newpost.querySelector('.forumng-ratings-standard')) {\r\n            Rating.initRating(link.postid);\r\n            Rating.initPopup(link.postid);\r\n        }\r\n\r\n        if (!link.delay) {\r\n            // Skip the expanding animation.\r\n            return;\r\n        }\r\n\r\n        expander.go(newpost);\r\n\r\n        if (focushandler) {\r\n            focushandler();\r\n        } else {\r\n            // Replace focus on expand element which got wiped.\r\n            const authorSpan = newpost.querySelectorAll('span.forumng-author');\r\n            if (authorSpan.length > 0) {\r\n                // By default, focus on author name link.\r\n                // The timeout here is because otherwise IE7 sometimes crashes.\r\n                setTimeout(() => {\r\n                    authorSpan[0].firstChild.focus();\r\n                }, 0);\r\n            } else {\r\n                // If author name link is not present, focus on first link (which is usually\r\n                // the 'this is post 3, parent is post N' link).\r\n                const links = newpost.querySelectorAll('a[href]');\r\n                if (links.length > 0) {\r\n                    links[0].focus();\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * AJAX response: Expand fails.\r\n     *\r\n     * @param {HTMLElement} link Link node\r\n     */\r\n    expandError(link) {\r\n        link.inProcess = false;\r\n        link.loader.src = link.loader.originalsrc;\r\n        alert(this.stringList.jserr_load);\r\n    }\r\n\r\n    /**\r\n     * Initialises a 'jump' link (next unread).\r\n     * @param {HTMLElement} link Link node\r\n     */\r\n    initJumpLink(link) {\r\n        link.addEventListener('mousedown', () => {\r\n            this.mouseUser = true;\r\n        });\r\n\r\n        link.addEventListener('click', (e) => {\r\n            e.preventDefault();\r\n            const id = link.getAttribute('href').split('#')[1];\r\n\r\n            // Function to set up focus.\r\n            const focuser = () => {\r\n                const targetPost = document.querySelector(`#${id}`).parentNode;\r\n                const jumpTo = targetPost.querySelector('.forumng-jumpto');\r\n                if (this.mouseUser && jumpTo) {\r\n                    // For mouse (~= visual) users, focus the next link so that after\r\n                    // clicking the first time, they can then repeatedly press return.\r\n                    const equivalent = jumpTo.querySelector(`a.${link.className}`);\r\n                    if (equivalent) {\r\n                        this.focus(equivalent);\r\n                    } else {\r\n                        const prev = jumpTo.querySelector('a.forumng-prev');\r\n                        const next = jumpTo.querySelector('a.forumng-next');\r\n                        if (prev || next) {\r\n                            this.focus(prev ? prev : next);\r\n                        } else {\r\n                            this.focus(jumpTo.querySelector('a'));\r\n                        }\r\n                    }\r\n                } else {\r\n                    // For keyboard-only users, go to the start of the post (makes more sense).\r\n                    const author = targetPost.querySelector('.forumng-author');\r\n                    this.focus(author.querySelector('a'));\r\n                }\r\n            };\r\n\r\n            // Get link target and expand it if required.\r\n            const targetPost2 = document.querySelector(`#${id}`).parentNode;\r\n            if (targetPost2.expandLink) {\r\n                Common.simulateClick(targetPost2.expandLink);\r\n                targetPost2.focushandler = focuser;\r\n            }\r\n\r\n            const targetPost3 = document.querySelector(`#${id}`).parentNode;\r\n            // If post has already been expanded, focus it now.\r\n            if (!targetPost3.focushandler) {\r\n                focuser();\r\n            }\r\n\r\n            // Scroll to it.\r\n            Common.scrollPage(targetPost2);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Focuses the given node (after timeout).\r\n     * @param {HTMLElement} x Node to focus\r\n     */\r\n    focus(x) {\r\n        setTimeout(() => {\r\n            x.focus();\r\n        }, 0);\r\n    }\r\n\r\n    /**\r\n     * Initialises a delete link.\r\n     *\r\n     * @param {HTMLElement} link Link node\r\n     * @param {string} postId Post ID\r\n     * @param {boolean} undelete True if it's actually undelete\r\n     * @param {string} currentUser The current user\r\n     */\r\n    initDelete(link, postId, undelete, currentUser) {\r\n        link.postId = postId;\r\n        link.post = link.closest('.forumng-post');\r\n        link.addEventListener('click', (e) => {\r\n            e.preventDefault();\r\n            if (this.areLinksDisabled(link)) {\r\n                return;\r\n            }\r\n            const url = `${Config.wwwroot}/mod/forumng/deletepost.php`;\r\n            const data = `p=${link.postId}${this.cloneParam}&delete=${undelete ? 0 : 1}&ajax=1`;\r\n            const deleteAndEmail = () => {\r\n                window.location = url + `?p=${link.postId}${this.cloneParam}&delete=1&ajax=1&email=1`;\r\n            };\r\n            const deleteOnly = () => {\r\n                const cfg = {\r\n                    method: 'POST',\r\n                    headers: {\r\n                        'Content-Type': 'application/json'\r\n                    },\r\n                };\r\n                fetch(url + '?' + data, cfg)\r\n                    .then(response => response.text())\r\n                    .then(text => {\r\n                        this.deleteOk(link, {responseText: text});\r\n                    })\r\n                    .catch(() => {\r\n                        this.deleteError(link);\r\n                    });\r\n                Common.linksDisable(link.post);\r\n                link.loader = document.createElement('img');\r\n                link.loader.alt = '';\r\n                link.loader.src = this.loaderPix;\r\n                link.loader.style.position = 'absolute';\r\n                link.parentNode.appendChild(link.loader);\r\n                const linkRegion = Common.getElementScreenPosition(link);\r\n                link.loader.style.left = `${linkRegion.right + 3}px`;\r\n                link.loader.style.top = `${linkRegion.top}px`;\r\n            };\r\n\r\n            const deleteButtons = currentUser\r\n                ? [this.stringList.deletepostbutton]\r\n                : [this.stringList.deleteemailpostbutton, this.stringList.deletepostbutton];\r\n\r\n            const deleteOptions = currentUser\r\n                ? [deleteOnly, '']\r\n                : [deleteAndEmail, deleteOnly, ''];\r\n\r\n            this.confirm(\r\n                undelete ? this.stringList.confirmundelete : this.stringList.confirmdelete,\r\n                undelete ? this.stringList.undeletepostbutton : deleteButtons,\r\n                this.stringList.cancel, link.post,\r\n                undelete ? deleteOnly : deleteOptions\r\n            );\r\n        });\r\n    }\r\n\r\n    /**\r\n     * AJAX response: Delete completes OK / Set rating completes OK.\r\n     *\r\n     * @param {Object} link Link (for delete) or div (for rating), which contains a '.post' variable\r\n     * @param {Object} response Response object\r\n     *   for the post object\r\n     */\r\n    deleteOk(link, response) {\r\n        const newDiv = document.createElement('div');\r\n        newDiv.innerHTML = response.responseText;\r\n        let newPost = newDiv.firstChild;\r\n\r\n        // Post may be blank when deleting (if not admin).\r\n        if (newPost) {\r\n            link.post.parentNode.insertBefore(newPost, link.post);\r\n        }\r\n\r\n        Common.linksEnable(link.post);\r\n        link.post.remove();\r\n\r\n        if (newPost) {\r\n            this.initContent(newPost);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * AJAX response: Delete fails / Set rating fails.\r\n     *\r\n     * @param {Object} link Link (for delete), which contains a '.post' variable\r\n     *   for the post object\r\n     */\r\n    deleteError(link) {\r\n        if (link.loader) {\r\n            link.loader.remove();\r\n        }\r\n        Common.linksEnable(link.post);\r\n        alert(this.stringList.jserr_alter);\r\n    }\r\n\r\n\r\n    /**\r\n     * Displays a fancy dialog box on a faded-out background in the middle of the\r\n     * screen.\r\n     * @param {string} message Message to display (may include html; if heading is included,\r\n     *     we recommend h4)\r\n     * @param {string} actionText Name for action button(s). May be a single string or\r\n     *     array if you need multiple buttons\r\n     * @param {string} cancelText Name for cancel button\r\n     * @param {HTMLElement} highlight HTML element that should be highlighted (with an orange\r\n     *     box), used e.g. to indicate which post is being deleted\r\n     * @param {function} action Function that gets run if user clicks the action button\r\n     *     (if there are multiple action buttons, this too must be an array)\r\n     */\r\n    confirm(message, actionText, cancelText, highlight, action) {\r\n        if (typeof actionText == 'string') {\r\n            // There is only one action (text and functions); make it look like an array.\r\n            actionText = [actionText];\r\n            action = [action];\r\n        }\r\n\r\n        const fadePanel = document.createElement('div');\r\n        fadePanel.classList.add('forumng-fadepanel');\r\n        document.body.appendChild(fadePanel);\r\n        fadePanel.style.position = 'absolute';\r\n        fadePanel.style.top = '0';\r\n        fadePanel.style.left = '0';\r\n        fadePanel.style.width = Common.getDocWidth() + 'px';\r\n        fadePanel.style.height = Common.getDocHeight() + 'px';\r\n        fadePanel.style.zIndex = 10;\r\n\r\n        fadePanel.style.opacity = 0.0;\r\n        // Animate to 0.5 opacity over 250ms with linear easing.\r\n        this.animateOpacity(fadePanel, 0.0, 0.5, 250, this.linearEasing);\r\n\r\n        // Handle highlight element.\r\n        let highlightDiv = null;\r\n        if (highlight) {\r\n            const highlightRegion = Common.getElementScreenPosition(highlight);\r\n\r\n            highlightDiv = document.createElement('div');\r\n            highlightDiv.classList.add('forumng-highlightbox');\r\n            document.body.appendChild(highlightDiv);\r\n\r\n            highlightDiv.style.position = 'absolute';\r\n            highlightDiv.style.top = highlightRegion.top + 'px';\r\n            highlightDiv.style.left = highlightRegion.left + 'px';\r\n            highlightDiv.style.zIndex = 15;\r\n\r\n            const height = highlightRegion.bottom - highlightRegion.top -\r\n                Common.removePX(window.getComputedStyle(highlightDiv).borderTopWidth) -\r\n                Common.removePX(window.getComputedStyle(highlightDiv).borderBottomWidth) -\r\n                Common.removePX(window.getComputedStyle(highlightDiv).paddingTop) -\r\n                Common.removePX(window.getComputedStyle(highlightDiv).paddingBottom);\r\n            const width = highlightRegion.right - highlightRegion.left -\r\n                Common.removePX(window.getComputedStyle(highlightDiv).borderLeftWidth) -\r\n                Common.removePX(window.getComputedStyle(highlightDiv).borderRightWidth) -\r\n                Common.removePX(window.getComputedStyle(highlightDiv).paddingLeft) -\r\n                Common.removePX(window.getComputedStyle(highlightDiv).paddingRight);\r\n\r\n            highlightDiv.style.height = height + 'px';\r\n            highlightDiv.style.width = width + 'px';\r\n        }\r\n\r\n        // Create dialog element.\r\n        const dialog = document.createElement('div');\r\n        dialog.classList.add('forumng-confirmdialog');\r\n        document.body.appendChild(dialog);\r\n\r\n        // Set dialog position.\r\n        dialog.style.position = 'absolute';\r\n        dialog.style.zIndex = 20;\r\n\r\n        // Get viewport dimensions.\r\n        const region = Common.getViewportRegion();\r\n\r\n        region.height = region.bottom - region.top;\r\n        region.width = region.right - region.left;\r\n\r\n        dialog.style.top = (region.top + region.height / 3) + 'px';\r\n\r\n        // Set dialog width based on window size.\r\n        const page = Common.getElementScreenPosition(document.getElementById('page'));\r\n        const pixelsWidth = page.right - page.left;\r\n        let leftAdjuster = 0;\r\n        let requiredBoxWidth = 630;\r\n        if (pixelsWidth < 700) {\r\n            requiredBoxWidth = pixelsWidth - 40;\r\n            leftAdjuster = 5;\r\n        }\r\n        dialog.style.width = (requiredBoxWidth - 10) + 'px';\r\n\r\n        let leftValue = region.left + region.width / 2 - (requiredBoxWidth / 2) - leftAdjuster;\r\n        // Ensure left position is not negative.\r\n        leftValue = Math.max(leftValue, 0);\r\n        dialog.style.left = leftValue + 'px';\r\n\r\n        const messageDiv = document.createElement('div');\r\n        messageDiv.classList.add('forumng-message');\r\n        messageDiv.tabIndex = -1;\r\n        messageDiv.innerHTML = message;\r\n        dialog.appendChild(messageDiv);\r\n\r\n        const buttonDiv = document.createElement('div');\r\n        buttonDiv.className = 'forumng-buttons';\r\n        dialog.appendChild(buttonDiv);\r\n\r\n        const cancel = document.createElement('input');\r\n        cancel.type = 'button';\r\n        cancel.value = cancelText;\r\n        cancel.addEventListener('click', () => {\r\n            dialog.remove();\r\n            fadePanel.remove();\r\n            if (highlightDiv) {\r\n                highlightDiv.remove();\r\n            }\r\n        });\r\n\r\n        for (var i = 0; i < actionText.length; i++) {\r\n            buttonDiv.appendChild(this.confirmMakeButton(actionText[i], action[i], cancel, false));\r\n        }\r\n\r\n        this.focus(messageDiv);\r\n        buttonDiv.appendChild(cancel);\r\n    }\r\n\r\n    /**\r\n     * Makes a button for the confirm dialog.\r\n     *\r\n     * @param {string} actionText - Text\r\n     * @param {function} action - Function to call if button is clicked\r\n     * @param {HTMLElement} cancel - Cancel button (which is automatically clicked before calling action)\r\n     * @param {boolean} focus - True if this should be focused\r\n     * @returns {HTMLInputElement} - The created button element\r\n     */\r\n    confirmMakeButton(actionText, action, cancel, focus) {\r\n        const yes = document.createElement('input');\r\n        yes.type = 'button';\r\n        yes.value = actionText;\r\n\r\n        yes.addEventListener('click', () => {\r\n            Common.simulateClick(cancel);\r\n            action();\r\n        });\r\n\r\n        if (focus) {\r\n            yes.focus();\r\n        }\r\n\r\n        return yes;\r\n    }\r\n\r\n    /**\r\n     * Logs data using the console if available.\r\n     *\r\n     * @param {string} thing Thing to log\r\n     */\r\n    log(thing) {\r\n        if (typeof console !== 'undefined') {\r\n            window.console.debug(thing);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Initialises forum main page JavaScript.\r\n     *\r\n     */\r\n    initView() {\r\n        // Set the focus on the sort links when clicked.\r\n        this.focusSortLinks();\r\n\r\n        // Set up all the draft links to use discuss.php instead of non-JS version.\r\n        document.querySelectorAll('.forumng-main a').forEach(link => {\r\n            const match = link.className.match(/^forumng-draftreply-([0-9]+)-([0-9]+)$/);\r\n            if (match) {\r\n                const linkMatch = link.href.match(/draft=([0-9]+)(&clone=[0-9]+)?$/);\r\n                if (linkMatch) {\r\n                    link.href = `discuss.php?d=${match[1]}${this.cloneParam}&draft=${linkMatch[1]}#p${match[2]}`;\r\n                }\r\n            }\r\n        });\r\n\r\n        // Set up flag icons.\r\n        this.initFlags(document.body);\r\n\r\n        // Change selected buttons into links with text in brackets.\r\n        document.querySelectorAll('input.forumng-button-to-link').forEach(button => {\r\n            this.turnButtonIntoLink(button);\r\n        });\r\n\r\n        // Init feature buttons.\r\n        this.initFeatureButtons(true);\r\n    }\r\n\r\n    /**\r\n     * Focuses sort links after reloading page when a sort link was clicked.\r\n     */\r\n    focusSortLinks() {\r\n        const url = window.location.href;\r\n        const searchIndex = url.search(/&sortlink=/);\r\n        if (searchIndex !== -1) {\r\n            const sortLinkId = \"sortlink_\" + url.substr(searchIndex + 10, 1);\r\n            this.focus(document.querySelector('#' + sortLinkId));\r\n        }\r\n    }\r\n\r\n    /**\r\n     * On the main page, turns a button into a link with text in brackets (this is we\r\n     * can have commands which are POST requests but look like links).\r\n     *\r\n     * @param {HTMLElement} button Button node\r\n     */\r\n    turnButtonIntoLink(button) {\r\n        const span = document.createElement('span');\r\n        span.appendChild(document.createTextNode('('));\r\n        const link = document.createElement('a');\r\n        link.appendChild(document.createTextNode(button.value));\r\n        link.href = '#';\r\n        link.addEventListener('click', (e) => {\r\n            e.preventDefault();\r\n            Common.simulateClick(button);\r\n        });\r\n        span.appendChild(link);\r\n        span.appendChild(document.createTextNode(') '));\r\n        button.parentNode.insertBefore(span, button);\r\n        button.style.display = 'none';\r\n    }\r\n\r\n    /**\r\n     * Initialises the post selector feature, switching the whole page into post select mode.\r\n     *\r\n     * @param {HTMLElement|null} target Target button that indicates where the resulting selection will be posted,\r\n     *   or null to cancel select mode\r\n     */\r\n    selectInit(target) {\r\n        this.select.on = target ? true : false;\r\n\r\n        const posts = document.querySelectorAll('div.forumng-post');\r\n        const confirm = document.createElement('input');\r\n        confirm.setAttribute('type', 'submit');\r\n\r\n        const extraneousDisplay = this.select.on ? 'none' : 'block';\r\n        document.querySelector('#forumng-expandall').style.display = extraneousDisplay;\r\n        document.querySelector('#forumng-features').style.display = extraneousDisplay;\r\n        const subscribeOptions = document.querySelector('#forumng-subscribe-options');\r\n        if (subscribeOptions) {\r\n            subscribeOptions.style.display = extraneousDisplay;\r\n        }\r\n\r\n        const main = document.querySelector('#forumng-main');\r\n        const all = document.createElement('input');\r\n        const none = document.createElement('input');\r\n        if (this.select.on) {\r\n            // Make form around main elements.\r\n            const form = document.createElement('form');\r\n            this.select.form = form;\r\n            form.setAttribute('method', 'post');\r\n            form.setAttribute('action', target.form.action);\r\n            main.classList.add('forumng-selectmode');\r\n\r\n            form.inputs = document.createElement('div');\r\n            form.appendChild(form.inputs);\r\n            let field = document.createElement('input');\r\n            field.setAttribute('type', 'hidden');\r\n            field.setAttribute('name', 'd');\r\n            field.setAttribute('value', this.discussionID);\r\n            form.inputs.appendChild(field);\r\n            field = document.createElement('input');\r\n            field.setAttribute('type', 'hidden');\r\n            field.setAttribute('name', 'fromselect');\r\n            field.setAttribute('value', '1');\r\n            form.inputs.appendChild(field);\r\n            if (this.cloneID) {\r\n                field = document.createElement('input');\r\n                field.setAttribute('type', 'hidden');\r\n                field.setAttribute('name', 'clone');\r\n                field.setAttribute('value', this.cloneID);\r\n                form.inputs.appendChild(field);\r\n            }\r\n\r\n            // Make intro.\r\n            form.intro = document.createElement('div');\r\n            form.intro.classList.add('forumng-selectintro');\r\n            main.parentNode.insertBefore(form.intro, main);\r\n            const introText = document.createElement('p');\r\n            introText.innerHTML = this.stringList.selectintro;\r\n            form.intro.appendChild(introText);\r\n\r\n            // Make buttons to select all/none.\r\n            const selectButtons = document.createElement('div');\r\n            selectButtons.classList.add('forumng-selectbuttons');\r\n            form.intro.appendChild(selectButtons);\r\n\r\n            all.setAttribute('type', 'button');\r\n            all.setAttribute('value', this.stringList.selectall);\r\n            selectButtons.appendChild(all);\r\n            all.addEventListener('click', () => {\r\n                const posts = document.querySelectorAll('div.forumng-post');\r\n                posts.forEach(post => {\r\n                    if (!post.check.checked) {\r\n                        Common.simulateClick(post.check);\r\n                    }\r\n                });\r\n                all.disabled = true;\r\n                none.disabled = false;\r\n            });\r\n            selectButtons.appendChild(document.createTextNode(' '));\r\n\r\n\r\n            none.setAttribute('type', 'button');\r\n            none.setAttribute('value', this.stringList.deselectall);\r\n            selectButtons.appendChild(none);\r\n            none.addEventListener('click', () => {\r\n                const posts = document.querySelectorAll('div.forumng-post');\r\n                posts.forEach(post => {\r\n                    if (post.check.checked) {\r\n                        Common.simulateClick(post.check);\r\n                    }\r\n                });\r\n                all.disabled = false;\r\n                none.disabled = true;\r\n            });\r\n\r\n            main.appendChild(form);\r\n\r\n            // Make outro.\r\n            form.outro = document.createElement('div');\r\n            form.outro.classList.add('forumng-selectoutro');\r\n            form.appendChild(form.outro);\r\n\r\n            confirm.setAttribute('value', this.stringList.confirmselection);\r\n            form.outro.appendChild(confirm);\r\n\r\n            form.outro.appendChild(document.createTextNode(' '));\r\n\r\n            const cancel = document.createElement('input');\r\n            cancel.setAttribute('type', 'button');\r\n            cancel.setAttribute('id', 'forumng-cancel-select');\r\n            cancel.setAttribute('value', this.stringList.cancel);\r\n            form.outro.appendChild(cancel);\r\n            cancel.addEventListener('click', () => {\r\n                this.selectInit(null);\r\n            });\r\n\r\n            Common.scrollPage(form.intro, null);\r\n        } else {\r\n            const form = this.select.form;\r\n            form.remove();\r\n            form.intro.remove();\r\n            form.outro.remove();\r\n            main.classList.remove('forumng-selectmode');\r\n            this.select.form = null;\r\n        }\r\n\r\n        window.forumng_select_changed = () => {\r\n            const posts = document.querySelectorAll('div.forumng-post');\r\n            let ok = false;\r\n            let checkcount = 0;\r\n            posts.forEach(post => {\r\n                if (post.check.checked) {\r\n                    ok = true;\r\n                    checkcount++;\r\n                }\r\n            });\r\n            none.disabled = !ok;\r\n            confirm.disabled = !ok;\r\n            all.disabled = checkcount == posts.length;\r\n        };\r\n\r\n        posts.forEach(post => {\r\n            this.selectInitPost(post, this.select.on);\r\n        });\r\n\r\n        if (this.select.on) {\r\n            window.forumng_select_changed();\r\n        }\r\n    }\r\n\r\n\r\n    /**\r\n     * Initialises a single post within select mode.\r\n     *\r\n     * @param {HTMLElement} post Post div\r\n     * @param {boolean} on True if select is being turned on, false if it's being turned off\r\n     */\r\n    selectInitPost(post, on) {\r\n        if (on) {\r\n            const info = post.querySelector('div.forumng-info');\r\n            if (!info) {\r\n                return;\r\n            }\r\n            const span = document.createElement('span');\r\n            const spanSeparator = document.createElement('span');\r\n            span.appendChild(spanSeparator);\r\n            spanSeparator.classList.add('forumng-separator');\r\n            spanSeparator.textContent = ' \\u2022 ';\r\n            info.appendChild(span);\r\n            post.extraSpan = span;\r\n            post.classList.add('forumng-deselected');\r\n            const postid = post.querySelector(':scope > a').id;\r\n\r\n            const check = document.createElement('input');\r\n            check.setAttribute('type', 'checkbox');\r\n            check.id = 'check' + postid;\r\n            post.check = check;\r\n            span.appendChild(check);\r\n\r\n            const label = document.createElement('label');\r\n            label.classList.add('accesshide');\r\n            label.setAttribute('for', check.id);\r\n            label.textContent = this.stringList.selectlabel;\r\n            span.appendChild(label);\r\n\r\n            Common.linksDisable(document.body);\r\n\r\n            let hidden = document.querySelector(\"input[name='select\" + postid + \"']\");\r\n            if (!hidden) {\r\n                hidden = document.createElement('input');\r\n                hidden.setAttribute('type', 'hidden');\r\n                hidden.setAttribute('value', '0');\r\n                hidden.setAttribute('name', 'select' + postid);\r\n                this.select.form.appendChild(hidden);\r\n            }\r\n            post.forumng_hidden = hidden;\r\n\r\n            check.addEventListener('click', () => {\r\n                if (check.checked) {\r\n                    post.classList.remove('forumng-deselected');\r\n                    post.forumng_hidden.value = 1;\r\n                } else {\r\n                    post.classList.add('forumng-deselected');\r\n                    post.forumng_hidden.value = 0;\r\n                }\r\n                window.forumng_select_changed();\r\n            });\r\n        } else {\r\n            if (post.extraSpan) {\r\n                post.extraSpan.remove();\r\n            }\r\n            post.classList.remove('forumng-deselected');\r\n            Common.linksEnable(document.body);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sets up certain selects (currently just the 'Move discussion' one) so that their\r\n     * accompanying button is disabled when the select is set to 0.\r\n     *\r\n     * @param {HTMLElement} submit Submit button that goes with select\r\n     */\r\n    zeroDisable(submit) {\r\n        // Assuming submit is an HTMLInputElement.\r\n        const select = submit.previousElementSibling;\r\n        if (!select || select.nodeName.toLowerCase() !== 'select') {\r\n            this.log('Warning: Zero-disable feature incorrectly applied.');\r\n            return;\r\n        }\r\n\r\n        const update = () => {\r\n            if (submit.classList.contains('forumng-zero-disable')) {\r\n                submit.disabled = select.value == 0;\r\n            }\r\n        };\r\n\r\n        update();\r\n        select.addEventListener('change', update);\r\n    }\r\n\r\n    /**\r\n     * Asks browser to print the page.\r\n     */\r\n    printPage() {\r\n        window.print();\r\n    }\r\n\r\n    /**\r\n     * Initialises the subscriber list page JavaScript.\r\n     *\r\n     */\r\n    initSubscribers() {\r\n        const buttonsDiv = document.getElementById('forumng-buttons');\r\n        const selectAll = document.createElement('input');\r\n        selectAll.type = 'button';\r\n        selectAll.value = this.stringList.selectall;\r\n        buttonsDiv.appendChild(document.createTextNode(' '));\r\n        buttonsDiv.appendChild(selectAll);\r\n\r\n        const deselectAll = document.createElement('input');\r\n        deselectAll.type = 'button';\r\n        deselectAll.value = this.stringList.deselectall;\r\n        buttonsDiv.appendChild(document.createTextNode(' '));\r\n        buttonsDiv.appendChild(deselectAll);\r\n\r\n        let unsubscribe;\r\n        const inputs = document.getElementById('forumng-subscription-list').querySelectorAll('input');\r\n        const all = [];\r\n\r\n        for (const input of inputs) {\r\n            if (input.name.startsWith('user')) {\r\n                all.push(input);\r\n            } else if (input.name == 'unsubscribe') {\r\n                unsubscribe = input;\r\n            }\r\n        }\r\n\r\n        const update = () => {\r\n            let allSelected = true;\r\n            let noneSelected = true;\r\n\r\n            for (const item of all) {\r\n                if (item.checked) {\r\n                    noneSelected = false;\r\n                } else {\r\n                    allSelected = false;\r\n                }\r\n            }\r\n\r\n            selectAll.disabled = allSelected;\r\n            deselectAll.disabled = noneSelected;\r\n            unsubscribe.disabled = noneSelected;\r\n        };\r\n\r\n        update();\r\n\r\n        all.forEach((item) => item.addEventListener('click', update));\r\n\r\n        selectAll.addEventListener('click', () => {\r\n            all.forEach((item) => {\r\n                item.checked = true;\r\n            });\r\n            update();\r\n        });\r\n\r\n        deselectAll.addEventListener('click', () => {\r\n            all.forEach((item) => {\r\n                item.checked = false;\r\n            });\r\n            update();\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Retrieves the value of a parameter from the query string of the current URL.\r\n     *\r\n     * @param {string} parameterName - The name of the parameter to retrieve.\r\n     * @returns {string|null} The value of the specified parameter if found, otherwise null.\r\n     */\r\n    getValueParameter(parameterName) {\r\n        const urlParams = new URLSearchParams(window.location.search);\r\n        return urlParams.get(parameterName) || null;\r\n    }\r\n\r\n    /**\r\n     * Animates the opacity of an element from a start value to an end value over a specified duration.\r\n     *\r\n     * @param {HTMLElement} element - The DOM element to animate\r\n     * @param {number} startOpacity - The initial opacity value\r\n     * @param {number} endOpacity - The target opacity value\r\n     * @param {number} duration - The duration of the animation in milliseconds\r\n     * @param {function} easingFunction - The easing function to use for the animation\r\n     */\r\n    animateOpacity(element, startOpacity, endOpacity, duration, easingFunction) {\r\n        let start = null;\r\n        const deltaOpacity = endOpacity - startOpacity;\r\n\r\n        /**\r\n         * A step function to perform the animation frame by frame.\r\n         *\r\n         * @param {DOMHighResTimeStamp} timestamp - The current time.\r\n         */\r\n        function step(timestamp) {\r\n            if (!start) {\r\n                start = timestamp;\r\n            }\r\n            const progress = timestamp - start;\r\n            const easeProgress = easingFunction(progress / duration);\r\n            element.style.opacity = startOpacity + deltaOpacity * easeProgress;\r\n\r\n            if (progress < duration) {\r\n                requestAnimationFrame(step);\r\n            } else {\r\n                element.style.opacity = endOpacity;\r\n            }\r\n        }\r\n\r\n        requestAnimationFrame(step);\r\n    }\r\n\r\n    /**\r\n     * A linear easing function.\r\n     *\r\n     * @param {number} t - The progress of the animation (a value between 0 and 1)\r\n     * @returns {number} - The adjusted progress\r\n     */\r\n    linearEasing(t) {\r\n        return t;\r\n    }\r\n}\r\n\r\n/**\r\n * Initialise function\r\n *\r\n * @param {object} options Options for ajax request\r\n */\r\nexport const init = (options) => {\r\n    const main = new Main(options);\r\n    main.initializer();\r\n};"],"names":["Main","constructor","options","cmID","cmid","cloneID","cloneid","cloneParam","ratingStars","ratingstars","quotaLeft","quotaleft","loaderPix","loaderpix","starPix","starpix","postQuota","postquota","this","prepareStrings","domInit","urgentInit","requests","mainStrings","posts","period","Object","entries","forEach","_ref","string","value","push","stringList","fromEntries","then","fetchedStrings","Map","map","index","key","catch","Notification","exception","document","getElementById","link","initSwitchLink","initSubscribers","initView","initDiscuss","initContent","printPage","initDeletepost","newStyle","createElement","setAttribute","styleSheets","length","addRule","getElementsByTagName","appendChild","styleText","selector","createTextNode","addEventListener","parentNode","style","position","discussionID","window","location","search","replace","postid","getValueParameter","hash","id","scrollIntoView","behavior","block","forumngMain","classList","remove","div","querySelector","form","insertBefore","div1","initDeldiscussion","saveall","removeChild","initFeatureButtons","applyStopIndents","region","Common","getElementScreenPosition","viewportWidth","right","left","setInterval","width","msg","messagehtml","textContent","innerHTML","e","preventDefault","deleteButtons","deleteemailpostbutton","deletepostbutton","actionUrl","action","confirm","confirmdeletediscuss","cancel","href","node","select","on","contains","selectInitPost","expandposts","match","parseInt","expandedList","split","i","killReplyLinks","querySelectorAll","initExpiry","getAttribute","initExpand","initCollapse","initReply","initEdit","initDelete","initParentLink","initJumpLink","initPostread","ratings","ratingoptions","ratingins","StarDiscussion","rating","initRating","createRateButton","input","zeroDisable","initFlags","filterEvents","notifyFilterContentUpdated","newButton","rate","nextSibling","disabled","url","Config","wwwroot","data","postId","fetch","method","headers","response","text","deleteOk","responseText","deleteError","linksDisable","post","loader","byregion","top","seconds","forumngExpiryJavatime","Date","now","expireLinks","timerid","current","deadlink","splice","clearInterval","removeIframe","iframe","scrollToParent","parent","removeAttribute","isMobile","display","event","nowEditing","scrollPage","linksEnable","body","detectOS","ua","navigator","userAgent","test","androidOS","iOS","otherOS","initIframe","src","isUnread","className","includes","pendingPromise","Pending","iframecon","add","name","height","iframe_has_loaded","innerwin","resolve","pendingPromisefil","doc","counter","editemailHead","fixHeight","pendingPromisefir","scrollHeight","Number","overflow","zIndex","webkitOverflowScrolling","overflowX","overflowY","clientHeight","scrolling","focus","scrollTo","theme","getComputedStyle","margin","scrollWidth","marginLeft","setTimeout","blank","innerText","stopPropagation","cancelBubble","draftbut","x","try_focus","tinyMCE","edId","editors","execCommand","ends","last","areLinksDisabled","closest","rootpost","iframe_success","scriptcommands","newpost","prepareNewPost","img","cmd","eval","subjectinput","subject","discussionTitles","title","navbar","lastspan","firstChild","responsetext","newdiv","extractedHTML","extractJs","firstElementChild","replytoid","draft","forumng_draft","replies","nextElementSibling","quotaDiv","quotaItem","quotaleft_singular","quotaleft_plural","parentpostid","simulateClick","initFlagDiv","anchor","span","icon","handleClick","clearstar","setstar","starpost","alert","jserr_alter","removeEventListener","async","islist","tagName","initSelectButton","submit","isList","include","exclude","includeEl","excludeEl","inputs","inputNodes","children","selectordiscall","selectoralldisc","selectorselecteddisc","bind","discussionoptions","selectDiscussion","SelectDiscussion","selectDiscussInit","selectorall","discussion","selectedposts","selectInit","matchMedia","matches","maxIndentPixels","stopIndent","Math","floor","reply","getReplyIndent","forumng_indent","indent","ancestor","parentElement","documentElement","linksdisabled","deepCloneChangeItemid","obj","itemid","Array","isArray","c","prototype","hasOwnProperty","call","setTimeoutMulti","fn","count","expandNow","expandLink","nodeName","toLowerCase","originalSrc","delay","processLinkRetrieveMessage","postNum","expand","collapse","linkImg","alt","inProcess","focushandler","expandOk","expandError","originalsrc","scriptCommands","scriptRegexp","result","exec","o","newDiv","previousSelect","checked","expander","Expander","linkPostParent","checkbox","tracker","Rating","initPopup","go","authorSpan","links","jserr_load","mouseUser","focuser","targetPost","jumpTo","equivalent","prev","next","author","targetPost2","undelete","currentUser","deleteOnly","linkRegion","deleteOptions","confirmundelete","confirmdelete","undeletepostbutton","newPost","message","actionText","cancelText","highlight","fadePanel","getDocWidth","getDocHeight","opacity","animateOpacity","linearEasing","highlightDiv","highlightRegion","bottom","removePX","borderTopWidth","borderBottomWidth","paddingTop","paddingBottom","borderLeftWidth","borderRightWidth","paddingLeft","paddingRight","dialog","getViewportRegion","page","pixelsWidth","leftAdjuster","requiredBoxWidth","leftValue","max","messageDiv","tabIndex","buttonDiv","type","confirmMakeButton","yes","log","thing","console","debug","focusSortLinks","linkMatch","button","turnButtonIntoLink","searchIndex","sortLinkId","substr","target","extraneousDisplay","subscribeOptions","main","all","none","field","intro","introText","selectintro","selectButtons","selectall","check","deselectall","outro","confirmselection","forumng_select_changed","ok","checkcount","info","spanSeparator","extraSpan","label","selectlabel","hidden","forumng_hidden","previousElementSibling","update","print","buttonsDiv","selectAll","deselectAll","unsubscribe","startsWith","allSelected","noneSelected","item","parameterName","URLSearchParams","get","element","startOpacity","endOpacity","duration","easingFunction","start","deltaOpacity","requestAnimationFrame","step","timestamp","progress","easeProgress","t","init","initializer"],"mappings":"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"}