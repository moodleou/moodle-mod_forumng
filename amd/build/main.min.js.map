{"version":3,"file":"main.min.js","sources":["../src/main.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\nimport {get_strings as getStrings} from 'core/str';\nimport Notification from 'core/notification';\nimport * as filterEvents from 'core_filters/events';\nimport {Expander} from 'mod_forumng/expander';\nimport {StarDiscussion} from 'mod_forumng/stardiscussion';\nimport {SelectDiscussion} from 'mod_forumng/selectdiscussion';\nimport * as Common from 'mod_forumng/common';\nimport Pending from 'core/pending';\nimport Config from 'core/config';\nimport * as Rating from 'local_themeextras/rating';\nimport * as TinyRepository from 'tiny_autosave/repository';\n\n/**\n * JavaScript to handle forumng.\n *\n * @module mod_forumng/main\n * @copyright 2024 The Open University\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nclass Main {\n    /** @var {string} cloneParam Clone id in param */\n    cloneParam = '';\n\n    /** @var {Number} cloneID Clone ID or 0 if none */\n    cloneID = 0;\n\n    /** @var {Number} cmID Course-module id of this forum */\n    cmID = 0;\n\n    /** @var {Number} ratingStars The number of stars (1-5) used for ratings */\n    ratingStars = 0;\n\n    /** @var {Number} discussionID Discussion if of this forum */\n    discussionID = 0;\n\n    /** @var {Array} expireLinks List of expire links */\n    expireLinks = [];\n\n    /** @var {Object} select Object containing selected node */\n    select = {};\n\n    /** @var {Number} quotaLeft If set, the number of posts left in post quota */\n    quotaLeft = 0;\n\n    /** @var {string} loaderPix URL of AJAX loader icon */\n    loaderPix = '';\n\n    /** @var {boolean} mouseUser Mouse event status */\n    mouseUser = false;\n\n    /** @var {Number} viewportWidth Viewport width */\n    viewportWidth = -1;\n\n    /** @var {Object} starPix Object containing multiple URLs of the various star icons */\n    starPix = {};\n\n    /** @var {boolean} nowEditing Editing status */\n    nowEditing = false;\n\n    /** @var {*} postQuota The number (seconds) or text description of the max-posts period of the current forum */\n    postQuota = false;\n\n    /** @var {Object} mainStrings Object containing main strings */\n    mainStrings = {\n        'rate': null,\n        'expand': '#',\n        'collapse': '#',\n        'jserr_load': null,\n        'jserr_save': null,\n        'jserr_alter': null,\n        'jserr_attachments': null,\n        'confirmdelete': null,\n        'confirmundelete': null,\n        'confirmdeletediscuss': null,\n        'deleteemailpostbutton': null,\n        'deletepostbutton': null,\n        'undeletepostbutton': null,\n        'js_nratings': null,\n        'js_nratings1': null,\n        'js_nopublicrating': null,\n        'js_publicrating': null,\n        'js_nouserrating': null,\n        'js_userrating': null,\n        'js_outof': null,\n        'js_clicktosetrating': null,\n        'js_clicktosetrating1': null,\n        'js_clicktoclearrating': null,\n        'selectlabel': null,\n        'selectintro': null,\n        'confirmselection': null,\n        'selectedposts': null,\n        'discussion': null,\n        'selectorall': null,\n        'selectoralldisc': null,\n        'selectorselecteddisc': null,\n        'selectordiscall': null,\n        'selectdiscintro': null,\n        'staron': null,\n        'staroff': null,\n        'clearstar': null,\n        'setstar': null,\n        'starpost': null,\n    };\n\n    /** @var {object} stringList List of strings */\n    stringList = {};\n\n    /** @var {boolean} isUsingTiny Is using Tiny editor */\n    isUsingTiny = false;\n\n    /**\n     * Class constructor\n     *\n     * @param {object} options Options for ajax request\n     */\n    constructor(options) {\n        this.cmID = options.cmid;\n        this.cloneID = options.cloneid;\n        this.cloneParam = options.cloneid ? '&clone=' + options.cloneid : '';\n        this.ratingStars = options.ratingstars;\n        this.quotaLeft = options.quotaleft;\n        this.loaderPix = options.loaderpix;\n        this.starPix = options.starpix;\n        this.postQuota = options.postquota;\n        this.isUsingTiny = options.isusingtiny;\n    }\n\n    /**\n     * Main init function called from HTML.\n     *\n     */\n    async initializer() {\n        await this.prepareStrings();\n        this.domInit();\n        this.urgentInit();\n    }\n\n    /**\n     * Prepare list of strings with key, component and value.\n     *\n     */\n    async prepareStrings() {\n        let requests = [];\n        if (this.postQuota !== null) {\n            this.mainStrings['quotaleft_plural'] = {\n                posts: '#',\n                period: this.postQuota,\n            };\n            this.mainStrings['quotaleft_singular'] = {\n                posts: '#',\n                period: this.postQuota,\n            };\n        }\n\n        Object.entries(this.mainStrings).forEach(([string, value]) => {\n            requests.push({\n                'key': string,\n                'component': 'forumng',\n                'param': value,\n            });\n        });\n\n        ['cancel', 'delete', 'add', 'selectall', 'deselectall'].forEach(string => {\n            this.mainStrings[string] = '#';\n            requests.push({\n                'key': string,\n                'component': 'moodle',\n            });\n        });\n\n        this.stringList = Object.fromEntries(await getStrings(requests)\n            .then(fetchedStrings => new Map(\n                Object.entries(this.mainStrings).map(([key], index) => ([key, fetchedStrings[index]]))\n            )).catch(Notification.exception));\n    }\n\n    /**\n     * Main initialisation done on DOM ready.\n     *\n     */\n    domInit() {\n        // Magicalise the hidden 'switch view mode' link.\n        if (document.getElementById('forumng-switchlinkid')) {\n            let link = document.getElementById('forumng-switchlinkid');\n            this.initSwitchLink(link);\n        }\n\n        // Handle pages other than the discussion page.\n        if (document.getElementById('page-mod-forumng-subscribers')) {\n            this.initSubscribers();\n            return;\n        }\n        if (document.getElementById('page-mod-forumng-view')) {\n            this.initView();\n            return;\n        }\n        if (document.getElementById('page-mod-forumng-discuss')) {\n            this.initDiscuss();\n            return;\n        }\n        if (document.getElementById('page-mod-forumng-feature-deletedposts-deletedpostslist')) {\n            this.initContent(document);\n        }\n        if (document.getElementById('page-mod-forumng-feature-userposts-user')) {\n            this.initContent(document);\n        }\n        if (document.getElementById('page-mod-forumng-feature-print-print')) {\n            this.initContent(document);\n            this.printPage();\n            return;\n        }\n        if (document.getElementById('page-mod-forumng-deletepost')) {\n            this.initDeletepost();\n            return;\n        }\n    }\n\n    /**\n     * Urgent init; this is not done as urgently as it used to be :( because it's only\n     * in footer. I probably need to figure out a better way to do it. TODO\n     */\n    urgentInit() {\n        // Create new stylesheet in head.\n        let newStyle = document.createElement('style');\n        newStyle.setAttribute(\"type\", \"text/css\");\n\n        let selector = '.forumng-ratings';\n        let rules = 'display:none';\n\n        if (document.styleSheets && document.styleSheets.length > 0) {\n            // Check for addRule support (for older IE).\n            if (document.styleSheets[0].addRule) {\n                let head = document.getElementsByTagName('head')[0];\n                head.appendChild(newStyle);\n                document.styleSheets[document.styleSheets.length - 1].addRule(selector, rules);\n            } else {\n                // Other browsers, use text content.\n                let styleText = selector + \" { \" + rules + \" }\";\n                newStyle.appendChild(document.createTextNode(styleText));\n                document.getElementsByTagName('head')[0].appendChild(newStyle);\n            }\n        }\n    }\n\n    /**\n     * Sets up the 'accessible mode switch' link so that it becomes visible (not accesshide)\n     * if you tab to it, including its parent.\n     *\n     * @param {HTMLElement} link - Link tag.\n     */\n    initSwitchLink(link) {\n        link.addEventListener('focus', () => {\n            link.parentNode.style.position = 'static';\n        });\n        link.addEventListener('blur', () => {\n            link.parentNode.style.position = 'absolute';\n        });\n    }\n\n    /**\n     * Initialises all JavaScript for the discussion page.\n     */\n    initDiscuss() {\n        // Get discussion id.\n        this.discussionID = window.location.search.replace(/^.*[?&]d=([0-9]+).*$/, '$1');\n\n        // Get param post id.\n        let postid = this.getValueParameter('p');\n        if (postid) {\n            let link = document.getElementById(postid);\n            if (link) {\n                // For bookmarking.\n                window.location.hash = link.id;\n                link.scrollIntoView({\n                    behavior: 'smooth',\n                    block: 'start'\n                });\n            }\n        }\n\n        let iscollapse = this.getValueParameter('collapse');\n        let isexpand = this.getValueParameter('expand');\n        if (iscollapse || isexpand) {\n            let button = document.querySelector(\n                '#forumng-expandall .forumng-expandall-btn, #forumng-expandall .forumng-collapseall-btn');\n            if (button) {\n                button.focus();\n                button.scrollIntoView({\n                    behavior: 'smooth',\n                    block: 'start'\n                });\n            }\n        }\n\n        // Tell CSS that we have JS working.\n        let forumngMain = document.getElementById('forumng-main');\n        if (forumngMain) {\n            forumngMain.classList.remove('forumng-nojs');\n        }\n\n        // To avoid having nested forms (breaks IE), remove the non-JS action form.\n        let div = document.querySelector('#forumng-actionform > div');\n        if (div) {\n            let form = div.parentNode;\n            div.remove();\n            form.parentNode.insertBefore(div, form);\n            form.remove();\n        }\n\n        let div1 = document.querySelector('.forumng_deldiscussion');\n        if (div1) {\n            this.initDeldiscussion(div1);\n        }\n\n        this.initContent(document.querySelector('#forumng-main'));\n\n        // Hide 'save ratings' button if present.\n        let saveall = document.getElementById('forumng-saveallratings');\n        if (saveall) {\n            saveall.parentNode.removeChild(saveall);\n        }\n\n        // Init feature buttons.\n        this.initFeatureButtons(false);\n\n        // Apply stop indents.\n        this.applyStopIndents();\n        let region = Common.getElementScreenPosition(document.querySelector('#forumng-main'));\n        this.viewportWidth = region.right - region.left;\n        setInterval(() => {\n            let region = Common.getElementScreenPosition(document.querySelector('#forumng-main'));\n            let width = region.right - region.left;\n            if (width !== this.viewportWidth) {\n                this.viewportWidth = width;\n                this.applyStopIndents();\n            }\n        }, 250);\n    }\n\n    /**\n     * Initialises all JavaScript for the deletepost page.\n     */\n    initDeletepost() {\n        // if JS is enabled then we can copy the html version of the text to\n        // the textarea used by tinymce, otherwise plain text is used by default.\n        let msg = document.getElementById('delete-form-html');\n        if (msg) {\n            let messagehtml = msg.textContent;\n            document.getElementById('id_forumng_delete_msg').innerHTML = messagehtml;\n        }\n    }\n\n    /**\n     * Initialises all JavaScript for the delete discussion page.\n     *\n     * @param {HTMLElement} div - Discussion element.\n     */\n    initDeldiscussion(div) {\n        const form = div.parentNode.parentNode;\n        form.addEventListener('submit', (e) => {\n            e.preventDefault();\n            // Build confirmation message with buttons.\n            const deleteButtons = [this.stringList.deleteemailpostbutton, this.stringList.deletepostbutton];\n            const actionUrl = form.action + '?d=' + this.discussionID;\n            const cloneParam = this.cloneID ? '&clone=' + this.cloneID : '';\n            this.confirm(this.stringList.confirmdeletediscuss,\n                deleteButtons,\n                this.stringList.cancel,\n                null, [\n                    function() {\n                        location.href = actionUrl + '&delete=1&email=1' + cloneParam;\n                    },\n                    function() {\n                        location.href = actionUrl + '&delete=1&email=0&notdeleted=1' + cloneParam;\n                    },\n                ]\n            );\n        });\n    }\n\n\n    /**\n     * Initialises 'content' i.e. posts and related. Can be called on the whole page or on\n     * a single post.\n     *\n     * @param {HTMLElement} node to run on (e.g. document node or a post div)\n     */\n    initContent(node) {\n        // When the selector is in use, and this is being run on a single post, then\n        // do special init for the post.\n        if (this.select.on && node.classList.contains('forumng-post')) {\n            this.selectInitPost(node, true);\n        }\n\n        // Get post ID from location hash (initial run only).\n        const expandposts = {};\n        if (node == document || node.id == 'forumng-main') {\n            // Post from location bar.\n            if (window.location.hash) {\n                let match = window.location.hash.match(/p([0-9]+)$/);\n                if (match) {\n                    expandposts[parseInt(match[1])] = true;\n                }\n            }\n            // Posts listed as expanded (from Back button).\n            let expandedList = document.getElementById('expanded_posts');\n            let posts = expandedList ? expandedList.value.split(',') : [];\n            for (let i = 0; i < posts.length; i++) {\n                expandposts[posts[i]] = true;\n            }\n        }\n\n        // Kill reply links if necessary.\n        if (this.quotaLeft == 0) {\n            this.killReplyLinks();\n        }\n\n        // Process all links within the node.\n        node.querySelectorAll('a').forEach((link) => {\n            let href = link.href;\n\n            // Ignore mobile links.\n            if (link.classList.contains('forumng-mobilepost-link')) {\n                return;\n            }\n\n            // Any link with &expires= will be hidden a bit before that time.\n            let match = href.match(/[?&]expires=([0-9]+)(&|$)/);\n            if (match) {\n                this.initExpiry(link, parseInt(match[1]));\n                href = link.getAttribute('href');\n            }\n\n            // Magicalise 'Expand' links.\n            match = href.match(/\\/discuss\\.php\\?d=([0-9]+).*&expand=1#p([0-9]+)$/);\n            if (match && link.classList.contains('forumng-expandlink')) {\n                this.initExpand(link, match[2], expandposts[parseInt(match[2])]);\n            }\n\n            // 'Collapse' links.\n            match = href.match(/\\/discuss\\.php\\?d=([0-9]+).*&collapse=1#p([0-9]+)$/);\n            if (match && link.classList.contains('forumng-collapselink')) {\n                this.initCollapse(link, match[2]);\n            }\n\n            // Magicalise 'Reply' links.\n            match = href.match(/\\/editpost\\.php\\?replyto=([0-9]+).*$/);\n            if (match) {\n                this.initReply(link, parseInt(match[1]));\n            }\n\n            // Magicalise 'Edit' links.\n            match = href.match(/\\/editpost\\.php\\?p=([0-9]+).*$/);\n            if (match) {\n                this.initEdit(link, parseInt(match[1]));\n            }\n\n            // Magicalise 'Delete' / 'Undelete' links.\n            match = href.match(\n                /\\/deletepost\\.php\\?p=([0-9]+)(?:&clone=[0-9]+)?(?:&delete=([0-9]+))?(?:&currentuser=([0-9]))?(?:&expand=1)?$/\n            );\n            if (match) {\n                this.initDelete(link, parseInt(match[1]), match[2] && match[2] == 0, match[3]);\n            }\n\n            // Magicalise the hidden parent-post links.\n            if (link.classList.contains('forumng-parentlink')) {\n                this.initParentLink(link);\n            }\n\n            // Magicalise the jump-to links.\n            if (link.parentNode.classList.contains('forumng-jumpto')) {\n                this.initJumpLink(link);\n            }\n\n            // Magicalise the mark post read link.\n            if (link.parentNode.classList.contains('forumng-markread')) {\n                this.initPostread(link);\n            }\n\n        });\n        // Magicalise rating sections.\n        let ratings = node.querySelectorAll('div.forumng-ratings');\n        if (ratings.length > 0) {\n            let ratingoptions = {\n                'cloneParam': this.cloneParam,\n                'ratingStars': this.ratingStars,\n                'loaderPix': this.loaderPix,\n                'starPix': this.starPix,\n                'stringList': this.stringList,\n            };\n            let ratingins = new StarDiscussion(ratingoptions);\n            ratings.forEach((rating) => {\n                let div = ratingins.initRating(rating);\n                if (typeof div === 'object' && div !== null) {\n                    this.createRateButton(div);\n                }\n            });\n\n        }\n\n        // Find any inputs with the zero-disable feature.\n        let zeroDisableInputs = node.querySelectorAll('input.forumng-zero-disable');\n        zeroDisableInputs.forEach((input) => {\n            this.zeroDisable(input);\n        });\n\n        // Set up flags.\n        this.initFlags(node);\n\n        // Notify the filters about the modified nodes.\n        filterEvents.notifyFilterContentUpdated(node);\n    }\n\n    /**\n     * Creates a rate new button element, inserts it into the DOM, and attaches event listeners.\n     *\n     * @param {Object} div - The container element information.\n     */\n    createRateButton(div) {\n        const newButton = document.createElement('input');\n        newButton.setAttribute('type', 'button');\n        newButton.setAttribute('value', this.stringList.rate);\n        div.selector.parentNode.insertBefore(newButton, div.selector.nextSibling);\n\n        newButton.addEventListener('click', () => {\n            newButton.disabled = true;\n\n            const url = `${Config.wwwroot}/mod/forumng/rate.php`;\n            const data = `p=${div.postId}${this.cloneParam}&rating=${div.selector.value}&ajax=1`;\n            const cfg = {\n                method: 'POST',\n                headers: {\n                    'Content-Type': 'application/json',\n                }\n            };\n\n            fetch(url + '?' + data, cfg)\n                .then(response => response.text())\n                .then(text => {\n                    this.deleteOk(div, {responseText: text});\n                })\n                .catch(() => {\n                    this.deleteError(div);\n                });\n\n            Common.linksDisable(div.post);\n\n            div.loader = document.createElement('img');\n            div.loader.setAttribute('alt', '');\n            div.loader.style.position = 'absolute';\n            div.loader.setAttribute('src', this.loaderPix);\n            div.parentNode.appendChild(div.loader);\n            const byregion = Common.getElementScreenPosition(newButton);\n            div.loader.style.left = `${byregion.right + 3}px`;\n            div.loader.style.top = `${byregion.top + 2}px`;\n        });\n    }\n\n    /**\n     * Applies expiry to links. Some links are marked with &expires=(time) to indicate that the\n     * JavaScript should disable them around that time. (Edit, delete links.)\n     *\n     * @param {HTMLElement} link - Link node\n     * @param {number} seconds - Number of seconds to expire after\n     */\n    initExpiry(link, seconds) {\n        // Actually expires a bit early\n        link.forumngExpiryJavatime = seconds * 1000 - 45000 + Date.now();\n        link.href = link.href.replace(/[?&]expires=[0-9]+/, '');\n\n        this.expireLinks.push(link);\n\n        if (this.expireLinks.length == 1) {\n            const timerid = setInterval(() => {\n                const current = Date.now();\n                for (let i = this.expireLinks.length - 1; i >= 0; i--) {\n                    if (current > this.expireLinks[i].forumngExpiryJavatime) {\n                        const deadlink = this.expireLinks[i];\n                        if (deadlink.parentNode) {\n                            deadlink.parentNode.remove();\n                        }\n                        this.expireLinks.splice(i, 1);\n                    }\n                }\n                if (this.expireLinks.length == 0) {\n                    clearInterval(timerid);\n                }\n            }, 15000);\n        }\n    }\n\n    /**\n     * Removes reply links within a given tag. This is used if you run out of quota so that\n     * you cannot create new replies.\n     *\n     */\n    killReplyLinks() {\n        const links = document.querySelectorAll('#forumng-main a[href]');\n        links.forEach(link => {\n            if (link.href.match(/editpost\\.php\\?replyto=[0-9]+.*$/)) {\n                link.remove();\n            }\n        });\n    }\n\n    /**\n     * Removes iframe and marks it closed.\n     *\n     * @param {HTMLIFrameElement} iframe - The iframe element to remove\n     * @param {boolean} scrollToParent - If true (default), scrolls to parent after removing iframe\n     */\n    removeIframe(iframe, scrollToParent = true) {\n        const parent = iframe.parentNode;\n        parent.removeChild(iframe);\n        parent.removeAttribute('style');\n        if (this.isMobile()) {\n            // Hide iframe container also.\n            parent.style.display = 'none';\n            // Remove scroll event trapping.\n            window.addEventListener('scroll', (event) => {\n                event.preventDefault();\n            });\n        }\n\n        this.nowEditing = false;\n\n        if (scrollToParent) {\n            Common.scrollPage(parent.parentNode);\n        }\n\n        Common.linksEnable(document.body);\n    }\n\n    /**\n     * Get the device's OS.\n     *\n     * @return {string} Device's OS.\n     */\n    detectOS() {\n        const ua = navigator.userAgent;\n\n        if (/android/i.test(ua)) {\n            return Common.androidOS;\n        } else if (/iPad|iPhone|iPod/.test(ua)) {\n            return Common.iOS;\n        }\n        return Common.otherOS;\n    }\n\n    /**\n     * Check is mobile.\n     * @return {boolean} Is mobile\n     */\n    isMobile() {\n        return this.detectOS() === Common.iOS || this.detectOS() === Common.androidOS;\n    }\n\n    /**\n     * Initialises an iframe and adds it.\n     *\n     * @param {string} src - iframe URL (&iframe=1 automatically added)\n     * @param {HTMLElement} post - Post node to add iframe\n     * @returns {HTMLIFrameElement|null} - Iframe element or null if already editing (abort)\n     */\n    initIframe(src, post) {\n        // Check if post is unread.\n        const classnamePost = post.className.split(\" \");\n        let isUnread = classnamePost.includes('forumng-unread');\n\n        // Check we're not already editing.\n        if (this.nowEditing) {\n            return null;\n        }\n        this.nowEditing = true;\n\n        let pendingPromise = new Pending('forumng_iframe');\n\n        // Add special style that marks links disabled.\n        Common.linksDisable(document.body);\n\n        // Create iframe container and iframe elements.\n        const iframecon = document.createElement('div');\n        iframecon.classList.add('iframecon');\n        const iframe = document.createElement('iframe');\n        iframe.className = 'forumng-inlineform';\n        iframe.name = 'forumng-post-iframe';\n        iframe.height = 500;\n        src += '&iframe=1';\n        iframe.src = src;\n\n        // Function to handle iframe load.\n        window.iframe_has_loaded = (innerwin) => {\n            // Add unread class if necessary.\n            if (isUnread) {\n                innerwin.document.body.className += ' iframe-post-unread';\n            }\n            pendingPromise.resolve();\n            let pendingPromisefil = new Pending('forumng_iframe_load');\n\n            const doc = innerwin.document;\n            let counter = 0;\n\n            // Roll up edit author fieldset in edit post (do here so height correct).\n            const editemailHead = doc.getElementById('id_id_emailauthor');\n            if (editemailHead) {\n                editemailHead.className += ' collapsed';\n            }\n\n            // Check size and enlarge iframe if required.\n            const fixHeight = () => {\n                let pendingPromisefir = new Pending('forumng_iframe_resize');\n                if (doc.body.scrollHeight > Number(iframe.height)) {\n                    iframe.height = doc.body.scrollHeight + 2;\n                    iframecon.style.height = `${doc.body.scrollHeight + 2}px`;\n                    iframecon.style.overflow = 'unset';\n                }\n\n                // Check if the mobile view is activated, if so, then we align the\n                // iframe to the top left position and make it dominate the whole page,\n                // which basically make it behave like a pop-up overlay dialog.\n                //\n                // Create + set this.isMobile in the mobile theme to activate.\n                if (this.isMobile()) {\n                    iframecon.style.display = 'block';\n                    iframecon.style.width = '100%';\n                    iframecon.style.height = '100%';\n\n                    if (this.detectOS() === Common.iOS) {\n                        // Make fixed div work in iOS.\n                        iframecon.style.position = 'fixed';\n                        iframecon.style.top = '0px';\n                        iframecon.style.left = '0px';\n                        iframecon.style.zIndex = '9999';\n                        iframecon.style.overflow = 'scroll';\n                        iframecon.style.webkitOverflowScrolling = 'touch';\n                        iframe.style.position = 'relative';\n                        iframe.style.top = 'initial';\n                        iframe.style.left = 'initial';\n                    } else {\n                        iframe.style.position = 'fixed';\n                        iframe.style.top = '0px';\n                        iframe.style.left = '0px';\n                        iframe.style.zIndex = '9999';\n                    }\n                    iframe.style.height = '100%';\n                    iframe.style.width = '100%';\n                    iframe.style.overflowX = 'hidden';\n                    iframe.style.overflowY = 'auto';\n\n                    if (iframe.clientHeight >= innerwin.document.querySelector('#page').clientHeight) {\n                        // If iframe size larger than content then hide scroll.\n                        iframe.scrolling = 'no';\n                    } else {\n                        iframe.scrolling = 'auto';\n                    }\n\n                    doc.body.focus();\n                    window.scrollTo(0, 0);\n                }\n\n                counter++;\n                if (counter < 20) {\n                    // Keep resizing iframe as filemanager takes a while to initialise.\n                    setTimeout(fixHeight, 500);\n                }\n                pendingPromisefir.resolve();\n            };\n            fixHeight();\n\n            // Add cancel handler that just removes the iframe - Except Atto as autosave cancel needed.\n            doc.getElementById('id_cancel').addEventListener('click', (e) => {\n                // Check if empty text, if so close iframe (Hack to stop 'required' issue).\n                let blank = false;\n                if (innerwin.document.getElementById('id_message') &&\n                    (innerwin.document.getElementById('id_message').innerText === ''\n                        || innerwin.document.getElementById('id_message').textContent === '')) {\n                    blank = true;\n                }\n                if (!innerwin.document.querySelector('.editor_atto') || blank) {\n                    if (!e) {\n                        e = window.event;\n                    }\n                    if (e) {\n                        if (e.stopPropagation) {\n                            e.stopPropagation();\n                        } else {\n                            e.cancelBubble = true;\n                        }\n                    }\n                    removeTinyAutoSaveSession(this.isUsingTiny, 'id_message', innerwin);\n                    this.removeIframe(iframe);\n                    return false;\n                }\n            });\n\n            const draftbut = doc.getElementById('id_savedraft');\n            if (draftbut) {\n                draftbut.addEventListener('click', () => {\n                    const x = setInterval(() => {\n                        const draftexists = innerwin.document.querySelector('.forumng-draftexists');\n                        if (draftexists) {\n                            Common.scrollPage(document.querySelector('.forumng-inlineform'));\n                            clearInterval(x);\n                        }\n                    }, 500);\n                    removeTinyAutoSaveSession(this.isUsingTiny, 'id_message', innerwin);\n                });\n            }\n\n            const submit = doc.getElementById('id_submitbutton');\n            if (submit) {\n                submit.addEventListener('click', () => {\n                    removeTinyAutoSaveSession(this.isUsingTiny, 'id_message', innerwin);\n                });\n            }\n\n            // Focus the editor.\n            const tryFocus = () => {\n                const observer = new MutationObserver(() => {\n                    if (!innerwin.tinyMCE) {\n                        observer.disconnect();\n                        return;\n                    }\n                    const editor = innerwin?.tinyMCE?.activeEditor;\n\n                    if (editor?.selection) {\n                        editor.focus();\n                        observer.disconnect();\n                    }\n                });\n\n                observer.observe(doc.body, {\n                    childList: true,\n                    subtree: true\n                });\n            };\n\n            if (!this.isMobile()) {\n                setTimeout(tryFocus, 250);\n            }\n            pendingPromisefil.resolve();\n        };\n\n        // Put iframe in as last thing in post (except the 'end post' marker).\n        const ends = post.querySelectorAll('div.forumng-endpost');\n        const last = ends[ends.length - 1];\n        last.parentNode.insertBefore(iframecon, last.nextSibling);\n        iframecon.appendChild(iframe);\n\n        return iframe;\n    }\n\n    /**\n     * Initialises edit links.\n     *\n     * @param {HTMLElement} link Link node\n     * @param {number} postid Post ID to edit\n     */\n    initEdit(link, postid) {\n        link.addEventListener('click', (e) => {\n            e.preventDefault();\n            if (this.areLinksDisabled(link)) {\n                return;\n            }\n\n            // Get post.\n            const post = link.closest('.forumng-post');\n            const rootpost = !post.closest('.forumng-replies');\n\n            // Make iframe.\n            let src = `editpost.php?p=${postid}`;\n            if (this.cloneID) {\n                src += `&clone=${this.cloneID}`;\n            }\n            const iframe = this.initIframe(src, post);\n            if (!iframe) {\n                return;\n            }\n\n            // Function that gets called when the iframe has completed successfully.\n            window.iframe_success = (innerwin) => {\n                // Add item just in front of existing post, then delete existing.\n                const scriptcommands = [];\n                const newpost = this.prepareNewPost(innerwin, scriptcommands);\n\n                if (newpost.innerHTML !== '') {\n                    post.parentNode.insertBefore(newpost, post);\n                    post.parentNode.removeChild(post);\n\n                    setTimeout(() => {\n                        // Reload all the images - fixes chrome issue.\n                        /* eslint-disable no-self-assign */\n                        newpost.querySelectorAll('img').forEach(img => {\n                            img.src = img.src;\n                        });\n                    }, 100);\n\n                    // Run script commands.\n                    /* eslint-disable no-eval */\n                    scriptcommands.forEach(cmd => {\n                        eval(cmd);\n                    });\n\n                    // For discussion, do special handling.\n                    if (rootpost) {\n                        // Get subject and remove its node.\n                        const subjectinput = newpost.querySelector('input[name=discussion_subject]');\n                        const subject = subjectinput.value;\n                        subjectinput.remove();\n\n                        const discussionTitles = document.querySelectorAll('.forumng_discussion_title');\n                        discussionTitles.forEach(title => {\n                            title.innerHTML = subject;\n                        });\n\n                        const navbar = document.querySelector('#page-header .navbar ul, #page-navbar ul');\n                        if (navbar) {\n                            // Find subject inside the breadcrumb (last <span> in last <li>).\n                            const lastspan = navbar.querySelector('li:last-child > span:last-child');\n                            if (lastspan) {\n                                while (lastspan.firstChild) {\n                                    lastspan.removeChild(lastspan.firstChild);\n                                }\n                                lastspan.appendChild(document.createTextNode(' ' + subject));\n                            }\n                        }\n                    }\n\n                    // Sort out links.\n                    this.initContent(newpost);\n                }\n\n                // Remove the iframe.\n                // This needs to be placed here for mobile devices to work.\n                this.removeIframe(iframe);\n                window.iframe_success = null;\n            };\n        });\n    }\n\n    /**\n     * Extracts a new post from the result of a reply or edit script.\n     *\n     * @param {Window} innerwin Iframe window\n     * @param {Array} scriptcommands Script commands will be added to this array\n     * @return {HTMLElement} New post element\n     */\n    prepareNewPost(innerwin, scriptcommands) {\n        const responsetext = innerwin.document.body.firstChild.innerHTML;\n        const newdiv = document.createElement('div');\n        let extractedHTML = this.extractJs(responsetext, scriptcommands);\n        newdiv.innerHTML = extractedHTML;\n        const newpost = newdiv.firstElementChild;\n        newdiv.removeChild(newpost);\n        return newpost;\n    }\n\n    /**\n     * Initialises reply links.\n     *\n     * @param {HTMLElement} link Link node\n     * @param {number} replytoid Post ID to reply to\n     */\n    initReply(link, replytoid) {\n        link.addEventListener('click', (e) => {\n            e.preventDefault();\n            if (this.areLinksDisabled(link)) {\n                return;\n            }\n\n            // This function is also used when setting up a reply that includes existing draft text.\n            const draft = window.forumng_draft ? window.forumng_draft : false;\n            window.forumng_draft = null;\n\n            // Get post.\n            const post = link.closest('.forumng-post');\n\n            // Make iframe.\n            let src = 'editpost.php?';\n            if (draft) {\n                src += 'draft=' + draft.id;\n            } else {\n                src += 'replyto=' + replytoid;\n            }\n            if (this.cloneID) {\n                src += '&clone=' + this.cloneID;\n            }\n            const iframe = this.initIframe(src, post);\n            if (!iframe) {\n                return;\n            }\n\n            // Function that gets called when the iframe has completed successfully.\n            window.iframe_success = (innerwin) => {\n                // Get replies div.\n                let replies;\n                if (post.nextElementSibling && post.nextElementSibling.classList.contains('forumng-replies')) {\n                    replies = post.nextElementSibling;\n                } else {\n                    replies = document.createElement('div');\n                    replies.className = 'forumng-replies';\n                    // Insert the newly created replies div.\n                    post.parentNode.insertBefore(replies, post.nextElementSibling);\n                    this.applyStopIndents();\n                }\n\n                // Add item there.\n                const scriptcommands = [];\n                const newpost = this.prepareNewPost(innerwin, scriptcommands);\n                replies.appendChild(newpost);\n\n                // Run script commands.\n                /* eslint-disable no-eval */\n                scriptcommands.forEach(cmd => eval(cmd));\n\n                // Set up JavaScript behaviour in new post.\n                this.initContent(newpost);\n\n                // Update quota left.\n                if (this.quotaLeft > 0) {\n                    this.quotaLeft--;\n\n                    // If out of quota, kill all the reply links.\n                    if (this.quotaLeft == 0) {\n                        this.killReplyLinks();\n                    }\n                }\n\n                // Remove the iframe.\n                // This needs to be placed here for mobile devices to work.\n                this.removeIframe(iframe, false);\n                window.iframe_success = null;\n\n                // Scroll to it (must do this after frame removed or height will be incorrect).\n                Common.scrollPage(newpost, null);\n            };\n\n            // Mark that we've got a reply there.\n            iframe.replytoid = replytoid;\n\n            const quotaDiv = document.querySelector('#id_postlimit1');\n            if (quotaDiv) {\n                const quotaItem = quotaDiv.closest('.fitem');\n                if (this.quotaLeft > 2 || this.quotaLeft < 0) {\n                    quotaItem.style.display = 'none';\n                } else {\n                    quotaItem.style.display = 'block';\n                    let text = (this.quotaLeft == 1)\n                        ? this.stringList.quotaleft_singular\n                        : this.stringList.quotaleft_plural;\n                    text = text.replace('#', this.quotaLeft);\n                    quotaDiv.innerHTML = text;\n                }\n            }\n        });\n\n        // When we create the reply link that a draft post uses, make it click itself.\n        if (window.forumng_draft && window.forumng_draft.parentpostid == replytoid) {\n            setTimeout(() => {\n                Common.simulateClick(link);\n            }, 0);\n        }\n    }\n\n    /**\n     * Initialises all flag icons on the page (discussion or main page) or a post.\n     * @param {HTMLElement} node Root element\n     */\n    initFlags(node) {\n        node.querySelectorAll('div.forumng-flagpost').forEach(div => {\n            this.initFlagDiv(div);\n        });\n    }\n\n    /**\n     * Initialises a single flag icon based on the div.\n     *\n     * @param {HTMLElement} div forumng-flag div\n     */\n    initFlagDiv(div) {\n        div.anchor = div.querySelector('a');\n        div.span = div.querySelector('span');\n        // Get on state from image icon.\n        div.icon = div.querySelector('img.icon');\n        div.on = div.icon.src.match(/star\\.on/) !== null;\n\n        const handleClick = (e) => {\n            if (div.anchor.classList.contains('forumng-disabled')) {\n                return false;\n            }\n            const cfg = {\n                method: 'POST',\n                headers: {\n                    'Content-Type': 'application/json',\n                },\n            };\n            fetch(div.anchor.href + '&ajax=1', cfg)\n                .then(() => {\n                    div.on = !div.on;\n                    div.icon.src = div.icon.src.replace(/star\\.o(n|ff)/, `star.${div.on ? 'on' : 'off'}`);\n                    div.anchor.href = div.anchor.href.replace(/\\&flag=(0|1)/, `&flag=${div.on ? 0 : 1}`);\n                    div.anchor.title = div.on ? this.stringList.clearstar : this.stringList.setstar;\n                    if (div.on) {\n                        div.classList.add('starred-post');\n                    } else {\n                        div.classList.remove('starred-post');\n                    }\n                    const text = div.span.innerHTML;\n                    if (text) {\n                        div.span.innerHTML = div.on ? this.stringList.clearstar : this.stringList.starpost;\n                    }\n                })\n                .catch(() => {\n                    alert(this.stringList.jserr_alter);\n                });\n            e.preventDefault();\n        };\n\n        // Remove all other event listeners just in case this function is called multiple times.\n        div.icon.removeEventListener('click', handleClick);\n        div.anchor.addEventListener('click', handleClick);\n    }\n\n    /**\n     * Initializes the post read functionality.\n     *\n     * @param {HTMLElement} link - The link element that triggers the read action.\n     */\n    initPostread(link) {\n        link.addEventListener('click', (e) => {\n            e.preventDefault();\n            if (this.areLinksDisabled(link) || link.classList.contains('disabled')) {\n                return;\n            }\n            let pendingPromise = new Pending('forumng_postread');\n            const url = link.href + '&ajax=1';\n            const cfg = {\n                method: 'GET',\n                headers: {\n                    'Content-Type': 'application/json',\n                },\n            };\n\n            fetch(url, cfg)\n                .then(async (response) => {\n                    // Read response body text and check if word ok is in text.\n                    const text = await response.text();\n                    if (!text.includes('ok')) {\n                        alert(this.stringList.jserr_alter);\n                        pendingPromise.resolve();\n                        return;\n                    }\n                    link.classList.add('disabled');\n                    link.setAttribute('disabled', 'disabled');\n                    const post = link.closest('div.forumng-unread');\n                    if (post) {\n                        post.classList.replace('forumng-unread', 'forumng-read');\n                    }\n                    pendingPromise.resolve();\n                })\n                .catch(() => {\n                    alert(this.stringList.jserr_alter);\n                    pendingPromise.resolve();\n                });\n        });\n    }\n\n    /**\n     * Initialises the feature buttons that run along the bottom of a discussion. Some\n     * of these may use the 'post selector' feature, which requires JavaScript.\n     *\n     * Looks for some ou-specific links that are treated as the real buttons\n     *\n     * @param {boolean} islist True if discussion list\n     */\n    initFeatureButtons(islist) {\n        // Get all forms.\n        if (islist) {\n            // Feature btns on discussion list.\n            document.querySelectorAll('form.forumng-dselectorbutton input[type=submit],' +\n                ' #osep-bottombutton-export, #osep-bottombutton-print').forEach(node => {\n                // For hacked buttons do extra, inc passing original input node target.\n                if (node.tagName === 'A') {\n                    const discussions = document.querySelectorAll('.forumng-discussionlist tr');\n                    if (discussions.length == 0) {\n                        node.style.display = 'none';\n                    }\n                }\n                this.initSelectButton(node, true);\n            });\n        } else {\n            document.querySelectorAll('form.forumng-selectorbutton, #osep-bottombutton-export, #osep-bottombutton-print')\n                .forEach(node => {\n                    let submit;\n                    if (node.tagName === 'A') {\n                        submit = node;\n                    } else {\n                        submit = node.querySelector('input[type=submit]');\n                    }\n                    this.initSelectButton(submit, false);\n                });\n        }\n    }\n\n    /**\n     * Adds JS to the button which runs the selector feature, causing it to call the\n     * 'confirm' prompt to ask whether you want to do the discussion or selected posts.\n     *\n     * @param {HTMLElement} submit Submit button node\n     * @param {boolean} isList True if discussion list\n     */\n    initSelectButton(submit, isList) {\n        if (isList) {\n            // Check there are discussions to select.\n            const discussions = document.querySelectorAll('.forumng-discussionlist tr');\n            if (discussions.length == 0) {\n                submit.disabled = true;\n                return;\n            }\n            submit.addEventListener('click', (e) => {\n                e.preventDefault();\n                if (submit.tagName === 'A') {\n                    if (submit.id === 'osep-bottombutton-export') {\n                        submit = document.querySelector('.forumngfeature_export form.forumng-dselectorbutton input[type=submit]');\n                    } else if (submit.id === 'osep-bottombutton-print') {\n                        submit = document.querySelector('.forumngfeature_print form.forumng-dselectorbutton input[type=submit]');\n                    }\n                }\n\n                // Pick up any discussion types we specifically include or exclude.\n                let include = [];\n                let exclude = [];\n                const form = submit.form;\n                const includeEl = form.querySelector('input[name=include]');\n                if (includeEl) {\n                    include = includeEl.value.split(',');\n                }\n                const excludeEl = form.querySelector('input[name=exclude]');\n                if (excludeEl) {\n                    exclude = excludeEl.value.split(',');\n                }\n\n                // Pick up inputs needed from form.\n                let inputs = '';\n                let inputNodes = form.querySelectorAll('input[type=hidden]');\n                if (inputNodes.length == 0) {\n                    inputNodes = form.children[0].querySelectorAll('input[type=hidden]');\n                }\n                inputNodes.forEach(node => {\n                    inputs += `&${node.name}=${node.value}`;\n                });\n\n                this.confirm(`<h4>${submit.value}</h4><p>${this.stringList.selectordiscall}</p>`,\n                    [this.stringList.selectoralldisc, this.stringList.selectorselecteddisc],\n                    this.stringList.cancel,\n                    null, [\n                        function() {\n                            location.href = `${form.action}?all=1${this.cloneParam}${inputs}`;\n                        }.bind(this),\n                        function() {\n                            let discussionoptions = {\n                                'cloneID': this.cloneID,\n                                'stringList': this.stringList,\n                                'select': this.select,\n                            };\n                            let selectDiscussion = new SelectDiscussion(discussionoptions);\n                            if (!document.querySelector('div.forumng-main > form')) {\n                                selectDiscussion.selectDiscussInit(submit, include, exclude);\n                            }\n                        }.bind(this)\n                    ]);\n            });\n            return;\n        }\n        submit.addEventListener('click', (e) => {\n            e.preventDefault();\n            if (submit.tagName === 'A') {\n                if (submit.id === 'osep-bottombutton-export') {\n                    submit = document.querySelector('.forumngfeature_dis_export form.forumng-selectorbutton input[type=submit]');\n                } else if (submit.id === 'osep-bottombutton-print') {\n                    submit = document.querySelector('.forumngfeature_dis_print form.forumng-selectorbutton input[type=submit]');\n                }\n            }\n\n            this.confirm(`<h4>${submit.value}</h4><p>${this.stringList.selectorall}</p>`,\n                [this.stringList.discussion, this.stringList.selectedposts],\n                this.stringList.cancel,\n                null, [\n                    function() {\n                        location.href = `${submit.form.action}?d=${this.discussionID}${this.cloneParam}&all=1`;\n                    }.bind(this),\n                    function() {\n                        if (document.querySelector('div.forumng-selectbuttons')) {\n                            this.selectInit(null);\n                        }\n                        this.selectInit(submit);\n                    }.bind(this),\n                ]);\n        });\n    }\n\n    /**\n     * Stops indent from increasing once it gets past a certain minimum-post-width limit (this\n     * varies depending on browser size). Without this, discussions with a lot of nesting levels\n     * were getting ridiculous indent so that the actual posts were one word wide.\n     *\n     */\n    applyStopIndents() {\n        // Pick max indent level.\n        const region = Common.getElementScreenPosition(document.getElementById('forumng-main'));\n        const width = region.right - region.left;\n        const isMobile = window.matchMedia('(max-width: 767px)').matches;\n        // Min size at which the editor still looks ok.\n        const minWidth = isMobile ? 256 : 550;\n        const maxIndentPixels = width - minWidth;\n        // This can't go lower than 1, otherwise the indentation never stops.\n        let stopIndent = 1;\n\n        if (isMobile) {\n            // All indents are 6px at this width.\n            if (maxIndentPixels > 6) {\n                stopIndent = Math.floor(maxIndentPixels / 6);\n            }\n        } else {\n            // There are 5 indents of 40px then 5 of 30px, then all 20px.\n            if (maxIndentPixels > 350) {\n                stopIndent = 10 + Math.floor((maxIndentPixels - 350) / 20);\n            } else if (maxIndentPixels > 200) {\n                stopIndent = 5 + Math.floor((maxIndentPixels - 200) / 30);\n            } else if (maxIndentPixels >= 40) {\n                stopIndent = Math.floor(maxIndentPixels / 40);\n            }\n        }\n\n        // Fix indents for all tags.\n        document.querySelectorAll('div.forumng-replies').forEach(reply => {\n            const indent = this.getReplyIndent(reply);\n            if (indent == stopIndent) {\n                reply.classList.add('forumng-stop-indent');\n            } else {\n                reply.classList.remove('forumng-stop-indent');\n            }\n        });\n    }\n\n    /**\n     * Obtains indent level of a reply (i.e. how many levels it is indented by).\n     * @param {HTMLElement} reply Reply div\n     *\n     * @returns {number} Indent level\n     */\n    getReplyIndent(reply) {\n        // Use cached indent count if available.\n        if (reply.forumng_indent) {\n            return reply.forumng_indent;\n        }\n\n        let indent = 1;\n        // Go through each parent to find its nesting.\n        let ancestor = reply.parentElement;\n\n        while (ancestor && ancestor !== document.documentElement) {\n            if (ancestor.classList.contains('forumng-replies')) {\n                indent += 1;\n                ancestor = ancestor.parentElement;\n            } else {\n                ancestor = ancestor.parentElement;\n            }\n        }\n\n        reply.forumng_indent = indent;\n        return indent;\n    }\n\n    /**\n     * Checks if links are disabled including a particular link.\n     *\n     * @param {HTMLElement} link Element pointing to link\n     * @returns {boolean} True if links are disabled, false otherwise\n     */\n    areLinksDisabled(link) {\n        // True if links are disabled either at body or commands level.\n        return document.body.linksdisabled ||\n            link.closest('.forumng-commands').linksdisabled;\n    }\n\n    /**\n     * Deeply clones an object or array and changes the 'itemid' property to a new value.\n     *\n     * @param {Object|Array} obj Object or array to clone and modify\n     * @param {string} itemid New value for 'itemid' property\n     * @returns {Object|Array} Cloned object or array with modified 'itemid' properties\n     */\n    deepCloneChangeItemid(obj, itemid) {\n        if (Array.isArray(obj)) {\n            var c = [];\n        } else {\n            var c = {};\n        }\n\n        for (let key in obj) {\n            if (Object.prototype.hasOwnProperty.call(obj, key)) {\n                if (key == 'itemid') {\n                    c[key] = itemid;\n                } else if (typeof obj[key] == 'object' && obj[key] !== null) {\n                    c[key] = this.deepCloneChangeItemid(obj[key], itemid);\n                } else {\n                    c[key] = obj[key];\n                }\n            }\n        }\n\n        return c;\n    }\n\n    /**\n     * Calls a function multiple times using setTimeout to avoid stack overflow.\n     *\n     * @param {Function} fn The function to call\n     * @param {number} count The number of times to call the function\n     */\n    setTimeoutMulti(fn, count) {\n        if (count > 0) {\n            setTimeout(() => {\n                this.setTimeoutMulti(fn, count - 1);\n            }, 0);\n        } else {\n            fn();\n        }\n    }\n\n    /**\n     * Initializes the 'parent' links so that when tabbed to, the parent div/text displays.\n     *\n     * @param {HTMLElement} link Link node\n     */\n    initParentLink(link) {\n        link.addEventListener('focus', () => {\n            link.parentNode.style.position = 'static';\n        });\n\n        link.addEventListener('blur', () => {\n            link.parentNode.style.position = 'absolute';\n        });\n    }\n\n    /**\n     * Initializes an expand link so that it can use AJAX to retrieve the message.\n     *\n     * @param {HTMLElement} link Link node\n     * @param {number} postid Post ID\n     * @param {boolean} expandNow If true, expand this post immediately\n     */\n    initExpand(link, postid, expandNow) {\n        link.post = link.closest('.forumng-post');\n        link.post.expandLink = link;\n        link.loader = link.nextElementSibling;\n        while (link.loader && link.loader.nodeName.toLowerCase() !== 'img') {\n            link.loader = link.loader.nextElementSibling;\n        }\n        if (link.loader) {\n            link.loader.originalSrc = link.loader.src;\n        }\n        link.postid = postid;\n        link.delay = true;\n\n        this.processLinkRetrieveMessage(link);\n\n        // Automatically expand message listed in URL (if any).\n        if (expandNow) {\n            link.delay = false;\n            Common.simulateClick(link);\n        }\n    }\n\n    /**\n     * Processes link hashtag URL to retrieve the message when you expand the post.\n     *\n     * @param {object} link Link node\n     * @param {boolean} expandNow If true, expand this post immediately\n     */\n    processLinkRetrieveMessage(link, expandNow = true) {\n        // Replace 'expand/collapse all' text with 'expand/collapse'.\n        const postNum = link.post.className.replace(/^.*forumng-p([0-9]+).*$/, '$1');\n\n        const text = expandNow ? link.querySelector('.forumng-expandtext') : link.querySelector('.forumng-collapsetext');\n        if (text && expandNow) {\n            text.innerHTML = this.stringList.expand.replace('#', postNum);\n        }\n        if (text && !expandNow) {\n            text.innerHTML = this.stringList.collapse.replace('#', postNum);\n        }\n\n        // Add to post number to alt when using an image in expand link (expand_text lang string).\n        const linkImg = link.querySelector('img.fng-eai');\n        if (linkImg) {\n            linkImg.alt = `${linkImg.alt} ${postNum}`;\n        }\n\n        link.addEventListener('click', (e) => {\n            e.preventDefault();\n            if (link.inProcess) {\n                return;\n            }\n            link.post.focushandler = null;\n\n            const data = `p=${link.postid}${this.cloneParam}&short=${expandNow ? 'true' : 'false'}`;\n            const url = `${Config.wwwroot}/mod/forumng/expandpost.php`;\n\n            const cfg = {\n                method: 'GET',\n                headers: {\n                    'Content-Type': 'application/json'\n                },\n            };\n\n            fetch(url + '?' + data, cfg)\n                .then(response => response.text())\n                .then(text => {\n                    this.expandOk(link, {responseText: text});\n                })\n                .catch(() => {\n                    this.expandError(link);\n                });\n\n            if (link.loader) {\n                link.loader.src = this.loaderPix;\n            }\n            link.inProcess = true;\n        });\n    }\n\n    /**\n     * Initializes a collapse link so that it can use AJAX to retrieve the message.\n     *\n     * @param {HTMLElement} link Link node\n     * @param {number} postid Post ID\n     */\n    initCollapse(link, postid) {\n        link.post = link.closest('.forumng-post');\n        link.loader = link.nextElementSibling;\n        while (link.loader && link.loader.nodeName.toLowerCase() !== 'img') {\n            link.loader = link.loader.nextElementSibling;\n        }\n        if (link.loader) {\n            link.loader.originalsrc = link.loader.src;\n        }\n        link.postid = postid;\n        link.delay = true;\n\n        this.processLinkRetrieveMessage(link, false);\n    }\n\n    /**\n     * Some browsers cannot execute JavaScript just by inserting script tags.\n     * To avoid that problem, remove all script tags from the given content,\n     * and run them later.\n     *\n     * @param {string} text HTML content\n     * @param {Array} scriptCommands Array of commands (the commands will be pushed\n     *   into this)\n     * @return {string} New text with JS removed\n     */\n    extractJs(text, scriptCommands) {\n        const scriptRegexp = /<script[^>]*>([\\s\\S]*?)<\\/script>/g;\n\n        let result;\n        while ((result = scriptRegexp.exec(text)) !== null) {\n            scriptCommands.push(result[1]);\n        }\n\n        return text.replace(scriptRegexp, '');\n    }\n\n    /**\n     * AJAX response: Expand completes successfully.\n     *\n     * @param {object} link Link node\n     * @param {object} o YUI response object\n     */\n    expandOk(link, o) {\n        const newDiv = document.createElement('div');\n        const scriptCommands = [];\n        newDiv.innerHTML = this.extractJs(o.responseText, scriptCommands);\n        let newpost = newDiv.firstChild;\n        newDiv.removeChild(newpost);\n        const focushandler = link.post.focushandler;\n\n        // If in select mode, note previous selection value.\n        let previousSelect = false;\n        if (this.select.on) {\n            previousSelect = document.querySelector(`#checkp${link.postid}`).checked;\n        }\n\n        const expander = new Expander(link.post);\n        const linkPostParent = link.post.parentNode;\n        if (linkPostParent) {\n            linkPostParent.insertBefore(newpost, link.post);\n        }\n        link.post.remove();\n\n        // Run script commands.\n        /* eslint-disable no-eval */\n        scriptCommands.forEach(cmd => eval(cmd));\n\n        this.initContent(newpost);\n        if (previousSelect) {\n            const checkbox = document.querySelector(`#checkp${link.postid}`);\n            checkbox.checked = true;\n        }\n        if (document.body.linksdisabled) {\n            Common.linksDisable(newpost);\n            // It is not individually disabled, only as part of the general disable, so remove\n            // the individual marker.\n            newpost.linksdisabled = false;\n        }\n\n        const tracker = document.querySelector('#expanded_posts');\n        tracker.value = `${tracker.value}${tracker.value == '' ? '' : ','}${link.postid}`;\n\n        // For core ratings, init js on expand.\n        if (newpost.querySelector('.forumng-ratings-standard')) {\n            Rating.initRating(link.postid);\n            Rating.initPopup(link.postid);\n        }\n\n        if (!link.delay) {\n            // Skip the expanding animation.\n            return;\n        }\n\n        expander.go(newpost);\n\n        if (focushandler) {\n            focushandler();\n        } else {\n            // Replace focus on expand element which got wiped.\n            const authorSpan = newpost.querySelectorAll('span.forumng-author');\n            if (authorSpan.length > 0) {\n                // By default, focus on author name link.\n                // The timeout here is because otherwise IE7 sometimes crashes.\n                setTimeout(() => {\n                    authorSpan[0].firstChild.focus();\n                }, 0);\n            } else {\n                // If author name link is not present, focus on first link (which is usually\n                // the 'this is post 3, parent is post N' link).\n                const links = newpost.querySelectorAll('a[href]');\n                if (links.length > 0) {\n                    links[0].focus();\n                }\n            }\n        }\n    }\n\n    /**\n     * AJAX response: Expand fails.\n     *\n     * @param {HTMLElement} link Link node\n     */\n    expandError(link) {\n        link.inProcess = false;\n        link.loader.src = link.loader.originalsrc;\n        alert(this.stringList.jserr_load);\n    }\n\n    /**\n     * Initialises a 'jump' link (next unread).\n     * @param {HTMLElement} link Link node\n     */\n    initJumpLink(link) {\n        link.addEventListener('mousedown', () => {\n            this.mouseUser = true;\n        });\n\n        link.addEventListener('click', (e) => {\n            e.preventDefault();\n            const id = link.getAttribute('href').split('#')[1];\n\n            // Function to set up focus.\n            const focuser = () => {\n                const targetPost = document.querySelector(`#${id}`).parentNode;\n                const jumpTo = targetPost.querySelector('.forumng-jumpto');\n                if (this.mouseUser && jumpTo) {\n                    // For mouse (~= visual) users, focus the next link so that after\n                    // clicking the first time, they can then repeatedly press return.\n                    const equivalent = jumpTo.querySelector(`a.${link.className}`);\n                    if (equivalent) {\n                        this.focus(equivalent);\n                    } else {\n                        const prev = jumpTo.querySelector('a.forumng-prev');\n                        const next = jumpTo.querySelector('a.forumng-next');\n                        if (prev || next) {\n                            this.focus(prev ? prev : next);\n                        } else {\n                            this.focus(jumpTo.querySelector('a'));\n                        }\n                    }\n                } else {\n                    // For keyboard-only users, go to the start of the post (makes more sense).\n                    const author = targetPost.querySelector('.forumng-author');\n                    this.focus(author.querySelector('a'));\n                }\n            };\n\n            // Get link target and expand it if required.\n            const targetPost2 = document.querySelector(`#${id}`).parentNode;\n            if (targetPost2.expandLink) {\n                Common.simulateClick(targetPost2.expandLink);\n                targetPost2.focushandler = focuser;\n            }\n\n            const targetPost3 = document.querySelector(`#${id}`).parentNode;\n            // If post has already been expanded, focus it now.\n            if (!targetPost3.focushandler) {\n                focuser();\n            }\n\n            // Scroll to it.\n            Common.scrollPage(targetPost2);\n        });\n    }\n\n    /**\n     * Focuses the given node (after timeout).\n     * @param {HTMLElement} x Node to focus\n     */\n    focus(x) {\n        setTimeout(() => {\n            x.focus();\n        }, 0);\n    }\n\n    /**\n     * Initialises a delete link.\n     *\n     * @param {HTMLElement} link Link node\n     * @param {string} postId Post ID\n     * @param {boolean} undelete True if it's actually undelete\n     * @param {string} currentUser The current user\n     */\n    initDelete(link, postId, undelete, currentUser) {\n        link.postId = postId;\n        link.post = link.closest('.forumng-post');\n        link.addEventListener('click', (e) => {\n            e.preventDefault();\n            if (this.areLinksDisabled(link)) {\n                return;\n            }\n            const url = `${Config.wwwroot}/mod/forumng/deletepost.php`;\n            const data = `p=${link.postId}${this.cloneParam}&delete=${undelete ? 0 : 1}&ajax=1`;\n            const deleteAndEmail = () => {\n                window.location = url + `?p=${link.postId}${this.cloneParam}&delete=1&ajax=1&email=1`;\n            };\n            const deleteOnly = () => {\n                const cfg = {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json'\n                    },\n                };\n                fetch(url + '?' + data, cfg)\n                    .then(response => response.text())\n                    .then(text => {\n                        this.deleteOk(link, {responseText: text});\n                    })\n                    .catch(() => {\n                        this.deleteError(link);\n                    });\n                Common.linksDisable(link.post);\n                link.loader = document.createElement('img');\n                link.loader.alt = '';\n                link.loader.src = this.loaderPix;\n                link.loader.style.position = 'absolute';\n                link.parentNode.appendChild(link.loader);\n                const linkRegion = Common.getElementScreenPosition(link);\n                link.loader.style.left = `${linkRegion.right + 3}px`;\n                link.loader.style.top = `${linkRegion.top}px`;\n            };\n\n            const deleteButtons = currentUser\n                ? [this.stringList.deletepostbutton]\n                : [this.stringList.deleteemailpostbutton, this.stringList.deletepostbutton];\n\n            const deleteOptions = currentUser\n                ? [deleteOnly, '']\n                : [deleteAndEmail, deleteOnly, ''];\n\n            this.confirm(\n                undelete ? this.stringList.confirmundelete : this.stringList.confirmdelete,\n                undelete ? this.stringList.undeletepostbutton : deleteButtons,\n                this.stringList.cancel, link.post,\n                undelete ? deleteOnly : deleteOptions\n            );\n        });\n    }\n\n    /**\n     * AJAX response: Delete completes OK / Set rating completes OK.\n     *\n     * @param {Object} link Link (for delete) or div (for rating), which contains a '.post' variable\n     * @param {Object} response Response object\n     *   for the post object\n     */\n    deleteOk(link, response) {\n        const newDiv = document.createElement('div');\n        newDiv.innerHTML = response.responseText;\n        let newPost = newDiv.firstChild;\n\n        // Post may be blank when deleting (if not admin).\n        if (newPost) {\n            link.post.parentNode.insertBefore(newPost, link.post);\n        }\n\n        Common.linksEnable(link.post);\n        link.post.remove();\n\n        if (newPost) {\n            this.initContent(newPost);\n        }\n    }\n\n    /**\n     * AJAX response: Delete fails / Set rating fails.\n     *\n     * @param {Object} link Link (for delete), which contains a '.post' variable\n     *   for the post object\n     */\n    deleteError(link) {\n        if (link.loader) {\n            link.loader.remove();\n        }\n        Common.linksEnable(link.post);\n        alert(this.stringList.jserr_alter);\n    }\n\n\n    /**\n     * Displays a fancy dialog box on a faded-out background in the middle of the\n     * screen.\n     * @param {string} message Message to display (may include html; if heading is included,\n     *     we recommend h4)\n     * @param {string} actionText Name for action button(s). May be a single string or\n     *     array if you need multiple buttons\n     * @param {string} cancelText Name for cancel button\n     * @param {HTMLElement} highlight HTML element that should be highlighted (with an orange\n     *     box), used e.g. to indicate which post is being deleted\n     * @param {function} action Function that gets run if user clicks the action button\n     *     (if there are multiple action buttons, this too must be an array)\n     */\n    confirm(message, actionText, cancelText, highlight, action) {\n        if (typeof actionText == 'string') {\n            // There is only one action (text and functions); make it look like an array.\n            actionText = [actionText];\n            action = [action];\n        }\n\n        const fadePanel = document.createElement('div');\n        fadePanel.classList.add('forumng-fadepanel');\n        document.body.appendChild(fadePanel);\n        fadePanel.style.position = 'absolute';\n        fadePanel.style.top = '0';\n        fadePanel.style.left = '0';\n        fadePanel.style.width = Common.getDocWidth() + 'px';\n        fadePanel.style.height = Common.getDocHeight() + 'px';\n        fadePanel.style.zIndex = 10;\n\n        fadePanel.style.opacity = 0.0;\n        // Animate to 0.5 opacity over 250ms with linear easing.\n        this.animateOpacity(fadePanel, 0.0, 0.5, 250, this.linearEasing);\n\n        // Handle highlight element.\n        let highlightDiv = null;\n        if (highlight) {\n            const highlightRegion = Common.getElementScreenPosition(highlight);\n\n            highlightDiv = document.createElement('div');\n            highlightDiv.classList.add('forumng-highlightbox');\n            document.body.appendChild(highlightDiv);\n\n            highlightDiv.style.position = 'absolute';\n            highlightDiv.style.top = highlightRegion.top + 'px';\n            highlightDiv.style.left = highlightRegion.left + 'px';\n            highlightDiv.style.zIndex = 15;\n\n            const height = highlightRegion.bottom - highlightRegion.top -\n                Common.removePX(window.getComputedStyle(highlightDiv).borderTopWidth) -\n                Common.removePX(window.getComputedStyle(highlightDiv).borderBottomWidth) -\n                Common.removePX(window.getComputedStyle(highlightDiv).paddingTop) -\n                Common.removePX(window.getComputedStyle(highlightDiv).paddingBottom);\n            const width = highlightRegion.right - highlightRegion.left -\n                Common.removePX(window.getComputedStyle(highlightDiv).borderLeftWidth) -\n                Common.removePX(window.getComputedStyle(highlightDiv).borderRightWidth) -\n                Common.removePX(window.getComputedStyle(highlightDiv).paddingLeft) -\n                Common.removePX(window.getComputedStyle(highlightDiv).paddingRight);\n\n            highlightDiv.style.height = height + 'px';\n            highlightDiv.style.width = width + 'px';\n        }\n\n        // Create dialog element.\n        const dialog = document.createElement('div');\n        dialog.classList.add('forumng-confirmdialog');\n        document.body.appendChild(dialog);\n\n        // Set dialog position.\n        dialog.style.position = 'absolute';\n        dialog.style.zIndex = 20;\n\n        // Get viewport dimensions.\n        const region = Common.getViewportRegion();\n\n        region.height = region.bottom - region.top;\n        region.width = region.right - region.left;\n\n        dialog.style.top = (region.top + region.height / 3) + 'px';\n\n        // Set dialog width based on window size.\n        const page = Common.getElementScreenPosition(document.getElementById('page'));\n        const pixelsWidth = page.right - page.left;\n        let leftAdjuster = 0;\n        let requiredBoxWidth = 630;\n        if (pixelsWidth < 700) {\n            requiredBoxWidth = pixelsWidth - 40;\n            leftAdjuster = 5;\n        }\n        dialog.style.width = (requiredBoxWidth - 10) + 'px';\n\n        let leftValue = region.left + region.width / 2 - (requiredBoxWidth / 2) - leftAdjuster;\n        // Ensure left position is not negative.\n        leftValue = Math.max(leftValue, 0);\n        dialog.style.left = leftValue + 'px';\n\n        const messageDiv = document.createElement('div');\n        messageDiv.classList.add('forumng-message');\n        messageDiv.tabIndex = -1;\n        messageDiv.innerHTML = message;\n        dialog.appendChild(messageDiv);\n\n        const buttonDiv = document.createElement('div');\n        buttonDiv.className = 'forumng-buttons';\n        dialog.appendChild(buttonDiv);\n\n        const cancel = document.createElement('input');\n        cancel.type = 'button';\n        cancel.value = cancelText;\n        cancel.addEventListener('click', () => {\n            dialog.remove();\n            fadePanel.remove();\n            if (highlightDiv) {\n                highlightDiv.remove();\n            }\n        });\n\n        for (var i = 0; i < actionText.length; i++) {\n            buttonDiv.appendChild(this.confirmMakeButton(actionText[i], action[i], cancel, false));\n        }\n\n        this.focus(messageDiv);\n        buttonDiv.appendChild(cancel);\n    }\n\n    /**\n     * Makes a button for the confirm dialog.\n     *\n     * @param {string} actionText - Text\n     * @param {function} action - Function to call if button is clicked\n     * @param {HTMLElement} cancel - Cancel button (which is automatically clicked before calling action)\n     * @param {boolean} focus - True if this should be focused\n     * @returns {HTMLInputElement} - The created button element\n     */\n    confirmMakeButton(actionText, action, cancel, focus) {\n        const yes = document.createElement('input');\n        yes.type = 'button';\n        yes.value = actionText;\n\n        yes.addEventListener('click', () => {\n            Common.simulateClick(cancel);\n            action();\n        });\n\n        if (focus) {\n            yes.focus();\n        }\n\n        return yes;\n    }\n\n    /**\n     * Logs data using the console if available.\n     *\n     * @param {string} thing Thing to log\n     */\n    log(thing) {\n        if (typeof console !== 'undefined') {\n            window.console.debug(thing);\n        }\n    }\n\n    /**\n     * Initialises forum main page JavaScript.\n     *\n     */\n    initView() {\n        // Set the focus on the sort links when clicked.\n        this.focusSortLinks();\n\n        // Set up all the draft links to use discuss.php instead of non-JS version.\n        document.querySelectorAll('.forumng-main a').forEach(link => {\n            const match = link.className.match(/^forumng-draftreply-([0-9]+)-([0-9]+)$/);\n            if (match) {\n                const linkMatch = link.href.match(/draft=([0-9]+)(&clone=[0-9]+)?$/);\n                if (linkMatch) {\n                    link.href = `discuss.php?d=${match[1]}${this.cloneParam}&draft=${linkMatch[1]}#p${match[2]}`;\n                }\n            }\n        });\n\n        // Set up flag icons.\n        this.initFlags(document.body);\n\n        // Change selected buttons into links with text in brackets.\n        document.querySelectorAll('input.forumng-button-to-link').forEach(button => {\n            this.turnButtonIntoLink(button);\n        });\n\n        // Init feature buttons.\n        this.initFeatureButtons(true);\n    }\n\n    /**\n     * Focuses sort links after reloading page when a sort link was clicked.\n     */\n    focusSortLinks() {\n        const url = window.location.href;\n        const searchIndex = url.search(/&sortlink=/);\n        if (searchIndex !== -1) {\n            const sortLinkId = \"sortlink_\" + url.substr(searchIndex + 10, 1);\n            this.focus(document.querySelector('#' + sortLinkId));\n        }\n    }\n\n    /**\n     * On the main page, turns a button into a link with text in brackets (this is we\n     * can have commands which are POST requests but look like links).\n     *\n     * @param {HTMLElement} button Button node\n     */\n    turnButtonIntoLink(button) {\n        const span = document.createElement('span');\n        span.appendChild(document.createTextNode('('));\n        const link = document.createElement('a');\n        link.appendChild(document.createTextNode(button.value));\n        link.href = '#';\n        link.addEventListener('click', (e) => {\n            e.preventDefault();\n            Common.simulateClick(button);\n        });\n        span.appendChild(link);\n        span.appendChild(document.createTextNode(') '));\n        button.parentNode.insertBefore(span, button);\n        button.style.display = 'none';\n    }\n\n    /**\n     * Initialises the post selector feature, switching the whole page into post select mode.\n     *\n     * @param {HTMLElement|null} target Target button that indicates where the resulting selection will be posted,\n     *   or null to cancel select mode\n     */\n    selectInit(target) {\n        this.select.on = target ? true : false;\n\n        const posts = document.querySelectorAll('div.forumng-post');\n        const confirm = document.createElement('input');\n        confirm.setAttribute('type', 'submit');\n\n        const extraneousDisplay = this.select.on ? 'none' : 'block';\n        document.querySelector('#forumng-expandall').style.display = extraneousDisplay;\n        document.querySelector('#forumng-features').style.display = extraneousDisplay;\n        const subscribeOptions = document.querySelector('#forumng-subscribe-options');\n        if (subscribeOptions) {\n            subscribeOptions.style.display = extraneousDisplay;\n        }\n\n        const main = document.querySelector('#forumng-main');\n        const all = document.createElement('input');\n        const none = document.createElement('input');\n        if (this.select.on) {\n            // Make form around main elements.\n            const form = document.createElement('form');\n            this.select.form = form;\n            form.setAttribute('method', 'post');\n            form.setAttribute('action', target.form.action);\n            main.classList.add('forumng-selectmode');\n\n            form.inputs = document.createElement('div');\n            form.appendChild(form.inputs);\n            let field = document.createElement('input');\n            field.setAttribute('type', 'hidden');\n            field.setAttribute('name', 'd');\n            field.setAttribute('value', this.discussionID);\n            form.inputs.appendChild(field);\n            field = document.createElement('input');\n            field.setAttribute('type', 'hidden');\n            field.setAttribute('name', 'fromselect');\n            field.setAttribute('value', '1');\n            form.inputs.appendChild(field);\n            if (this.cloneID) {\n                field = document.createElement('input');\n                field.setAttribute('type', 'hidden');\n                field.setAttribute('name', 'clone');\n                field.setAttribute('value', this.cloneID);\n                form.inputs.appendChild(field);\n            }\n\n            // Make intro.\n            form.intro = document.createElement('div');\n            form.intro.classList.add('forumng-selectintro');\n            main.parentNode.insertBefore(form.intro, main);\n            const introText = document.createElement('p');\n            introText.innerHTML = this.stringList.selectintro;\n            form.intro.appendChild(introText);\n\n            // Make buttons to select all/none.\n            const selectButtons = document.createElement('div');\n            selectButtons.classList.add('forumng-selectbuttons');\n            form.intro.appendChild(selectButtons);\n\n            all.setAttribute('type', 'button');\n            all.setAttribute('value', this.stringList.selectall);\n            selectButtons.appendChild(all);\n            all.addEventListener('click', () => {\n                const posts = document.querySelectorAll('div.forumng-post');\n                posts.forEach(post => {\n                    if (!post.check.checked) {\n                        Common.simulateClick(post.check);\n                    }\n                });\n                all.disabled = true;\n                none.disabled = false;\n            });\n            selectButtons.appendChild(document.createTextNode(' '));\n\n\n            none.setAttribute('type', 'button');\n            none.setAttribute('value', this.stringList.deselectall);\n            selectButtons.appendChild(none);\n            none.addEventListener('click', () => {\n                const posts = document.querySelectorAll('div.forumng-post');\n                posts.forEach(post => {\n                    if (post.check.checked) {\n                        Common.simulateClick(post.check);\n                    }\n                });\n                all.disabled = false;\n                none.disabled = true;\n            });\n\n            main.appendChild(form);\n\n            // Make outro.\n            form.outro = document.createElement('div');\n            form.outro.classList.add('forumng-selectoutro');\n            form.appendChild(form.outro);\n\n            confirm.setAttribute('value', this.stringList.confirmselection);\n            form.outro.appendChild(confirm);\n\n            form.outro.appendChild(document.createTextNode(' '));\n\n            const cancel = document.createElement('input');\n            cancel.setAttribute('type', 'button');\n            cancel.setAttribute('id', 'forumng-cancel-select');\n            cancel.setAttribute('value', this.stringList.cancel);\n            form.outro.appendChild(cancel);\n            cancel.addEventListener('click', () => {\n                this.selectInit(null);\n            });\n\n            Common.scrollPage(form.intro, null);\n        } else {\n            const form = this.select.form;\n            form.remove();\n            form.intro.remove();\n            form.outro.remove();\n            main.classList.remove('forumng-selectmode');\n            this.select.form = null;\n        }\n\n        window.forumng_select_changed = () => {\n            const posts = document.querySelectorAll('div.forumng-post');\n            let ok = false;\n            let checkcount = 0;\n            posts.forEach(post => {\n                if (post.check.checked) {\n                    ok = true;\n                    checkcount++;\n                }\n            });\n            none.disabled = !ok;\n            confirm.disabled = !ok;\n            all.disabled = checkcount == posts.length;\n        };\n\n        posts.forEach(post => {\n            this.selectInitPost(post, this.select.on);\n        });\n\n        if (this.select.on) {\n            window.forumng_select_changed();\n        }\n    }\n\n\n    /**\n     * Initialises a single post within select mode.\n     *\n     * @param {HTMLElement} post Post div\n     * @param {boolean} on True if select is being turned on, false if it's being turned off\n     */\n    selectInitPost(post, on) {\n        if (on) {\n            const info = post.querySelector('div.forumng-info');\n            if (!info) {\n                return;\n            }\n            const span = document.createElement('span');\n            const spanSeparator = document.createElement('span');\n            span.appendChild(spanSeparator);\n            spanSeparator.classList.add('forumng-separator');\n            spanSeparator.textContent = ' \\u2022 ';\n            info.appendChild(span);\n            post.extraSpan = span;\n            post.classList.add('forumng-deselected');\n            const postid = post.querySelector(':scope > a').id;\n\n            const check = document.createElement('input');\n            check.setAttribute('type', 'checkbox');\n            check.id = 'check' + postid;\n            post.check = check;\n            span.appendChild(check);\n\n            const label = document.createElement('label');\n            label.classList.add('accesshide');\n            label.setAttribute('for', check.id);\n            label.textContent = this.stringList.selectlabel;\n            span.appendChild(label);\n\n            Common.linksDisable(document.body);\n\n            let hidden = document.querySelector(\"input[name='select\" + postid + \"']\");\n            if (!hidden) {\n                hidden = document.createElement('input');\n                hidden.setAttribute('type', 'hidden');\n                hidden.setAttribute('value', '0');\n                hidden.setAttribute('name', 'select' + postid);\n                this.select.form.appendChild(hidden);\n            }\n            post.forumng_hidden = hidden;\n\n            check.addEventListener('click', () => {\n                if (check.checked) {\n                    post.classList.remove('forumng-deselected');\n                    post.forumng_hidden.value = 1;\n                } else {\n                    post.classList.add('forumng-deselected');\n                    post.forumng_hidden.value = 0;\n                }\n                window.forumng_select_changed();\n            });\n        } else {\n            if (post.extraSpan) {\n                post.extraSpan.remove();\n            }\n            post.classList.remove('forumng-deselected');\n            Common.linksEnable(document.body);\n        }\n    }\n\n    /**\n     * Sets up certain selects (currently just the 'Move discussion' one) so that their\n     * accompanying button is disabled when the select is set to 0.\n     *\n     * @param {HTMLElement} submit Submit button that goes with select\n     */\n    zeroDisable(submit) {\n        // Assuming submit is an HTMLInputElement.\n        const select = submit.previousElementSibling;\n        if (!select || select.nodeName.toLowerCase() !== 'select') {\n            this.log('Warning: Zero-disable feature incorrectly applied.');\n            return;\n        }\n\n        const update = () => {\n            if (submit.classList.contains('forumng-zero-disable')) {\n                submit.disabled = select.value == 0;\n            }\n        };\n\n        update();\n        select.addEventListener('change', update);\n    }\n\n    /**\n     * Asks browser to print the page.\n     */\n    printPage() {\n        window.print();\n    }\n\n    /**\n     * Initialises the subscriber list page JavaScript.\n     *\n     */\n    initSubscribers() {\n        const buttonsDiv = document.getElementById('forumng-buttons');\n        const selectAll = document.createElement('input');\n        selectAll.type = 'button';\n        selectAll.value = this.stringList.selectall;\n        buttonsDiv.appendChild(document.createTextNode(' '));\n        buttonsDiv.appendChild(selectAll);\n\n        const deselectAll = document.createElement('input');\n        deselectAll.type = 'button';\n        deselectAll.value = this.stringList.deselectall;\n        buttonsDiv.appendChild(document.createTextNode(' '));\n        buttonsDiv.appendChild(deselectAll);\n\n        let unsubscribe;\n        const inputs = document.getElementById('forumng-subscription-list').querySelectorAll('input');\n        const all = [];\n\n        for (const input of inputs) {\n            if (input.name.startsWith('user')) {\n                all.push(input);\n            } else if (input.name == 'unsubscribe') {\n                unsubscribe = input;\n            }\n        }\n\n        const update = () => {\n            let allSelected = true;\n            let noneSelected = true;\n\n            for (const item of all) {\n                if (item.checked) {\n                    noneSelected = false;\n                } else {\n                    allSelected = false;\n                }\n            }\n\n            selectAll.disabled = allSelected;\n            deselectAll.disabled = noneSelected;\n            unsubscribe.disabled = noneSelected;\n        };\n\n        update();\n\n        all.forEach((item) => item.addEventListener('click', update));\n\n        selectAll.addEventListener('click', () => {\n            all.forEach((item) => {\n                item.checked = true;\n            });\n            update();\n        });\n\n        deselectAll.addEventListener('click', () => {\n            all.forEach((item) => {\n                item.checked = false;\n            });\n            update();\n        });\n    }\n\n    /**\n     * Retrieves the value of a parameter from the query string of the current URL.\n     *\n     * @param {string} parameterName - The name of the parameter to retrieve.\n     * @returns {string|null} The value of the specified parameter if found, otherwise null.\n     */\n    getValueParameter(parameterName) {\n        const urlParams = new URLSearchParams(window.location.search);\n        return urlParams.get(parameterName) || null;\n    }\n\n    /**\n     * Animates the opacity of an element from a start value to an end value over a specified duration.\n     *\n     * @param {HTMLElement} element - The DOM element to animate\n     * @param {number} startOpacity - The initial opacity value\n     * @param {number} endOpacity - The target opacity value\n     * @param {number} duration - The duration of the animation in milliseconds\n     * @param {function} easingFunction - The easing function to use for the animation\n     */\n    animateOpacity(element, startOpacity, endOpacity, duration, easingFunction) {\n        let start = null;\n        const deltaOpacity = endOpacity - startOpacity;\n\n        /**\n         * A step function to perform the animation frame by frame.\n         *\n         * @param {DOMHighResTimeStamp} timestamp - The current time.\n         */\n        function step(timestamp) {\n            if (!start) {\n                start = timestamp;\n            }\n            const progress = timestamp - start;\n            const easeProgress = easingFunction(progress / duration);\n            element.style.opacity = startOpacity + deltaOpacity * easeProgress;\n\n            if (progress < duration) {\n                requestAnimationFrame(step);\n            } else {\n                element.style.opacity = endOpacity;\n            }\n        }\n\n        requestAnimationFrame(step);\n    }\n\n    /**\n     * A linear easing function.\n     *\n     * @param {number} t - The progress of the animation (a value between 0 and 1)\n     * @returns {number} - The adjusted progress\n     */\n    linearEasing(t) {\n        return t;\n    }\n}\n\n/**\n * Remove draft data from the Tiny editor, which is auto-saved according to editorID.\n *\n * In this context, we will remove the auto-save after\n * creating/editing a reply, canceling, and saving a draft.\n *\n * @param {boolean} isUsingTiny - Indicates if TinyMCE is being used.\n * @param {String} editorID The editor ID for which draft data needs to be removed.\n * @param {Object} innerWin The current window\n */\nexport const removeTinyAutoSaveSession = (isUsingTiny, editorID, innerWin = window) => {\n    // Execute this only if it's a Tiny editor.\n    if (isUsingTiny) {\n        const editor = innerWin?.tinyMCE?.get(editorID);\n        if (editor) {\n            TinyRepository.removeAutosaveSession(editor);\n        }\n    }\n};\n\n/**\n * Attaches click handlers to specific form buttons to remove the TinyMCE auto-save session.\n *\n * @param {boolean} isUsingTiny - Indicates if TinyMCE is being used.\n * @param {string} editorID - The ID of the TinyMCE editor.\n * @param {Window} [innerWin=window] - The window object to use, defaults to the global window.\n */\nexport const initButtons = (isUsingTiny, editorID, innerWin = window) => {\n    const buttonIds = ['id_submitbutton', 'id_savedraft'];\n    buttonIds.forEach((id) => {\n        const button = document.getElementById(id);\n        if (button) {\n            button.addEventListener('click', () => {\n                const pendingPromise = new Pending('mod/forumng:handle_buttons_click');\n                try {\n                    removeTinyAutoSaveSession(isUsingTiny, editorID, innerWin);\n                } finally {\n                    pendingPromise.resolve();\n                }\n            });\n        }\n    });\n};\n\n/**\n * Initialise function\n *\n * @param {object} options Options for ajax request\n */\nexport const init = (options) => {\n    const main = new Main(options);\n    main.initializer();\n};\n"],"names":["Main","cloneParam","cloneID","cmID","ratingStars","discussionID","expireLinks","select","quotaLeft","loaderPix","mouseUser","viewportWidth","starPix","nowEditing","postQuota","mainStrings","stringList","isUsingTiny","constructor","options","cmid","cloneid","ratingstars","quotaleft","loaderpix","starpix","postquota","isusingtiny","this","prepareStrings","domInit","urgentInit","requests","posts","period","Object","entries","forEach","_ref","string","value","push","fromEntries","then","fetchedStrings","Map","map","index","key","catch","Notification","exception","document","getElementById","link","initSwitchLink","initSubscribers","initView","initDiscuss","initContent","printPage","initDeletepost","newStyle","createElement","setAttribute","styleSheets","length","addRule","getElementsByTagName","appendChild","styleText","selector","createTextNode","addEventListener","parentNode","style","position","window","location","search","replace","postid","getValueParameter","hash","id","scrollIntoView","behavior","block","iscollapse","isexpand","button","querySelector","focus","forumngMain","classList","remove","div","form","insertBefore","div1","initDeldiscussion","saveall","removeChild","initFeatureButtons","applyStopIndents","region","Common","getElementScreenPosition","right","left","setInterval","width","msg","messagehtml","textContent","innerHTML","e","preventDefault","deleteButtons","deleteemailpostbutton","deletepostbutton","actionUrl","action","confirm","confirmdeletediscuss","cancel","href","node","on","contains","selectInitPost","expandposts","match","parseInt","expandedList","split","i","killReplyLinks","querySelectorAll","initExpiry","getAttribute","initExpand","initCollapse","initReply","initEdit","initDelete","initParentLink","initJumpLink","initPostread","ratings","ratingoptions","ratingins","StarDiscussion","rating","initRating","createRateButton","input","zeroDisable","initFlags","filterEvents","notifyFilterContentUpdated","newButton","rate","nextSibling","disabled","url","Config","wwwroot","data","postId","fetch","method","headers","response","text","deleteOk","responseText","deleteError","linksDisable","post","loader","byregion","top","seconds","forumngExpiryJavatime","Date","now","timerid","current","deadlink","splice","clearInterval","removeIframe","iframe","scrollToParent","parent","removeAttribute","isMobile","display","event","scrollPage","linksEnable","body","detectOS","ua","navigator","userAgent","test","androidOS","iOS","otherOS","initIframe","src","isUnread","className","includes","pendingPromise","Pending","iframecon","add","name","height","iframe_has_loaded","innerwin","resolve","pendingPromisefil","doc","counter","editemailHead","fixHeight","pendingPromisefir","scrollHeight","Number","overflow","zIndex","webkitOverflowScrolling","overflowX","overflowY","clientHeight","scrolling","scrollTo","setTimeout","blank","innerText","stopPropagation","cancelBubble","removeTinyAutoSaveSession","draftbut","x","submit","tryFocus","observer","MutationObserver","tinyMCE","disconnect","editor","_innerwin$tinyMCE","activeEditor","selection","observe","childList","subtree","ends","last","areLinksDisabled","closest","rootpost","iframe_success","scriptcommands","newpost","prepareNewPost","img","cmd","eval","subjectinput","subject","discussionTitles","title","navbar","lastspan","firstChild","responsetext","newdiv","extractedHTML","extractJs","firstElementChild","replytoid","draft","forumng_draft","replies","nextElementSibling","quotaDiv","quotaItem","quotaleft_singular","quotaleft_plural","parentpostid","simulateClick","initFlagDiv","anchor","span","icon","handleClick","clearstar","setstar","starpost","alert","jserr_alter","removeEventListener","async","islist","tagName","initSelectButton","isList","include","exclude","includeEl","excludeEl","inputs","inputNodes","children","selectordiscall","selectoralldisc","selectorselecteddisc","bind","discussionoptions","selectDiscussion","SelectDiscussion","selectDiscussInit","selectorall","discussion","selectedposts","selectInit","matchMedia","matches","maxIndentPixels","stopIndent","Math","floor","reply","getReplyIndent","forumng_indent","indent","ancestor","parentElement","documentElement","linksdisabled","deepCloneChangeItemid","obj","itemid","Array","isArray","c","prototype","hasOwnProperty","call","setTimeoutMulti","fn","count","expandNow","expandLink","nodeName","toLowerCase","originalSrc","delay","processLinkRetrieveMessage","postNum","expand","collapse","linkImg","alt","inProcess","focushandler","expandOk","expandError","originalsrc","scriptCommands","scriptRegexp","result","exec","o","newDiv","previousSelect","checked","expander","Expander","linkPostParent","checkbox","tracker","Rating","initPopup","go","authorSpan","links","jserr_load","focuser","targetPost","jumpTo","equivalent","prev","next","author","targetPost2","undelete","currentUser","deleteOnly","linkRegion","deleteOptions","confirmundelete","confirmdelete","undeletepostbutton","newPost","message","actionText","cancelText","highlight","fadePanel","getDocWidth","getDocHeight","opacity","animateOpacity","linearEasing","highlightDiv","highlightRegion","bottom","removePX","getComputedStyle","borderTopWidth","borderBottomWidth","paddingTop","paddingBottom","borderLeftWidth","borderRightWidth","paddingLeft","paddingRight","dialog","getViewportRegion","page","pixelsWidth","leftAdjuster","requiredBoxWidth","leftValue","max","messageDiv","tabIndex","buttonDiv","type","confirmMakeButton","yes","log","thing","console","debug","focusSortLinks","linkMatch","turnButtonIntoLink","searchIndex","sortLinkId","substr","target","extraneousDisplay","subscribeOptions","main","all","none","field","intro","introText","selectintro","selectButtons","selectall","check","deselectall","outro","confirmselection","forumng_select_changed","ok","checkcount","info","spanSeparator","extraSpan","label","selectlabel","hidden","forumng_hidden","previousElementSibling","update","print","buttonsDiv","selectAll","deselectAll","unsubscribe","startsWith","allSelected","noneSelected","item","parameterName","URLSearchParams","get","element","startOpacity","endOpacity","duration","easingFunction","start","deltaOpacity","requestAnimationFrame","step","timestamp","progress","easeProgress","t","editorID","innerWin","_innerWin$tinyMCE","TinyRepository","removeAutosaveSession","initButtons","buttonIds","init","initializer"],"mappings":"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"}