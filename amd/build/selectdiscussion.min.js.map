{"version":3,"file":"selectdiscussion.min.js","sources":["../src/selectdiscussion.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\nimport {linksDisable, linksEnable, scrollPage, simulateClick} from 'mod_forumng/common';\n\n/**\n * JavaScript to handle select discussion.\n *\n * @module mod_forumng/selectdiscussion\n * @copyright 2024 The Open University\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nexport class SelectDiscussion {\n    /**\n     * Class constructor\n     *\n     * @param {object} options Options for ajax request\n     */\n    constructor(options) {\n        this.cloneID = options.cloneID;\n        this.stringList = options.stringList;\n        this.select = options.select;\n    }\n\n    /**\n     * Initialises the discussion selector feature, switching the whole page into select mode.\n     *\n     * @param {HTMLElement} target Target button that indicates where the resulting selection will be posted,\n     * or null to cancel select mode\n     * @param {Array} includes Array of classes to include in selection\n     * @param {Array} excludes Array of classes to exclude from selection\n     */\n    selectDiscussInit(target, includes, excludes) {\n        this.select.on = !!target;\n\n        const discussions = document.querySelectorAll('.forumng-discussionlist tr');\n        if (discussions.length == 0) {\n            return;\n        }\n        const confirm = document.createElement('input');\n        confirm.setAttribute('type', 'submit');\n\n        const main = document.querySelector('table.forumng-discussionlist');\n        const all = document.createElement('input');\n        const none = document.createElement('input');\n        if (this.select.on) {\n            // Make form around main elements.\n            const form = document.createElement('form');\n            form.setAttribute('method', 'post');\n            this.select.form = form;\n            form.setAttribute('action', target.form.getAttribute('action'));\n            main.classList.add('forumng-selectmode');\n\n            form.inputs = document.createElement('div');\n            form.appendChild(form.inputs);\n            let field = document.createElement('input');\n            field.setAttribute('type', 'hidden');\n            field.setAttribute('name', 'fromselect');\n            field.setAttribute('value', '1');\n            form.inputs.appendChild(field);\n            if (this.cloneID) {\n                field = document.createElement('input');\n                field.setAttribute('type', 'hidden');\n                field.setAttribute('name', 'clone');\n                field.setAttribute('value', this.cloneID);\n                form.inputs.appendChild(field);\n            }\n            target.form.children[0].querySelectorAll('input').forEach(node => {\n                if (node.getAttribute('type') == 'hidden') {\n                    const field = node.cloneNode(true);\n                    form.inputs.appendChild(field);\n                }\n            });\n\n            // Make intro.\n            form.intro = document.createElement('div');\n            form.intro.classList.add('forumng-selectintro');\n            main.parentNode.insertBefore(form.intro, main);\n            const introText = document.createElement('p');\n            introText.textContent = this.stringList.selectdiscintro;\n            form.intro.appendChild(introText);\n\n            // Make buttons to select all/none.\n            const selectButtons = document.createElement('div');\n            selectButtons.classList.add('forumng-selectbuttons');\n            form.intro.appendChild(selectButtons);\n\n            all.setAttribute('type', 'button');\n            all.setAttribute('value', this.stringList.selectall);\n            selectButtons.appendChild(all);\n            all.addEventListener('click', () => {\n                for (let i = 1; i < discussions.length; i++) {\n                    if (discussions[i].check && !discussions[i].check.checked) {\n                        simulateClick(discussions[i].check);\n                    }\n                }\n                all.disabled = true;\n                none.disabled = false;\n            });\n            selectButtons.appendChild(document.createTextNode(' '));\n\n            none.setAttribute('type', 'button');\n            none.setAttribute('value', this.stringList.deselectall);\n            selectButtons.appendChild(none);\n            none.addEventListener('click', () => {\n                for (let i = 1; i < discussions.length; i++) {\n                    if (discussions[i].check && discussions[i].check.checked) {\n                        simulateClick(discussions[i].check);\n                    }\n                }\n                all.disabled = false;\n                none.disabled = true;\n            });\n\n            const forumngFeatures = document.querySelector('#forumng-features');\n            if (forumngFeatures && main.closest('.forumng-main').contains(forumngFeatures)) {\n                main.closest('.forumng-main').insertBefore(form, forumngFeatures);\n            } else {\n                main.parentNode.appendChild(form);\n            }\n\n            // Make outro.\n            form.outro = document.createElement('div');\n            form.outro.classList.add('forumng-selectoutro');\n            form.appendChild(form.outro);\n\n            confirm.setAttribute('value', this.stringList.confirmselection);\n            form.outro.appendChild(confirm);\n\n            form.outro.appendChild(document.createTextNode(' '));\n\n            const cancel = document.createElement('input');\n            cancel.setAttribute('type', 'button');\n            cancel.setAttribute('id', 'forumng-cancel-select');\n            cancel.setAttribute('value', this.stringList.cancel);\n            form.outro.appendChild(cancel);\n            cancel.addEventListener('click', () => {\n                this.selectDiscussInit(null);\n            });\n\n            scrollPage(form.intro, null);\n            // Disable all discussion select buttons.\n            document.querySelectorAll('.forumng-dselectorbutton input').forEach(node => {\n                node.disabled = true;\n            });\n        } else {\n            const form = this.select.form;\n            form.remove();\n            form.intro.remove();\n            form.outro.remove();\n            main.classList.remove('forumng-selectmode');\n            this.select.form = null;\n            // Enable all discussion select buttons.\n            document.querySelectorAll('.forumng-dselectorbutton input').forEach(node => {\n                node.disabled = false;\n            });\n        }\n\n        discussions.forEach((discussion, index) => {\n            if (index > 0 && discussion.classList.contains('forumng-discussion-short')) {\n                let useid = discussion.id;\n                useid = useid.replace('discrow_', '');\n                // Check we interact with this discussion.\n                let include = true;\n                if (this.select.on) {\n                    if (includes.length > 0) {\n                        include = false;\n                        for (let a = 0; a < includes.length; a++) {\n                            if (discussion.classList.contains(includes[a])) {\n                                include = true;\n                                break;\n                            }\n                        }\n                    }\n                    if (excludes.length > 0) {\n                        for (let a = 0; a < excludes.length; a++) {\n                            if (discussion.classList.contains(excludes[a])) {\n                                include = false;\n                                break;\n                            }\n                        }\n                    }\n                }\n                if (include) {\n                    this.selectInitDiscuss(discussion, this.select.on, useid);\n                }\n            }\n        });\n\n        window.forumng_select_changed = () => {\n            let ok = false;\n            let checkcount = 0;\n            let availcount = 0;\n            discussions.forEach(discussion => {\n                if (discussion.check) {\n                    availcount++;\n                    if (discussion.check.checked) {\n                        ok = true;\n                        checkcount++;\n                    }\n                }\n            });\n            none.disabled = !ok;\n            confirm.disabled = !ok;\n            all.disabled = checkcount == availcount;\n        };\n\n        if (this.select.on) {\n            window.forumng_select_changed();\n        }\n    }\n\n    /**\n     * Initialises a discussion row within select mode.\n     *\n     * @param {HTMLElement} discussion Discussion row\n     * @param {boolean} on True if select is being turned on, false if it's being turned off\n     * @param {number} number Order number of discussion in list\n     */\n    selectInitDiscuss(discussion, on, number) {\n        if (on) {\n            const info = discussion.querySelector('td.cell.c0');\n            const span = document.createElement('span');\n            span.classList.add('dselectorcheck');\n            const spanSeparator = document.createElement('span');\n            info.prepend(span);\n            discussion.extraSpan = span;\n            discussion.classList.add('forumng-deselected');\n            const discussionId = number;\n\n            spanSeparator.classList.add('forumng-separator');\n            spanSeparator.appendChild(document.createTextNode(' \\u2022 '));\n            const check = document.createElement('input');\n            check.setAttribute('type', 'checkbox');\n            check.setAttribute('id', 'check' + discussionId);\n            discussion.check = check;\n            span.appendChild(check);\n            const label = document.createElement('label');\n            label.classList.add('accesshide');\n            label.setAttribute('for', check.getAttribute('id'));\n            span.appendChild(label);\n            label.appendChild(document.createTextNode(this.stringList.selectlabel.replace('{$a}', number)));\n            span.appendChild(spanSeparator);\n            linksDisable(document.body);\n\n            let hidden = document.querySelector(\"input[name='select\" + discussionId + \"']\");\n            if (!hidden) {\n                hidden = document.createElement('input');\n                hidden.setAttribute('type', 'hidden');\n                hidden.setAttribute('value', '0');\n                hidden.setAttribute('name', 'selectd' + discussionId);\n                this.select.form.appendChild(hidden);\n            }\n            discussion.forumng_hidden = hidden;\n\n            check.addEventListener('click', () => {\n                if (check.checked) {\n                    discussion.classList.remove('forumng-deselected');\n                    discussion.forumng_hidden.setAttribute('value', '1');\n                } else {\n                    discussion.classList.add('forumng-deselected');\n                    discussion.forumng_hidden.setAttribute('value', '0');\n                }\n                window.forumng_select_changed();\n            });\n        } else {\n            if (discussion.extraSpan) {\n                discussion.extraSpan.remove();\n            }\n            discussion.classList.remove('forumng-deselected');\n            linksEnable(document.body);\n        }\n    }\n}\n"],"names":["constructor","options","cloneID","stringList","select","selectDiscussInit","target","includes","excludes","on","discussions","document","querySelectorAll","length","confirm","createElement","setAttribute","main","querySelector","all","none","this","form","getAttribute","classList","add","inputs","appendChild","field","children","forEach","node","cloneNode","intro","parentNode","insertBefore","introText","textContent","selectdiscintro","selectButtons","selectall","addEventListener","i","check","checked","disabled","createTextNode","deselectall","forumngFeatures","closest","contains","outro","confirmselection","cancel","remove","discussion","index","useid","id","replace","include","a","selectInitDiscuss","window","forumng_select_changed","ok","checkcount","availcount","number","info","span","spanSeparator","prepend","extraSpan","discussionId","label","selectlabel","body","hidden","forumng_hidden"],"mappings":"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"}