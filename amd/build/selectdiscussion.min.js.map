{"version":3,"file":"selectdiscussion.min.js","sources":["../src/selectdiscussion.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\nimport {linksDisable, linksEnable, scrollPage, simulateClick} from 'mod_forumng/common';\n\n/**\n * JavaScript to handle select discussion.\n *\n * @module mod_forumng/selectdiscussion\n * @copyright 2024 The Open University\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nexport class SelectDiscussion {\n    /**\n     * Class constructor\n     *\n     * @param {object} options Options for ajax request\n     */\n    constructor(options) {\n        this.cloneID = options.cloneID;\n        this.stringList = options.stringList;\n        this.select = options.select;\n    }\n\n    /**\n     * Initialises the discussion selector feature, switching the whole page into select mode.\n     *\n     * @param {HTMLElement} target Target button that indicates where the resulting selection will be posted,\n     * or null to cancel select mode\n     * @param {Array} includes Array of classes to include in selection\n     * @param {Array} excludes Array of classes to exclude from selection\n     */\n    selectDiscussInit(target, includes, excludes) {\n        this.select.on = !!target;\n\n        const discussions = document.querySelectorAll('.forumng-discussionlist tr');\n        if (discussions.length == 0) {\n            return;\n        }\n        const confirm = document.createElement('input');\n        confirm.setAttribute('type', 'submit');\n        confirm.disabled = true;\n\n        const main = document.querySelector('table.forumng-discussionlist');\n        const all = document.createElement('input');\n        const none = document.createElement('input');\n        if (this.select.on) {\n            // Make form around main elements.\n            const form = document.createElement('form');\n            form.setAttribute('method', 'post');\n            this.select.form = form;\n            form.setAttribute('action', target.form.getAttribute('action'));\n            main.classList.add('forumng-selectmode');\n\n            form.inputs = document.createElement('div');\n            form.appendChild(form.inputs);\n            let field = document.createElement('input');\n            field.setAttribute('type', 'hidden');\n            field.setAttribute('name', 'fromselect');\n            field.setAttribute('value', '1');\n            form.inputs.appendChild(field);\n            if (this.cloneID) {\n                field = document.createElement('input');\n                field.setAttribute('type', 'hidden');\n                field.setAttribute('name', 'clone');\n                field.setAttribute('value', this.cloneID);\n                form.inputs.appendChild(field);\n            }\n            target.form.children[0].querySelectorAll('input').forEach(node => {\n                if (node.getAttribute('type') == 'hidden') {\n                    const field = node.cloneNode(true);\n                    form.inputs.appendChild(field);\n                }\n            });\n\n            // Make intro.\n            form.intro = document.createElement('div');\n            form.intro.classList.add('forumng-selectintro');\n            main.parentNode.insertBefore(form.intro, main);\n            const introText = document.createElement('p');\n            introText.textContent = this.stringList.selectdiscintro;\n            form.intro.appendChild(introText);\n\n            // Make buttons to select all/none.\n            const selectButtons = document.createElement('div');\n            selectButtons.classList.add('forumng-selectbuttons');\n            form.intro.appendChild(selectButtons);\n\n            all.setAttribute('type', 'button');\n            all.setAttribute('value', this.stringList.selectall);\n            selectButtons.appendChild(all);\n            all.addEventListener('click', () => {\n                for (let i = 1; i < discussions.length; i++) {\n                    if (discussions[i].check && !discussions[i].check.checked) {\n                        simulateClick(discussions[i].check);\n                    }\n                }\n                all.disabled = true;\n                none.disabled = false;\n            });\n            selectButtons.appendChild(document.createTextNode(' '));\n\n            none.setAttribute('type', 'button');\n            none.setAttribute('value', this.stringList.deselectall);\n            selectButtons.appendChild(none);\n            none.addEventListener('click', () => {\n                for (let i = 1; i < discussions.length; i++) {\n                    if (discussions[i].check && discussions[i].check.checked) {\n                        simulateClick(discussions[i].check);\n                    }\n                }\n                all.disabled = false;\n                none.disabled = true;\n            });\n\n            const forumngFeatures = document.querySelector('#forumng-features');\n            if (forumngFeatures && main.closest('.forumng-main').contains(forumngFeatures)) {\n                main.closest('.forumng-main').insertBefore(form, forumngFeatures);\n            } else {\n                main.parentNode.appendChild(form);\n            }\n\n            // Make outro.\n            form.outro = document.createElement('div');\n            form.outro.classList.add('forumng-selectoutro');\n            form.appendChild(form.outro);\n\n            confirm.setAttribute('value', this.stringList.confirmselection);\n            form.outro.appendChild(confirm);\n\n            form.outro.appendChild(document.createTextNode(' '));\n\n            const cancel = document.createElement('input');\n            cancel.setAttribute('type', 'button');\n            cancel.setAttribute('id', 'forumng-cancel-select');\n            cancel.setAttribute('value', this.stringList.cancel);\n            form.outro.appendChild(cancel);\n            cancel.addEventListener('click', () => {\n                this.selectDiscussInit(null);\n            });\n\n            scrollPage(form.intro, null);\n            // Disable all discussion select buttons.\n            document.querySelectorAll('.forumng-dselectorbutton input').forEach(node => {\n                node.disabled = true;\n            });\n        } else {\n            const form = this.select.form;\n            form.remove();\n            form.intro.remove();\n            form.outro.remove();\n            main.classList.remove('forumng-selectmode');\n            this.select.form = null;\n            // Enable all discussion select buttons.\n            document.querySelectorAll('.forumng-dselectorbutton input').forEach(node => {\n                node.disabled = false;\n            });\n        }\n\n        discussions.forEach((discussion, index) => {\n            if (index > 0 && discussion.classList.contains('forumng-discussion-short')) {\n                let useid = discussion.id;\n                useid = useid.replace('discrow_', '');\n                // Check we interact with this discussion.\n                let include = true;\n                if (this.select.on) {\n                    if (includes.length > 0) {\n                        include = false;\n                        for (let a = 0; a < includes.length; a++) {\n                            if (discussion.classList.contains(includes[a])) {\n                                include = true;\n                                break;\n                            }\n                        }\n                    }\n                    if (excludes.length > 0) {\n                        for (let a = 0; a < excludes.length; a++) {\n                            if (discussion.classList.contains(excludes[a])) {\n                                include = false;\n                                break;\n                            }\n                        }\n                    }\n                }\n                if (include) {\n                    this.selectInitDiscuss(discussion, this.select.on, useid);\n                }\n            }\n        });\n\n        window.forumng_select_changed = () => {\n            let ok = false;\n            let checkcount = 0;\n            let availcount = 0;\n            discussions.forEach(discussion => {\n                if (discussion.check) {\n                    availcount++;\n                    if (discussion.check.checked) {\n                        ok = true;\n                        checkcount++;\n                    }\n                }\n            });\n            none.disabled = !ok;\n            confirm.disabled = !ok;\n            all.disabled = checkcount == availcount;\n        };\n\n        if (this.select.on) {\n            window.forumng_select_changed();\n        }\n    }\n\n    /**\n     * Initialises a discussion row within select mode.\n     *\n     * @param {HTMLElement} discussion Discussion row\n     * @param {boolean} on True if select is being turned on, false if it's being turned off\n     * @param {number} number Order number of discussion in list\n     */\n    selectInitDiscuss(discussion, on, number) {\n        if (on) {\n            const info = discussion.querySelector('td.cell.c0');\n            const span = document.createElement('span');\n            span.classList.add('dselectorcheck');\n            const spanSeparator = document.createElement('span');\n            info.prepend(span);\n            discussion.extraSpan = span;\n            discussion.classList.add('forumng-deselected');\n            const discussionId = number;\n\n            spanSeparator.classList.add('forumng-separator');\n            spanSeparator.appendChild(document.createTextNode(' \\u2022 '));\n            const check = document.createElement('input');\n            check.setAttribute('type', 'checkbox');\n            check.setAttribute('id', 'check' + discussionId);\n            discussion.check = check;\n            span.appendChild(check);\n            const label = document.createElement('label');\n            label.classList.add('accesshide');\n            label.setAttribute('for', check.getAttribute('id'));\n            span.appendChild(label);\n            label.appendChild(document.createTextNode(this.stringList.selectlabel.replace('{$a}', number)));\n            span.appendChild(spanSeparator);\n            linksDisable(document.body);\n\n            let hidden = document.querySelector(\"input[name='select\" + discussionId + \"']\");\n            if (!hidden) {\n                hidden = document.createElement('input');\n                hidden.setAttribute('type', 'hidden');\n                hidden.setAttribute('value', '0');\n                hidden.setAttribute('name', 'selectd' + discussionId);\n                this.select.form.appendChild(hidden);\n            }\n            discussion.forumng_hidden = hidden;\n\n            check.addEventListener('click', () => {\n                if (check.checked) {\n                    discussion.classList.remove('forumng-deselected');\n                    discussion.forumng_hidden.setAttribute('value', '1');\n                } else {\n                    discussion.classList.add('forumng-deselected');\n                    discussion.forumng_hidden.setAttribute('value', '0');\n                }\n                window.forumng_select_changed();\n            });\n        } else {\n            if (discussion.extraSpan) {\n                discussion.extraSpan.remove();\n            }\n            discussion.classList.remove('forumng-deselected');\n            linksEnable(document.body);\n        }\n    }\n}\n"],"names":["_exports","SelectDiscussion","constructor","options","this","cloneID","stringList","select","selectDiscussInit","target","includes","excludes","on","discussions","document","querySelectorAll","length","confirm","createElement","setAttribute","disabled","main","querySelector","all","none","form","getAttribute","classList","add","inputs","appendChild","field","children","forEach","node","cloneNode","intro","parentNode","insertBefore","introText","textContent","selectdiscintro","selectButtons","selectall","addEventListener","i","check","checked","simulateClick","createTextNode","deselectall","forumngFeatures","closest","contains","outro","confirmselection","cancel","scrollPage","remove","discussion","index","useid","id","replace","include","a","selectInitDiscuss","window","forumng_select_changed","ok","checkcount","availcount","number","info","span","spanSeparator","prepend","extraSpan","discussionId","label","selectlabel","linksDisable","body","hidden","forumng_hidden","linksEnable"],"mappings":"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"}