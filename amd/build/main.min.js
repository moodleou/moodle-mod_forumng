define("mod_forumng/main",["exports","core/str","core/notification","core_filters/events","mod_forumng/expander","mod_forumng/stardiscussion","mod_forumng/selectdiscussion","mod_forumng/common","core/pending","core/config","local_themeextras/rating"],(function(_exports,_str,_notification,filterEvents,_expander,_stardiscussion,_selectdiscussion,Common,_pending,_config,Rating){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}
/**
   * JavaScript to handle forumng.
   *
   * @module mod_forumng/main
   * @copyright 2024 The Open University
   * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_notification=_interopRequireDefault(_notification),filterEvents=_interopRequireWildcard(filterEvents),Common=_interopRequireWildcard(Common),_pending=_interopRequireDefault(_pending),_config=_interopRequireDefault(_config),Rating=_interopRequireWildcard(Rating);class Main{constructor(options){_defineProperty(this,"cloneParam",""),_defineProperty(this,"cloneID",0),_defineProperty(this,"cmID",0),_defineProperty(this,"ratingStars",0),_defineProperty(this,"discussionID",0),_defineProperty(this,"expireLinks",[]),_defineProperty(this,"select",{}),_defineProperty(this,"quotaLeft",0),_defineProperty(this,"loaderPix",""),_defineProperty(this,"mouseUser",!1),_defineProperty(this,"viewportWidth",-1),_defineProperty(this,"starPix",{}),_defineProperty(this,"nowEditing",!1),_defineProperty(this,"postQuota",!1),_defineProperty(this,"mainStrings",{rate:null,expand:"#",collapse:"#",jserr_load:null,jserr_save:null,jserr_alter:null,jserr_attachments:null,confirmdelete:null,confirmundelete:null,confirmdeletediscuss:null,deleteemailpostbutton:null,deletepostbutton:null,undeletepostbutton:null,js_nratings:null,js_nratings1:null,js_nopublicrating:null,js_publicrating:null,js_nouserrating:null,js_userrating:null,js_outof:null,js_clicktosetrating:null,js_clicktosetrating1:null,js_clicktoclearrating:null,selectlabel:null,selectintro:null,confirmselection:null,selectedposts:null,discussion:null,selectorall:null,selectoralldisc:null,selectorselecteddisc:null,selectordiscall:null,selectdiscintro:null,staron:null,staroff:null,clearstar:null,setstar:null,starpost:null}),_defineProperty(this,"stringList",{}),this.cmID=options.cmid,this.cloneID=options.cloneid,this.cloneParam=options.cloneid?"&clone="+options.cloneid:"",this.ratingStars=options.ratingstars,this.quotaLeft=options.quotaleft,this.loaderPix=options.loaderpix,this.starPix=options.starpix,this.postQuota=options.postquota}async initializer(){await this.prepareStrings(),this.domInit(),this.urgentInit()}async prepareStrings(){let requests=[];null!==this.postQuota&&(this.mainStrings.quotaleft_plural={posts:"#",period:this.postQuota},this.mainStrings.quotaleft_singular={posts:"#",period:this.postQuota}),Object.entries(this.mainStrings).forEach((_ref=>{let[string,value]=_ref;requests.push({key:string,component:"forumng",param:value})})),["cancel","delete","add","selectall","deselectall"].forEach((string=>{this.mainStrings[string]="#",requests.push({key:string,component:"moodle"})})),this.stringList=Object.fromEntries(await(0,_str.get_strings)(requests).then((fetchedStrings=>new Map(Object.entries(this.mainStrings).map(((_ref2,index)=>{let[key]=_ref2;return[key,fetchedStrings[index]]}))))).catch(_notification.default.exception))}domInit(){if(document.getElementById("forumng-switchlinkid")){let link=document.getElementById("forumng-switchlinkid");this.initSwitchLink(link)}if(document.getElementById("page-mod-forumng-subscribers"))this.initSubscribers();else if(document.getElementById("page-mod-forumng-view"))this.initView();else if(document.getElementById("page-mod-forumng-discuss"))this.initDiscuss();else{if(document.getElementById("page-mod-forumng-feature-deletedposts-deletedpostslist")&&this.initContent(document),document.getElementById("page-mod-forumng-feature-userposts-user")&&this.initContent(document),document.getElementById("page-mod-forumng-feature-print-print"))return this.initContent(document),void this.printPage();document.getElementById("page-mod-forumng-deletepost")&&this.initDeletepost()}}urgentInit(){let newStyle=document.createElement("style");newStyle.setAttribute("type","text/css");if(document.styleSheets&&document.styleSheets.length>0)if(document.styleSheets[0].addRule){document.getElementsByTagName("head")[0].appendChild(newStyle),document.styleSheets[document.styleSheets.length-1].addRule(".forumng-ratings","display:none")}else{let styleText=".forumng-ratings { display:none }";newStyle.appendChild(document.createTextNode(styleText)),document.getElementsByTagName("head")[0].appendChild(newStyle)}}initSwitchLink(link){link.addEventListener("focus",(()=>{link.parentNode.style.position="static"})),link.addEventListener("blur",(()=>{link.parentNode.style.position="absolute"}))}initDiscuss(){this.discussionID=window.location.search.replace(/^.*[?&]d=([0-9]+).*$/,"$1");let postid=this.getValueParameter("p");if(postid){let link=document.getElementById(postid);link&&(window.location.hash=link.id,link.scrollIntoView({behavior:"smooth",block:"start"}))}let forumngMain=document.getElementById("forumng-main");forumngMain&&forumngMain.classList.remove("forumng-nojs");let div=document.querySelector("#forumng-actionform > div");if(div){let form=div.parentNode;div.remove(),form.parentNode.insertBefore(div,form),form.remove()}let div1=document.querySelector(".forumng_deldiscussion");div1&&this.initDeldiscussion(div1),this.initContent(document.querySelector("#forumng-main"));let saveall=document.getElementById("forumng-saveallratings");saveall&&saveall.parentNode.removeChild(saveall),this.initFeatureButtons(!1),this.applyStopIndents();let region=Common.getElementScreenPosition(document.querySelector("#forumng-main"));this.viewportWidth=region.right-region.left,setInterval((()=>{let region=Common.getElementScreenPosition(document.querySelector("#forumng-main")),width=region.right-region.left;width!==this.viewportWidth&&(this.viewportWidth=width,this.applyStopIndents())}),250)}initDeletepost(){let msg=document.getElementById("delete-form-html");if(msg){let messagehtml=msg.textContent;document.getElementById("id_forumng_delete_msg").innerHTML=messagehtml}}initDeldiscussion(div){const form=div.parentNode.parentNode;form.addEventListener("submit",(e=>{e.preventDefault();const deleteButtons=[this.stringList.deleteemailpostbutton,this.stringList.deletepostbutton],actionUrl=form.action+"?d="+this.discussionID,cloneParam=this.cloneID?"&clone="+this.cloneID:"";this.confirm(this.stringList.confirmdeletediscuss,deleteButtons,this.stringList.cancel,null,[function(){location.href=actionUrl+"&delete=1&email=1"+cloneParam},function(){location.href=actionUrl+"&delete=1&email=0&notdeleted=1"+cloneParam}])}))}initContent(node){this.select.on&&node.classList.contains("forumng-post")&&this.selectInitPost(node,!0);const expandposts={};if(node==document||"forumng-main"==node.id){if(window.location.hash){let match=window.location.hash.match(/p([0-9]+)$/);match&&(expandposts[parseInt(match[1])]=!0)}let expandedList=document.getElementById("expanded_posts"),posts=expandedList?expandedList.value.split(","):[];for(let i=0;i<posts.length;i++)expandposts[posts[i]]=!0}0==this.quotaLeft&&this.killReplyLinks(),node.querySelectorAll("a").forEach((link=>{let href=link.href;if(link.classList.contains("forumng-mobilepost-link"))return;let match=href.match(/[?&]expires=([0-9]+)(&|$)/);match&&(this.initExpiry(link,parseInt(match[1])),href=link.getAttribute("href")),match=href.match(/\/discuss\.php\?d=([0-9]+).*&expand=1#p([0-9]+)$/),match&&link.classList.contains("forumng-expandlink")&&this.initExpand(link,match[2],expandposts[parseInt(match[2])]),match=href.match(/\/discuss\.php\?d=([0-9]+).*&collapse=1#p([0-9]+)$/),match&&link.classList.contains("forumng-collapselink")&&this.initCollapse(link,match[2]),match=href.match(/\/editpost\.php\?replyto=([0-9]+).*$/),match&&this.initReply(link,parseInt(match[1])),match=href.match(/\/editpost\.php\?p=([0-9]+).*$/),match&&this.initEdit(link,parseInt(match[1])),match=href.match(/\/deletepost\.php\?p=([0-9]+)(?:&clone=[0-9]+)?(?:&delete=([0-9]+))?(?:&currentuser=([0-9]))?(?:&expand=1)?$/),match&&this.initDelete(link,parseInt(match[1]),match[2]&&0==match[2],match[3]),link.classList.contains("forumng-parentlink")&&this.initParentLink(link),link.parentNode.classList.contains("forumng-jumpto")&&this.initJumpLink(link),link.parentNode.classList.contains("forumng-markread")&&this.initPostread(link)}));let ratings=node.querySelectorAll("div.forumng-ratings");if(ratings.length>0){let ratingoptions={cloneParam:this.cloneParam,ratingStars:this.ratingStars,loaderPix:this.loaderPix,starPix:this.starPix,stringList:this.stringList},ratingins=new _stardiscussion.StarDiscussion(ratingoptions);ratings.forEach((rating=>{let div=ratingins.initRating(rating);"object"==typeof div&&null!==div&&this.createRateButton(div)}))}node.querySelectorAll("input.forumng-zero-disable").forEach((input=>{this.zeroDisable(input)})),this.initFlags(node),filterEvents.notifyFilterContentUpdated(node)}createRateButton(div){const newButton=document.createElement("input");newButton.setAttribute("type","button"),newButton.setAttribute("value",this.stringList.rate),div.selector.parentNode.insertBefore(newButton,div.selector.nextSibling),newButton.addEventListener("click",(()=>{newButton.disabled=!0;const url="".concat(_config.default.wwwroot,"/mod/forumng/rate.php"),data="p=".concat(div.postId).concat(this.cloneParam,"&rating=").concat(div.selector.value,"&ajax=1");fetch(url+"?"+data,{method:"POST",headers:{"Content-Type":"application/json"}}).then((response=>response.text())).then((text=>{this.deleteOk(div,{responseText:text})})).catch((()=>{this.deleteError(div)})),Common.linksDisable(div.post),div.loader=document.createElement("img"),div.loader.setAttribute("alt",""),div.loader.style.position="absolute",div.loader.setAttribute("src",this.loaderPix),div.parentNode.appendChild(div.loader);const byregion=Common.getElementScreenPosition(newButton);div.loader.style.left="".concat(byregion.right+3,"px"),div.loader.style.top="".concat(byregion.top+2,"px")}))}initExpiry(link,seconds){if(link.forumngExpiryJavatime=1e3*seconds-45e3+Date.now(),link.href=link.href.replace(/[?&]expires=[0-9]+/,""),this.expireLinks.push(link),1==this.expireLinks.length){const timerid=setInterval((()=>{const current=Date.now();for(let i=this.expireLinks.length-1;i>=0;i--)if(current>this.expireLinks[i].forumngExpiryJavatime){const deadlink=this.expireLinks[i];deadlink.parentNode&&deadlink.parentNode.remove(),this.expireLinks.splice(i,1)}0==this.expireLinks.length&&clearInterval(timerid)}),15e3)}}killReplyLinks(){document.querySelectorAll("#forumng-main a[href]").forEach((link=>{link.href.match(/editpost\.php\?replyto=[0-9]+.*$/)&&link.remove()}))}removeIframe(iframe){let scrollToParent=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const parent=iframe.parentNode;parent.removeChild(iframe),parent.removeAttribute("style"),this.isMobile()&&(parent.style.display="none",window.addEventListener("scroll",(event=>{event.preventDefault()}))),this.nowEditing=!1,scrollToParent&&Common.scrollPage(parent.parentNode),Common.linksEnable(document.body)}detectOS(){const ua=navigator.userAgent;return/android/i.test(ua)?Common.androidOS:/iPad|iPhone|iPod/.test(ua)?Common.iOS:Common.otherOS}isMobile(){return this.detectOS()===Common.iOS||this.detectOS()===Common.androidOS}initIframe(src,post){let isUnread=post.className.split(" ").includes("forumng-unread");if(this.nowEditing)return null;this.nowEditing=!0;let pendingPromise=new _pending.default("forumng_iframe");Common.linksDisable(document.body);const iframecon=document.createElement("div");iframecon.classList.add("iframecon");const iframe=document.createElement("iframe");iframe.className="forumng-inlineform",iframe.name="forumng-post-iframe",iframe.height=500,src+="&iframe=1",iframe.src=src,window.iframe_has_loaded=innerwin=>{isUnread&&(innerwin.document.body.className+=" iframe-post-unread"),pendingPromise.resolve();let pendingPromisefil=new _pending.default("forumng_iframe_load");const doc=innerwin.document;let counter=0;const editemailHead=doc.getElementById("id_id_emailauthor");editemailHead&&(editemailHead.className+=" collapsed");const fixHeight=()=>{let pendingPromisefir=new _pending.default("forumng_iframe_resize");doc.body.scrollHeight>Number(iframe.height)&&(iframe.height=doc.body.scrollHeight+2,iframecon.style.height="".concat(doc.body.scrollHeight+2,"px"),iframecon.style.overflow="unset"),this.isMobile()&&(iframecon.style.display="block",iframecon.style.width="100%",iframecon.style.height="100%",this.detectOS()===Common.iOS?(iframecon.style.position="fixed",iframecon.style.top="0px",iframecon.style.left="0px",iframecon.style.zIndex="9999",iframecon.style.overflow="scroll",iframecon.style.webkitOverflowScrolling="touch",iframe.style.position="relative",iframe.style.top="initial",iframe.style.left="initial"):(iframe.style.position="fixed",iframe.style.top="0px",iframe.style.left="0px",iframe.style.zIndex="9999"),iframe.style.height="100%",iframe.style.width="100%",iframe.style.overflowX="hidden",iframe.style.overflowY="auto",iframe.clientHeight>=innerwin.document.querySelector("#page").clientHeight?iframe.scrolling="no":iframe.scrolling="auto",doc.body.focus(),window.scrollTo(0,0)),counter++,counter<20&&setTimeout(fixHeight,500),pendingPromisefir.resolve()};fixHeight(),doc.getElementById("id_cancel").addEventListener("click",(e=>{let blank=!1;if(!innerwin.document.getElementById("id_message")||""!==innerwin.document.getElementById("id_message").innerText&&""!==innerwin.document.getElementById("id_message").textContent||(blank=!0),!innerwin.document.querySelector(".editor_atto")||blank)return e||(e=window.event),e&&(e.stopPropagation?e.stopPropagation():e.cancelBubble=!0),this.removeIframe(iframe),!1}));const draftbut=doc.getElementById("id_savedraft");draftbut&&draftbut.addEventListener("click",(()=>{const x=setInterval((()=>{innerwin.document.querySelector(".forumng-draftexists")&&(Common.scrollPage(document.querySelector(".forumng-inlineform")),clearInterval(x))}),500)}));const try_focus=()=>{if(innerwin.tinyMCE)for(let edId in innerwin.tinyMCE.editors)if("id_message"===edId)return void innerwin.tinyMCE.execCommand("mceFocus",!1,"id_message");setTimeout(try_focus,100)};this.isMobile()||setTimeout(try_focus,250),pendingPromisefil.resolve()};const ends=post.querySelectorAll("div.forumng-endpost"),last=ends[ends.length-1];return last.parentNode.insertBefore(iframecon,last.nextSibling),iframecon.appendChild(iframe),iframe}initEdit(link,postid){link.addEventListener("click",(e=>{if(e.preventDefault(),this.areLinksDisabled(link))return;const post=link.closest(".forumng-post"),rootpost=!post.closest(".forumng-replies");let src="editpost.php?p=".concat(postid);this.cloneID&&(src+="&clone=".concat(this.cloneID));const iframe=this.initIframe(src,post);iframe&&(window.iframe_success=innerwin=>{const scriptcommands=[],newpost=this.prepareNewPost(innerwin,scriptcommands);if(""!==newpost.innerHTML){if(post.parentNode.insertBefore(newpost,post),post.parentNode.removeChild(post),setTimeout((()=>{newpost.querySelectorAll("img").forEach((img=>{img.src=img.src}))}),100),scriptcommands.forEach((cmd=>{eval(cmd)})),rootpost){const subjectinput=newpost.querySelector("input[name=discussion_subject]"),subject=subjectinput.value;subjectinput.remove();const discussionTitles=document.querySelectorAll(".forumng_discussion_title");discussionTitles.forEach((title=>{title.innerHTML=subject}));const navbar=document.querySelector("#page-header .navbar ul, #page-navbar ul");if(navbar){const lastspan=navbar.querySelector("li:last-child > span:last-child");if(lastspan){for(;lastspan.firstChild;)lastspan.removeChild(lastspan.firstChild);lastspan.appendChild(document.createTextNode(" "+subject))}}}this.initContent(newpost)}this.removeIframe(iframe),window.iframe_success=null})}))}prepareNewPost(innerwin,scriptcommands){const responsetext=innerwin.document.body.firstChild.innerHTML,newdiv=document.createElement("div");let extractedHTML=this.extractJs(responsetext,scriptcommands);newdiv.innerHTML=extractedHTML;const newpost=newdiv.firstElementChild;return newdiv.removeChild(newpost),newpost}initReply(link,replytoid){link.addEventListener("click",(e=>{if(e.preventDefault(),this.areLinksDisabled(link))return;const draft=!!window.forumng_draft&&window.forumng_draft;window.forumng_draft=null;const post=link.closest(".forumng-post");let src="editpost.php?";src+=draft?"draft="+draft.id:"replyto="+replytoid,this.cloneID&&(src+="&clone="+this.cloneID);const iframe=this.initIframe(src,post);if(!iframe)return;window.iframe_success=innerwin=>{let replies;post.nextElementSibling&&post.nextElementSibling.classList.contains("forumng-replies")?replies=post.nextElementSibling:(replies=document.createElement("div"),replies.className="forumng-replies",post.parentNode.insertBefore(replies,post.nextElementSibling),this.applyStopIndents());const scriptcommands=[],newpost=this.prepareNewPost(innerwin,scriptcommands);replies.appendChild(newpost),scriptcommands.forEach((cmd=>eval(cmd))),this.initContent(newpost),this.quotaLeft>0&&(this.quotaLeft--,0==this.quotaLeft&&this.killReplyLinks()),this.removeIframe(iframe,!1),window.iframe_success=null,Common.scrollPage(newpost,null)},iframe.replytoid=replytoid;const quotaDiv=document.querySelector("#id_postlimit1");if(quotaDiv){const quotaItem=quotaDiv.closest(".fitem");if(this.quotaLeft>2||this.quotaLeft<0)quotaItem.style.display="none";else{quotaItem.style.display="block";let text=1==this.quotaLeft?this.stringList.quotaleft_singular:this.stringList.quotaleft_plural;text=text.replace("#",this.quotaLeft),quotaDiv.innerHTML=text}}})),window.forumng_draft&&window.forumng_draft.parentpostid==replytoid&&setTimeout((()=>{Common.simulateClick(link)}),0)}initFlags(node){node.querySelectorAll("div.forumng-flagpost").forEach((div=>{this.initFlagDiv(div)}))}initFlagDiv(div){div.anchor=div.querySelector("a"),div.span=div.querySelector("span"),div.icon=div.querySelector("img.icon"),div.on=null!==div.icon.src.match(/star\.on/);const handleClick=e=>{if(div.anchor.classList.contains("forumng-disabled"))return!1;fetch(div.anchor.href+"&ajax=1",{method:"POST",headers:{"Content-Type":"application/json"}}).then((()=>{div.on=!div.on,div.icon.src=div.icon.src.replace(/star\.o(n|ff)/,"star.".concat(div.on?"on":"off")),div.anchor.href=div.anchor.href.replace(/\&flag=(0|1)/,"&flag=".concat(div.on?0:1)),div.anchor.title=div.on?this.stringList.clearstar:this.stringList.setstar,div.on?div.classList.add("starred-post"):div.classList.remove("starred-post");div.span.innerHTML&&(div.span.innerHTML=div.on?this.stringList.clearstar:this.stringList.starpost)})).catch((()=>{alert(this.stringList.jserr_alter)})),e.preventDefault()};div.icon.removeEventListener("click",handleClick),div.anchor.addEventListener("click",handleClick)}initPostread(link){link.addEventListener("click",(e=>{if(e.preventDefault(),this.areLinksDisabled(link)||link.classList.contains("disabled"))return;let pendingPromise=new _pending.default("forumng_postread");const url=link.href+"&ajax=1";fetch(url,{method:"GET",headers:{"Content-Type":"application/json"}}).then((async response=>{if(!(await response.text()).includes("ok"))return alert(this.stringList.jserr_alter),void pendingPromise.resolve();link.classList.add("disabled"),link.setAttribute("disabled","disabled");const post=link.closest("div.forumng-unread");post&&post.classList.replace("forumng-unread","forumng-read"),pendingPromise.resolve()})).catch((()=>{alert(this.stringList.jserr_alter),pendingPromise.resolve()}))}))}initFeatureButtons(islist){islist?document.querySelectorAll("form.forumng-dselectorbutton input[type=submit], #osep-bottombutton-export, #osep-bottombutton-print").forEach((node=>{if("A"===node.tagName){0==document.querySelectorAll(".forumng-discussionlist tr").length&&(node.style.display="none")}this.initSelectButton(node,!0)})):document.querySelectorAll("form.forumng-selectorbutton, #osep-bottombutton-export, #osep-bottombutton-print").forEach((node=>{let submit;submit="A"===node.tagName?node:node.querySelector("input[type=submit]"),this.initSelectButton(submit,!1)}))}initSelectButton(submit,isList){if(isList){return 0==document.querySelectorAll(".forumng-discussionlist tr").length?void(submit.disabled=!0):void submit.addEventListener("click",(e=>{e.preventDefault(),"A"===submit.tagName&&("osep-bottombutton-export"===submit.id?submit=document.querySelector(".forumngfeature_export form.forumng-dselectorbutton input[type=submit]"):"osep-bottombutton-print"===submit.id&&(submit=document.querySelector(".forumngfeature_print form.forumng-dselectorbutton input[type=submit]")));let include=[],exclude=[];const form=submit.form,includeEl=form.querySelector("input[name=include]");includeEl&&(include=includeEl.value.split(","));const excludeEl=form.querySelector("input[name=exclude]");excludeEl&&(exclude=excludeEl.value.split(","));let inputs="",inputNodes=form.querySelectorAll("input[type=hidden]");0==inputNodes.length&&(inputNodes=form.children[0].querySelectorAll("input[type=hidden]")),inputNodes.forEach((node=>{inputs+="&".concat(node.name,"=").concat(node.value)})),this.confirm("<h4>".concat(submit.value,"</h4><p>").concat(this.stringList.selectordiscall,"</p>"),[this.stringList.selectoralldisc,this.stringList.selectorselecteddisc],this.stringList.cancel,null,[function(){location.href="".concat(form.action,"?all=1").concat(this.cloneParam).concat(inputs)}.bind(this),function(){let discussionoptions={cloneID:this.cloneID,stringList:this.stringList,select:this.select},selectDiscussion=new _selectdiscussion.SelectDiscussion(discussionoptions);document.querySelector("div.forumng-main > form")||selectDiscussion.selectDiscussInit(submit,include,exclude)}.bind(this)])}))}submit.addEventListener("click",(e=>{e.preventDefault(),"A"===submit.tagName&&("osep-bottombutton-export"===submit.id?submit=document.querySelector(".forumngfeature_dis_export form.forumng-selectorbutton input[type=submit]"):"osep-bottombutton-print"===submit.id&&(submit=document.querySelector(".forumngfeature_dis_print form.forumng-selectorbutton input[type=submit]"))),this.confirm("<h4>".concat(submit.value,"</h4><p>").concat(this.stringList.selectorall,"</p>"),[this.stringList.discussion,this.stringList.selectedposts],this.stringList.cancel,null,[function(){location.href="".concat(submit.form.action,"?d=").concat(this.discussionID).concat(this.cloneParam,"&all=1")}.bind(this),function(){document.querySelector("div.forumng-selectbuttons")&&this.selectInit(null),this.selectInit(submit)}.bind(this)])}))}applyStopIndents(){const region=Common.getElementScreenPosition(document.getElementById("forumng-main")),width=region.right-region.left,isMobile=window.matchMedia("(max-width: 767px)").matches,maxIndentPixels=width-(isMobile?256:550);let stopIndent=1;isMobile?maxIndentPixels>6&&(stopIndent=Math.floor(maxIndentPixels/6)):maxIndentPixels>350?stopIndent=10+Math.floor((maxIndentPixels-350)/20):maxIndentPixels>200?stopIndent=5+Math.floor((maxIndentPixels-200)/30):maxIndentPixels>=40&&(stopIndent=Math.floor(maxIndentPixels/40)),document.querySelectorAll("div.forumng-replies").forEach((reply=>{this.getReplyIndent(reply)==stopIndent?reply.classList.add("forumng-stop-indent"):reply.classList.remove("forumng-stop-indent")}))}getReplyIndent(reply){if(reply.forumng_indent)return reply.forumng_indent;let indent=1,ancestor=reply.parentElement;for(;ancestor&&ancestor!==document.documentElement;)ancestor.classList.contains("forumng-replies")?(indent+=1,ancestor=ancestor.parentElement):ancestor=ancestor.parentElement;return reply.forumng_indent=indent,indent}areLinksDisabled(link){return document.body.linksdisabled||link.closest(".forumng-commands").linksdisabled}deepCloneChangeItemid(obj,itemid){if(Array.isArray(obj))var c=[];else c={};for(let key in obj)Object.prototype.hasOwnProperty.call(obj,key)&&("itemid"==key?c[key]=itemid:"object"==typeof obj[key]&&null!==obj[key]?c[key]=this.deepCloneChangeItemid(obj[key],itemid):c[key]=obj[key]);return c}setTimeoutMulti(fn,count){count>0?setTimeout((()=>{this.setTimeoutMulti(fn,count-1)}),0):fn()}initParentLink(link){link.addEventListener("focus",(()=>{link.parentNode.style.position="static"})),link.addEventListener("blur",(()=>{link.parentNode.style.position="absolute"}))}initExpand(link,postid,expandNow){for(link.post=link.closest(".forumng-post"),link.post.expandLink=link,link.loader=link.nextElementSibling;link.loader&&"img"!==link.loader.nodeName.toLowerCase();)link.loader=link.loader.nextElementSibling;link.loader&&(link.loader.originalSrc=link.loader.src),link.postid=postid,link.delay=!0,this.processLinkRetrieveMessage(link),expandNow&&(link.delay=!1,Common.simulateClick(link))}processLinkRetrieveMessage(link){let expandNow=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const postNum=link.post.className.replace(/^.*forumng-p([0-9]+).*$/,"$1"),text=expandNow?link.querySelector(".forumng-expandtext"):link.querySelector(".forumng-collapsetext");text&&expandNow&&(text.innerHTML=this.stringList.expand.replace("#",postNum)),text&&!expandNow&&(text.innerHTML=this.stringList.collapse.replace("#",postNum));const linkImg=link.querySelector("img.fng-eai");linkImg&&(linkImg.alt="".concat(linkImg.alt," ").concat(postNum)),link.addEventListener("click",(e=>{if(e.preventDefault(),link.inProcess)return;link.post.focushandler=null;const data="p=".concat(link.postid).concat(this.cloneParam,"&short=").concat(expandNow?"true":"false"),url="".concat(_config.default.wwwroot,"/mod/forumng/expandpost.php");fetch(url+"?"+data,{method:"GET",headers:{"Content-Type":"application/json"}}).then((response=>response.text())).then((text=>{this.expandOk(link,{responseText:text})})).catch((()=>{this.expandError(link)})),link.loader&&(link.loader.src=this.loaderPix),link.inProcess=!0}))}initCollapse(link,postid){for(link.post=link.closest(".forumng-post"),link.loader=link.nextElementSibling;link.loader&&"img"!==link.loader.nodeName.toLowerCase();)link.loader=link.loader.nextElementSibling;link.loader&&(link.loader.originalsrc=link.loader.src),link.postid=postid,link.delay=!0,this.processLinkRetrieveMessage(link,!1)}extractJs(text,scriptCommands){const scriptRegexp=/<script[^>]*>([\s\S]*?)<\/script>/g;let result;for(;null!==(result=scriptRegexp.exec(text));)scriptCommands.push(result[1]);return text.replace(scriptRegexp,"")}expandOk(link,o){const newDiv=document.createElement("div"),scriptCommands=[];newDiv.innerHTML=this.extractJs(o.responseText,scriptCommands);let newpost=newDiv.firstChild;newDiv.removeChild(newpost);const focushandler=link.post.focushandler;let previousSelect=!1;this.select.on&&(previousSelect=document.querySelector("#checkp".concat(link.postid)).checked);const expander=new _expander.Expander(link.post),linkPostParent=link.post.parentNode;if(linkPostParent&&linkPostParent.insertBefore(newpost,link.post),link.post.remove(),scriptCommands.forEach((cmd=>eval(cmd))),this.initContent(newpost),previousSelect){const checkbox=document.querySelector("#checkp".concat(link.postid));checkbox.checked=!0}document.body.linksdisabled&&(Common.linksDisable(newpost),newpost.linksdisabled=!1);const tracker=document.querySelector("#expanded_posts");if(tracker.value="".concat(tracker.value).concat(""==tracker.value?"":",").concat(link.postid),newpost.querySelector(".forumng-ratings-standard")&&(Rating.initRating(link.postid),Rating.initPopup(link.postid)),link.delay)if(expander.go(newpost),focushandler)focushandler();else{const authorSpan=newpost.querySelectorAll("span.forumng-author");if(authorSpan.length>0)setTimeout((()=>{authorSpan[0].firstChild.focus()}),0);else{const links=newpost.querySelectorAll("a[href]");links.length>0&&links[0].focus()}}}expandError(link){link.inProcess=!1,link.loader.src=link.loader.originalsrc,alert(this.stringList.jserr_load)}initJumpLink(link){link.addEventListener("mousedown",(()=>{this.mouseUser=!0})),link.addEventListener("click",(e=>{e.preventDefault();const id=link.getAttribute("href").split("#")[1],focuser=()=>{const targetPost=document.querySelector("#".concat(id)).parentNode,jumpTo=targetPost.querySelector(".forumng-jumpto");if(this.mouseUser&&jumpTo){const equivalent=jumpTo.querySelector("a.".concat(link.className));if(equivalent)this.focus(equivalent);else{const prev=jumpTo.querySelector("a.forumng-prev"),next=jumpTo.querySelector("a.forumng-next");prev||next?this.focus(prev||next):this.focus(jumpTo.querySelector("a"))}}else{const author=targetPost.querySelector(".forumng-author");this.focus(author.querySelector("a"))}},targetPost2=document.querySelector("#".concat(id)).parentNode;targetPost2.expandLink&&(Common.simulateClick(targetPost2.expandLink),targetPost2.focushandler=focuser);document.querySelector("#".concat(id)).parentNode.focushandler||focuser(),Common.scrollPage(targetPost2)}))}focus(x){setTimeout((()=>{x.focus()}),0)}initDelete(link,postId,undelete,currentUser){link.postId=postId,link.post=link.closest(".forumng-post"),link.addEventListener("click",(e=>{if(e.preventDefault(),this.areLinksDisabled(link))return;const url="".concat(_config.default.wwwroot,"/mod/forumng/deletepost.php"),data="p=".concat(link.postId).concat(this.cloneParam,"&delete=").concat(undelete?0:1,"&ajax=1"),deleteOnly=()=>{fetch(url+"?"+data,{method:"POST",headers:{"Content-Type":"application/json"}}).then((response=>response.text())).then((text=>{this.deleteOk(link,{responseText:text})})).catch((()=>{this.deleteError(link)})),Common.linksDisable(link.post),link.loader=document.createElement("img"),link.loader.alt="",link.loader.src=this.loaderPix,link.loader.style.position="absolute",link.parentNode.appendChild(link.loader);const linkRegion=Common.getElementScreenPosition(link);link.loader.style.left="".concat(linkRegion.right+3,"px"),link.loader.style.top="".concat(linkRegion.top,"px")},deleteButtons=currentUser?[this.stringList.deletepostbutton]:[this.stringList.deleteemailpostbutton,this.stringList.deletepostbutton],deleteOptions=currentUser?[deleteOnly,""]:[()=>{window.location=url+"?p=".concat(link.postId).concat(this.cloneParam,"&delete=1&ajax=1&email=1")},deleteOnly,""];this.confirm(undelete?this.stringList.confirmundelete:this.stringList.confirmdelete,undelete?this.stringList.undeletepostbutton:deleteButtons,this.stringList.cancel,link.post,undelete?deleteOnly:deleteOptions)}))}deleteOk(link,response){const newDiv=document.createElement("div");newDiv.innerHTML=response.responseText;let newPost=newDiv.firstChild;newPost&&link.post.parentNode.insertBefore(newPost,link.post),Common.linksEnable(link.post),link.post.remove(),newPost&&this.initContent(newPost)}deleteError(link){link.loader&&link.loader.remove(),Common.linksEnable(link.post),alert(this.stringList.jserr_alter)}confirm(message,actionText,cancelText,highlight,action){"string"==typeof actionText&&(actionText=[actionText],action=[action]);const fadePanel=document.createElement("div");fadePanel.classList.add("forumng-fadepanel"),document.body.appendChild(fadePanel),fadePanel.style.position="absolute",fadePanel.style.top="0",fadePanel.style.left="0",fadePanel.style.width=Common.getDocWidth()+"px",fadePanel.style.height=Common.getDocHeight()+"px",fadePanel.style.zIndex=10,fadePanel.style.opacity=0,this.animateOpacity(fadePanel,0,.5,250,this.linearEasing);let highlightDiv=null;if(highlight){const highlightRegion=Common.getElementScreenPosition(highlight);highlightDiv=document.createElement("div"),highlightDiv.classList.add("forumng-highlightbox"),document.body.appendChild(highlightDiv),highlightDiv.style.position="absolute",highlightDiv.style.top=highlightRegion.top+"px",highlightDiv.style.left=highlightRegion.left+"px",highlightDiv.style.zIndex=15;const height=highlightRegion.bottom-highlightRegion.top-Common.removePX(window.getComputedStyle(highlightDiv).borderTopWidth)-Common.removePX(window.getComputedStyle(highlightDiv).borderBottomWidth)-Common.removePX(window.getComputedStyle(highlightDiv).paddingTop)-Common.removePX(window.getComputedStyle(highlightDiv).paddingBottom),width=highlightRegion.right-highlightRegion.left-Common.removePX(window.getComputedStyle(highlightDiv).borderLeftWidth)-Common.removePX(window.getComputedStyle(highlightDiv).borderRightWidth)-Common.removePX(window.getComputedStyle(highlightDiv).paddingLeft)-Common.removePX(window.getComputedStyle(highlightDiv).paddingRight);highlightDiv.style.height=height+"px",highlightDiv.style.width=width+"px"}const dialog=document.createElement("div");dialog.classList.add("forumng-confirmdialog"),document.body.appendChild(dialog),dialog.style.position="absolute",dialog.style.zIndex=20;const region=Common.getViewportRegion();region.height=region.bottom-region.top,region.width=region.right-region.left,dialog.style.top=region.top+region.height/3+"px";const page=Common.getElementScreenPosition(document.getElementById("page")),pixelsWidth=page.right-page.left;let leftAdjuster=0,requiredBoxWidth=630;pixelsWidth<700&&(requiredBoxWidth=pixelsWidth-40,leftAdjuster=5),dialog.style.width=requiredBoxWidth-10+"px";let leftValue=region.left+region.width/2-requiredBoxWidth/2-leftAdjuster;leftValue=Math.max(leftValue,0),dialog.style.left=leftValue+"px";const messageDiv=document.createElement("div");messageDiv.classList.add("forumng-message"),messageDiv.tabIndex=-1,messageDiv.innerHTML=message,dialog.appendChild(messageDiv);const buttonDiv=document.createElement("div");buttonDiv.className="forumng-buttons",dialog.appendChild(buttonDiv);const cancel=document.createElement("input");cancel.type="button",cancel.value=cancelText,cancel.addEventListener("click",(()=>{dialog.remove(),fadePanel.remove(),highlightDiv&&highlightDiv.remove()}));for(var i=0;i<actionText.length;i++)buttonDiv.appendChild(this.confirmMakeButton(actionText[i],action[i],cancel,!1));this.focus(messageDiv),buttonDiv.appendChild(cancel)}confirmMakeButton(actionText,action,cancel,focus){const yes=document.createElement("input");return yes.type="button",yes.value=actionText,yes.addEventListener("click",(()=>{Common.simulateClick(cancel),action()})),focus&&yes.focus(),yes}log(thing){"undefined"!=typeof console&&window.console.debug(thing)}initView(){this.focusSortLinks(),document.querySelectorAll(".forumng-main a").forEach((link=>{const match=link.className.match(/^forumng-draftreply-([0-9]+)-([0-9]+)$/);if(match){const linkMatch=link.href.match(/draft=([0-9]+)(&clone=[0-9]+)?$/);linkMatch&&(link.href="discuss.php?d=".concat(match[1]).concat(this.cloneParam,"&draft=").concat(linkMatch[1],"#p").concat(match[2]))}})),this.initFlags(document.body),document.querySelectorAll("input.forumng-button-to-link").forEach((button=>{this.turnButtonIntoLink(button)})),this.initFeatureButtons(!0)}focusSortLinks(){const url=window.location.href,searchIndex=url.search(/&sortlink=/);if(-1!==searchIndex){const sortLinkId="sortlink_"+url.substr(searchIndex+10,1);this.focus(document.querySelector("#"+sortLinkId))}}turnButtonIntoLink(button){const span=document.createElement("span");span.appendChild(document.createTextNode("("));const link=document.createElement("a");link.appendChild(document.createTextNode(button.value)),link.href="#",link.addEventListener("click",(e=>{e.preventDefault(),Common.simulateClick(button)})),span.appendChild(link),span.appendChild(document.createTextNode(") ")),button.parentNode.insertBefore(span,button),button.style.display="none"}selectInit(target){this.select.on=!!target;const posts=document.querySelectorAll("div.forumng-post"),confirm=document.createElement("input");confirm.setAttribute("type","submit");const extraneousDisplay=this.select.on?"none":"block";document.querySelector("#forumng-expandall").style.display=extraneousDisplay,document.querySelector("#forumng-features").style.display=extraneousDisplay;const subscribeOptions=document.querySelector("#forumng-subscribe-options");subscribeOptions&&(subscribeOptions.style.display=extraneousDisplay);const main=document.querySelector("#forumng-main"),all=document.createElement("input"),none=document.createElement("input");if(this.select.on){const form=document.createElement("form");this.select.form=form,form.setAttribute("method","post"),form.setAttribute("action",target.form.action),main.classList.add("forumng-selectmode"),form.inputs=document.createElement("div"),form.appendChild(form.inputs);let field=document.createElement("input");field.setAttribute("type","hidden"),field.setAttribute("name","d"),field.setAttribute("value",this.discussionID),form.inputs.appendChild(field),field=document.createElement("input"),field.setAttribute("type","hidden"),field.setAttribute("name","fromselect"),field.setAttribute("value","1"),form.inputs.appendChild(field),this.cloneID&&(field=document.createElement("input"),field.setAttribute("type","hidden"),field.setAttribute("name","clone"),field.setAttribute("value",this.cloneID),form.inputs.appendChild(field)),form.intro=document.createElement("div"),form.intro.classList.add("forumng-selectintro"),main.parentNode.insertBefore(form.intro,main);const introText=document.createElement("p");introText.innerHTML=this.stringList.selectintro,form.intro.appendChild(introText);const selectButtons=document.createElement("div");selectButtons.classList.add("forumng-selectbuttons"),form.intro.appendChild(selectButtons),all.setAttribute("type","button"),all.setAttribute("value",this.stringList.selectall),selectButtons.appendChild(all),all.addEventListener("click",(()=>{document.querySelectorAll("div.forumng-post").forEach((post=>{post.check.checked||Common.simulateClick(post.check)})),all.disabled=!0,none.disabled=!1})),selectButtons.appendChild(document.createTextNode(" ")),none.setAttribute("type","button"),none.setAttribute("value",this.stringList.deselectall),selectButtons.appendChild(none),none.addEventListener("click",(()=>{document.querySelectorAll("div.forumng-post").forEach((post=>{post.check.checked&&Common.simulateClick(post.check)})),all.disabled=!1,none.disabled=!0})),main.appendChild(form),form.outro=document.createElement("div"),form.outro.classList.add("forumng-selectoutro"),form.appendChild(form.outro),confirm.setAttribute("value",this.stringList.confirmselection),form.outro.appendChild(confirm),form.outro.appendChild(document.createTextNode(" "));const cancel=document.createElement("input");cancel.setAttribute("type","button"),cancel.setAttribute("id","forumng-cancel-select"),cancel.setAttribute("value",this.stringList.cancel),form.outro.appendChild(cancel),cancel.addEventListener("click",(()=>{this.selectInit(null)})),Common.scrollPage(form.intro,null)}else{const form=this.select.form;form.remove(),form.intro.remove(),form.outro.remove(),main.classList.remove("forumng-selectmode"),this.select.form=null}window.forumng_select_changed=()=>{const posts=document.querySelectorAll("div.forumng-post");let ok=!1,checkcount=0;posts.forEach((post=>{post.check.checked&&(ok=!0,checkcount++)})),none.disabled=!ok,confirm.disabled=!ok,all.disabled=checkcount==posts.length},posts.forEach((post=>{this.selectInitPost(post,this.select.on)})),this.select.on&&window.forumng_select_changed()}selectInitPost(post,on){if(on){const info=post.querySelector("div.forumng-info");if(!info)return;const span=document.createElement("span"),spanSeparator=document.createElement("span");span.appendChild(spanSeparator),spanSeparator.classList.add("forumng-separator"),spanSeparator.textContent=" â€¢ ",info.appendChild(span),post.extraSpan=span,post.classList.add("forumng-deselected");const postid=post.querySelector(":scope > a").id,check=document.createElement("input");check.setAttribute("type","checkbox"),check.id="check"+postid,post.check=check,span.appendChild(check);const label=document.createElement("label");label.classList.add("accesshide"),label.setAttribute("for",check.id),label.textContent=this.stringList.selectlabel,span.appendChild(label),Common.linksDisable(document.body);let hidden=document.querySelector("input[name='select"+postid+"']");hidden||(hidden=document.createElement("input"),hidden.setAttribute("type","hidden"),hidden.setAttribute("value","0"),hidden.setAttribute("name","select"+postid),this.select.form.appendChild(hidden)),post.forumng_hidden=hidden,check.addEventListener("click",(()=>{check.checked?(post.classList.remove("forumng-deselected"),post.forumng_hidden.value=1):(post.classList.add("forumng-deselected"),post.forumng_hidden.value=0),window.forumng_select_changed()}))}else post.extraSpan&&post.extraSpan.remove(),post.classList.remove("forumng-deselected"),Common.linksEnable(document.body)}zeroDisable(submit){const select=submit.previousElementSibling;if(!select||"select"!==select.nodeName.toLowerCase())return void this.log("Warning: Zero-disable feature incorrectly applied.");const update=()=>{submit.classList.contains("forumng-zero-disable")&&(submit.disabled=0==select.value)};update(),select.addEventListener("change",update)}printPage(){window.print()}initSubscribers(){const buttonsDiv=document.getElementById("forumng-buttons"),selectAll=document.createElement("input");selectAll.type="button",selectAll.value=this.stringList.selectall,buttonsDiv.appendChild(document.createTextNode(" ")),buttonsDiv.appendChild(selectAll);const deselectAll=document.createElement("input");let unsubscribe;deselectAll.type="button",deselectAll.value=this.stringList.deselectall,buttonsDiv.appendChild(document.createTextNode(" ")),buttonsDiv.appendChild(deselectAll);const inputs=document.getElementById("forumng-subscription-list").querySelectorAll("input"),all=[];for(const input of inputs)input.name.startsWith("user")?all.push(input):"unsubscribe"==input.name&&(unsubscribe=input);const update=()=>{let allSelected=!0,noneSelected=!0;for(const item of all)item.checked?noneSelected=!1:allSelected=!1;selectAll.disabled=allSelected,deselectAll.disabled=noneSelected,unsubscribe.disabled=noneSelected};update(),all.forEach((item=>item.addEventListener("click",update))),selectAll.addEventListener("click",(()=>{all.forEach((item=>{item.checked=!0})),update()})),deselectAll.addEventListener("click",(()=>{all.forEach((item=>{item.checked=!1})),update()}))}getValueParameter(parameterName){return new URLSearchParams(window.location.search).get(parameterName)||null}animateOpacity(element,startOpacity,endOpacity,duration,easingFunction){let start=null;const deltaOpacity=endOpacity-startOpacity;requestAnimationFrame((function step(timestamp){start||(start=timestamp);const progress=timestamp-start,easeProgress=easingFunction(progress/duration);element.style.opacity=startOpacity+deltaOpacity*easeProgress,progress<duration?requestAnimationFrame(step):element.style.opacity=endOpacity}))}linearEasing(t){return t}}const init=options=>{new Main(options).initializer()};_exports.init=init}));

//# sourceMappingURL=main.min.js.map