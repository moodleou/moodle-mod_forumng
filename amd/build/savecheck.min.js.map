{"version":3,"file":"savecheck.min.js","sources":["../src/savecheck.js"],"sourcesContent":["/**\n * Javascript module loading in forumng data.\n *\n * @module      mod_forumng/savecheck\n * @copyright   2024 Will Wise\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Modal from 'core/modal';\nimport {getString} from 'core/str';\nimport * as FormChangeChecker from 'core_form/changechecker';\nimport Pending from 'core/pending';\n\n/**\n * Initializes the save check functionality.\n *\n * @param {number} contextid - The context ID.\n */\nexport const init = async (contextid) => {\n    const button = document.getElementById('id_submitbutton');\n    if (button) {\n        button.onclick = async (e) => {\n            e.preventDefault();\n            const pendingPromise = new Pending('mod/forumng:savecheck');\n            try {\n                const response = await fetch(`confirmloggedin.php?sesskey=${M.cfg.sesskey}&contextid=${contextid}`, {\n                    method: 'POST',\n                });\n                const data = await response.text();\n                if (data !== 'ok') {\n                    await savefail('savefailnetwork', data);\n                    pendingPromise.resolve();\n                } else {\n                    pendingPromise.resolve();\n                    FormChangeChecker.disableAllChecks();\n                    e.target.form.requestSubmit(e.target);\n                }\n            } catch (error) {\n                await savefail('savefailnetwork', error);\n                pendingPromise.resolve();\n            }\n        };\n    }\n};\n\n/**\n * Handles save failure scenarios.\n *\n * @param {string} stringname - The name of the string to display.\n * @param {string} info - Additional information about the failure.\n */\nconst savefail = async (stringname, info) => {\n    // Save failed, alert of network or session issue.\n    let content = await getString('savefailtext', 'forumng', await getString(stringname, 'forumng'));\n    content += `[${info}]`;\n    const modal = await Modal.create({\n        title: await getString('savefailtitle', 'forumng'),\n        body: content,\n    });\n    await modal.show();\n    document.getElementById('id_submitbutton').disabled = true;\n    const cancel = document.getElementById('id_cancel');\n    cancel.disabled = true;\n    // Trap cancel and make it a GET - so works with login.\n    cancel.addEventListener('click', () => {\n        const form = document.querySelector('#region-main .mform');\n        const text = document.querySelector('#fitem_id_message');\n        const attach = document.querySelector('#fitem_id_attachments');\n        text.remove();\n        attach.remove();\n        form.setAttribute('method', 'get');\n    });\n};\n"],"names":["_getRequireWildcardCache","e","WeakMap","r","t","_interopRequireDefault","__esModule","default","_modal","FormChangeChecker","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","hasOwnProperty","call","i","set","_interopRequireWildcard","_pending","_exports","init","async","button","document","getElementById","onclick","preventDefault","pendingPromise","Pending","response","fetch","M","cfg","sesskey","contextid","method","data","text","savefail","resolve","disableAllChecks","target","form","requestSubmit","error","stringname","info","content","getString","modal","Modal","create","title","body","show","disabled","cancel","addEventListener","querySelector","attach","remove","setAttribute"],"mappings":"uKAWmC,SAAAA,yBAAAC,GAAA,GAAA,mBAAAC,QAAA,OAAA,KAAA,IAAAC,EAAAD,IAAAA,QAAAE,EAAAF,IAAAA,eAAAF,yBAAA,SAAAC,GAAAA,OAAAA,EAAAG,EAAAD,IAAAF,EAAA,CAAA,SAAAI,uBAAAJ,GAAAA,OAAAA,GAAAA,EAAAK,WAAAL,EAAAM,CAAAA,QAAAN,EAAA;;;;;;;kFAHnCO,OAAAH,uBAAAG,QAEAC,kBACmC,SAAAR,EAAAE,GAAAA,IAAAA,GAAAF,GAAAA,EAAAK,WAAAL,OAAAA,EAAAA,GAAAA,OAAAA,GAAAA,iBAAAA,GAAAA,mBAAAA,EAAAM,MAAAA,CAAAA,QAAAN,GAAAG,IAAAA,EAAAJ,yBAAAG,GAAA,GAAAC,GAAAA,EAAAM,IAAAT,GAAA,OAAAG,EAAAO,IAAAV,GAAA,IAAAW,EAAA,CAAAC,UAAA,MAAAC,EAAAC,OAAAC,gBAAAD,OAAAE,yBAAA,IAAA,IAAAC,KAAAjB,EAAAiB,GAAAA,YAAAA,GAAAC,CAAAA,EAAAA,eAAAC,KAAAnB,EAAAiB,GAAAG,CAAAA,IAAAA,EAAAP,EAAAC,OAAAE,yBAAAhB,EAAAiB,GAAAG,KAAAA,IAAAA,EAAAV,KAAAU,EAAAC,KAAAP,OAAAC,eAAAJ,EAAAM,EAAAG,GAAAT,EAAAM,GAAAjB,EAAAiB,GAAAN,OAAAA,EAAAL,QAAAN,EAAAG,GAAAA,EAAAkB,IAAArB,EAAAW,GAAAA,CAAA,CADnCW,CAAAd,mBACAe,SAAAnB,uBAAAmB,UAgCEC,SAAAC,KAzBkBC,kBAChB,MAAMC,OAASC,SAASC,eAAe,mBACnCF,SACAA,OAAOG,QAAUJ,UACb1B,EAAE+B,iBACF,MAAMC,eAAiB,IAAIC,SAAO3B,QAAC,yBACnC,IACI,MAAM4B,eAAiBC,MAAM,+BAA+BC,EAAEC,IAAIC,qBAAqBC,YAAa,CAChGC,OAAQ,SAENC,WAAaP,SAASQ,OACf,OAATD,YACME,SAAS,kBAAmBF,MAClCT,eAAeY,YAEfZ,eAAeY,UACfpC,kBAAkBqC,mBAClB7C,EAAE8C,OAAOC,KAAKC,cAAchD,EAAE8C,QAErC,CAAC,MAAOG,aACCN,SAAS,kBAAmBM,OAClCjB,eAAeY,SACnB,GAER,EASJ,MAAMD,SAAWjB,MAAOwB,WAAYC,QAEhC,IAAIC,cAAgB,EAAAC,KAASA,WAAC,eAAgB,gBAAiB,EAAAA,KAASA,WAACH,WAAY,YACrFE,SAAW,IAAID,QACf,MAAMG,YAAcC,OAAKjD,QAACkD,OAAO,CAC7BC,YAAa,EAAAJ,KAAAA,WAAU,gBAAiB,WACxCK,KAAMN,gBAEJE,MAAMK,OACZ/B,SAASC,eAAe,mBAAmB+B,UAAW,EACtD,MAAMC,OAASjC,SAASC,eAAe,aACvCgC,OAAOD,UAAW,EAElBC,OAAOC,iBAAiB,SAAS,KAC7B,MAAMf,KAAOnB,SAASmC,cAAc,uBAC9BrB,KAAOd,SAASmC,cAAc,qBAC9BC,OAASpC,SAASmC,cAAc,yBACtCrB,KAAKuB,SACLD,OAAOC,SACPlB,KAAKmB,aAAa,SAAU,MAAM,GACpC,CACJ"}