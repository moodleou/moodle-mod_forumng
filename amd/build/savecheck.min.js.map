{"version":3,"file":"savecheck.min.js","sources":["../src/savecheck.js"],"sourcesContent":["/**\n * Javascript module loading in forumng data.\n *\n * @module      mod_forumng/savecheck\n * @copyright   2024 Will Wise\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Modal from 'core/modal';\nimport {getString} from 'core/str';\nimport * as FormChangeChecker from 'core_form/changechecker';\nimport Pending from 'core/pending';\n\n/**\n * Initializes the save check functionality.\n *\n * @param {number} contextid - The context ID.\n */\nexport const init = async (contextid) => {\n    const button = document.getElementById('id_submitbutton');\n    if (button) {\n        button.onclick = async (e) => {\n            e.preventDefault();\n            const pendingPromise = new Pending('mod/forumng:savecheck');\n            try {\n                const response = await fetch(`confirmloggedin.php?sesskey=${M.cfg.sesskey}&contextid=${contextid}`, {\n                    method: 'POST',\n                });\n                const data = await response.text();\n                if (data !== 'ok') {\n                    await savefail('savefailnetwork', data);\n                    pendingPromise.resolve();\n                } else {\n                    pendingPromise.resolve();\n                    FormChangeChecker.disableAllChecks();\n                    if (e.target.form.requestSubmit) {\n                        e.target.form.requestSubmit(e.target);\n                    } else {\n                        e.target.form.submit();\n                    }\n                }\n            } catch (error) {\n                await savefail('savefailnetwork', error);\n                pendingPromise.resolve();\n            }\n        };\n    }\n};\n\n/**\n * Handles save failure scenarios.\n *\n * @param {string} stringname - The name of the string to display.\n * @param {string} info - Additional information about the failure.\n */\nconst savefail = async (stringname, info) => {\n    // Save failed, alert of network or session issue.\n    let content = await getString('savefailtext', 'forumng', await getString(stringname, 'forumng'));\n    content += `[${info}]`;\n    const modal = await Modal.create({\n        title: await getString('savefailtitle', 'forumng'),\n        body: content,\n    });\n    await modal.show();\n    document.getElementById('id_submitbutton').disabled = true;\n    const cancel = document.getElementById('id_cancel');\n    cancel.disabled = true;\n    // Trap cancel and make it a GET - so works with login.\n    cancel.addEventListener('click', () => {\n        const form = document.querySelector('#region-main .mform');\n        const text = document.querySelector('#fitem_id_message');\n        const attach = document.querySelector('#fitem_id_attachments');\n        text.remove();\n        attach.remove();\n        form.setAttribute('method', 'get');\n    });\n};\n"],"names":["_interopRequireDefault","e","__esModule","default","_modal","FormChangeChecker","t","WeakMap","r","n","o","i","f","__proto__","has","get","set","hasOwnProperty","call","Object","defineProperty","getOwnPropertyDescriptor","_interopRequireWildcard","_pending","_exports","init","async","button","document","getElementById","onclick","preventDefault","pendingPromise","Pending","response","fetch","M","cfg","sesskey","contextid","method","data","text","savefail","resolve","disableAllChecks","target","form","requestSubmit","submit","error","stringname","info","content","getString","modal","Modal","create","title","body","show","disabled","cancel","addEventListener","querySelector","attach","remove","setAttribute"],"mappings":"sKAWmC,SAAAA,uBAAAC,GAAAA,OAAAA,GAAAA,EAAAC,WAAAD,EAAAE,CAAAA,QAAAF,EAAA;;;;;;;kFAHnCG,OAAAJ,uBAAAI,QAEAC,kBACmC,SAAAJ,EAAAK,GAAAC,GAAAA,mBAAAA,QAAAC,IAAAA,EAAAD,IAAAA,QAAAE,MAAAF,QAAA,OAAA,SAAAN,EAAAK,OAAAA,GAAAL,GAAAA,EAAAC,WAAA,OAAAD,EAAAS,IAAAA,EAAAC,EAAAC,EAAAC,CAAAA,eAAAV,QAAAF,GAAA,GAAA,OAAAA,GAAA,iBAAAA,GAAA,mBAAAA,EAAAW,OAAAA,EAAAF,GAAAA,EAAAJ,EAAAG,EAAAD,EAAA,CAAA,GAAAE,EAAAI,IAAAb,GAAA,OAAAS,EAAAK,IAAAd,GAAAS,EAAAM,IAAAf,EAAAW,EAAAN,CAAAA,IAAAA,MAAAA,KAAAL,cAAAK,GAAA,CAAA,EAAAW,eAAAC,KAAAjB,EAAAK,MAAAK,GAAAD,EAAAS,OAAAC,iBAAAD,OAAAE,yBAAApB,EAAAK,MAAAK,EAAAI,KAAAJ,EAAAK,KAAAN,EAAAE,EAAAN,EAAAK,GAAAC,EAAAN,GAAAL,EAAAK,IAAAM,OAAAA,CAAAX,CAAA,CAAAA,EAAAK,EAAA,CADnCgB,CAAAjB,mBACAkB,SAAAvB,uBAAAuB,UAoCEC,SAAAC,KA7BkBC,kBAChB,MAAMC,OAASC,SAASC,eAAe,mBACnCF,SACAA,OAAOG,QAAUJ,UACbzB,EAAE8B,iBACF,MAAMC,eAAiB,IAAIC,SAAO9B,QAAC,yBACnC,IACI,MAAM+B,eAAiBC,MAAM,+BAA+BC,EAAEC,IAAIC,qBAAqBC,YAAa,CAChGC,OAAQ,SAENC,WAAaP,SAASQ,OACf,OAATD,YACME,SAAS,kBAAmBF,MAClCT,eAAeY,YAEfZ,eAAeY,UACfvC,kBAAkBwC,mBACd5C,EAAE6C,OAAOC,KAAKC,cACd/C,EAAE6C,OAAOC,KAAKC,cAAc/C,EAAE6C,QAE9B7C,EAAE6C,OAAOC,KAAKE,SAGzB,CAAC,MAAOC,aACCP,SAAS,kBAAmBO,OAClClB,eAAeY,SACnB,KAWZ,MAAMD,SAAWjB,MAAOyB,WAAYC,QAEhC,IAAIC,cAAgB,EAAAC,KAASA,WAAC,eAAgB,gBAAiB,EAAAA,KAASA,WAACH,WAAY,YACrFE,SAAW,IAAID,QACf,MAAMG,YAAcC,OAAKrD,QAACsD,OAAO,CAC7BC,YAAa,EAAAJ,KAAAA,WAAU,gBAAiB,WACxCK,KAAMN,gBAEJE,MAAMK,OACZhC,SAASC,eAAe,mBAAmBgC,UAAW,EACtD,MAAMC,OAASlC,SAASC,eAAe,aACvCiC,OAAOD,UAAW,EAElBC,OAAOC,iBAAiB,QAAS,KAC7B,MAAMhB,KAAOnB,SAASoC,cAAc,uBAC9BtB,KAAOd,SAASoC,cAAc,qBAC9BC,OAASrC,SAASoC,cAAc,yBACtCtB,KAAKwB,SACLD,OAAOC,SACPnB,KAAKoB,aAAa,SAAU,SAElC"}