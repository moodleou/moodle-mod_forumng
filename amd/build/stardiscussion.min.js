define("mod_forumng/stardiscussion",["exports","mod_forumng/common","core/url","core/config"],(function(_exports,_common,_url,_config){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}
/**
   * JavaScript to handle star discussion.
   *
   * @module mod_forumng/stardiscussion
   * @copyright 2024 The Open University
   * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.StarDiscussion=void 0,_url=_interopRequireDefault(_url),_config=_interopRequireDefault(_config);_exports.StarDiscussion=class{constructor(options){_defineProperty(this,"cloneParam",""),_defineProperty(this,"ratingStars",0),_defineProperty(this,"loaderPix",""),_defineProperty(this,"stringList",{}),_defineProperty(this,"starPix",{}),this.cloneParam=options.cloneParam,this.ratingStars=options.ratingStars,this.loaderPix=options.loaderPix,this.stringList=options.stringList,this.starPix=options.starPix}initRating(div){div.classList.add("forumng-ratings-jsenabled"),div.post=div.closest(".forumng-post"),div.ratingCount=0;const selects=div.querySelectorAll("select");selects.length>0&&(div.selector=selects[0],div.postId=parseInt(div.selector.name.replace(/^rating/,"")),div.userRating=div.selector.value,div.canRate=!0,div.hasUserRating=999!==div.userRating);const strongs=div.querySelectorAll("strong");if(strongs.length>0){const strong=strongs[0];div.publicRatingValue=strong.firstChild.nodeValue,div.publicRating=parseInt(div.publicRatingValue.replace(/\s*\/.*$/,"")),div.postId=parseInt(strong.id.replace(/^rating_for_/,"")),div.hasPublicRating=!0,div.ratingCount=parseInt(strong.parentNode.querySelector("span").firstChild.nodeValue)}if(div.canView=div.classList.contains("forumng-canview"),this.ratingStars){for(const node of div.childNodes)node.remove();div.starSpan=document.createElement("span"),div.appendChild(div.starSpan),div.stars=[];for(let i=0;i<=this.ratingStars;i++){const star=document.createElement("img");star.setAttribute("width","16"),star.setAttribute("height","16"),star.rating=i,star.setAttribute("alt",i.toString()),div.canRate&&this.starInitEvents(div,star),div.starSpan.appendChild(star),div.stars.push(star)}return div.countSpan=document.createElement("span"),div.appendChild(div.countSpan),this.setStars(div),null}return div.selector?div:null}starInitEvents(div,star){star.setAttribute("tabIndex",0),star.clickFunction=()=>{div.newRating=star.rating,div.hasUserRating&&div.userRating==div.newRating&&(div.newRating=999);const url="".concat(_config.default.wwwroot,"/mod/forumng/rate.php"),data="p=".concat(div.postId).concat(this.cloneParam,"&rating=").concat(div.newRating,"&ajax=1");fetch(url+"?"+data,{method:"POST",headers:{"Content-Type":"application/json"}}).then((response=>response.text())).then((text=>{this.starOk(div,{responseText:text})})).catch((()=>{this.deleteError(div)})).finally((()=>{(0,_common.linksDisable)(div.post),star.setAttribute("src",this.loaderPix)}))},star.addEventListener("click",star.clickFunction),star.addEventListener("keypress",(e=>{"Enter"!==e.key&&" "!==e.key||star.clickFunction(e)})),star.addEventListener("focus",(()=>{star.classList.add("forumng-starfocus")})),star.addEventListener("blur",(()=>{star.classList.remove("forumng-starfocus")})),star.addEventListener("mouseover",(()=>{div.hasTempRating=!0,div.tempRating=star.rating,this.setStars(div)})),star.addEventListener("mouseout",(()=>{div.hasTempRating=!1,this.setStars(div)}))}setStars(div){let userPos,publicPos,clearing=!1;div.hasTempRating?div.hasUserRating&&div.tempRating==div.userRating?(clearing=!0,userPos=-1):userPos=div.tempRating:userPos=div.hasUserRating?div.userRating:-1,publicPos=div.hasPublicRating?div.publicRating:-1;for(let i=0;i<div.stars.length;i++){const key=(0==i?"circle-":"star-")+(i==userPos?"y":"n")+"-"+(i<=publicPos?"y":"n");div.stars[i].src=_url.default.imageUrl(this.starPix[key],"forumng")}if(div.ratingCount){const newText=" "+(1==div.ratingCount?this.stringList.js_nratings1:this.stringList.js_nratings.replace(/#/,div.ratingCount));let existing=div.countSpan.firstChild;existing&&existing.nodeValue!==newText&&(existing.remove(),existing=null),existing||div.countSpan.appendChild(document.createTextNode(newText))}let title=clearing?this.stringList.js_clicktoclearrating:1==div.tempRating?this.stringList.js_clicktosetrating1:this.stringList.js_clicktosetrating.replace(/#/,div.tempRating);div.canView&&(div.hasPublicRating?title+=" "+this.stringList.js_publicrating.replace(/#/,div.publicRating):title+=" "+this.stringList.js_nopublicrating),div.canRate&&(div.hasUserRating?title+=" "+this.stringList.js_userrating.replace(/#/,div.userRating):title+=" "+this.stringList.js_nouserrating),title+=" "+this.stringList.js_outof.replace(/#/,this.ratingStars);for(const star of div.stars)star.title=title.trim()}starOk(div,response){(0,_common.linksEnable)(div.post),div.userRating=div.newRating,div.hasUserRating=999!==div.newRating;const ratingMatch=/<strong id="rating_for_[0-9]+">([0-9]+) \//.exec(response.responseText);ratingMatch?(div.publicRating=ratingMatch[1],div.hasPublicRating=!0):(div.hasPublicRating=!1,div.ratingCount=0);const countMatch=/<span class="forumng-count">([0-9]+)<\/span>/.exec(response.responseText);countMatch&&(div.ratingCount=parseInt(countMatch[1])),this.setStars(div)}deleteError(div){div.loader&&div.loader.remove(),(0,_common.linksEnable)(div.post),alert(this.stringList.jserr_alter)}}}));

//# sourceMappingURL=stardiscussion.min.js.map